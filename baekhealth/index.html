<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>For Baek's Health (100ì„¸ ìˆœì• ê±´ê°•)</title>
  
  <!-- Icons and Manifest -->
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.png" type="image/png">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- ê¸°ë³¸ & ë°°ê²½ ìŠ¤íƒ€ì¼ --- */
    html {
        scroll-behavior: smooth;
    }
    body {
      font-family: 'Noto Sans KR', sans-serif;
      color: #4a3f33; /* Deep brown for text */
      background-image: url('https://images.unsplash.com/photo-1505935428862-770b6f24f629?q=80&w=2067&auto=format&fit=crop&ixlib-rb-4.0.3&id=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    /* --- Glassmorphism ì¹´ë“œ ìŠ¤íƒ€ì¼ --- */
    .content-card, .modal-card {
      background: rgba(255, 255, 255, 0.65); /* Semi-transparent white */
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px); /* For Safari */
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
    }
    /* --- ë²„íŠ¼ & ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ --- */
    .btn-primary {
      background: linear-gradient(135deg, #574a3a, #8a7a69);
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px 0 rgba(0, 0, 0, 0.1);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.15);
    }
     .btn-accent {
      background: linear-gradient(135deg, #6d5e4f, #9c8a7a);
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px 0 rgba(0, 0, 0, 0.1);
    }
     .btn-accent:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.15);
    }
    .btn-secondary {
      background-color: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.7);
      color: #4a3f33;
      transition: background-color 0.3s ease;
    }
    .btn-secondary:hover {
      background-color: rgba(255, 255, 255, 0.8);
    }
    .btn-primary:disabled, .btn-accent:disabled {
        background: #a9a29a;
        cursor: not-allowed;
    }
    .input-field, .textarea-field {
      background-color: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.9);
      color: #4a3f33;
      border-radius: 0.75rem;
      padding: 0.75rem;
      transition: all 0.3s ease;
    }
    .input-field:focus, .textarea-field:focus {
      outline: none;
      box-shadow: 0 0 0 2px #8a7a69;
      background-color: rgba(255, 255, 255, 0.9);
    }
    .textarea-field::placeholder {
        text-align: center;
        color: #6e6052;
        font-weight: 400;
        opacity: 0.9;
        font-size: 0.95rem; /* ê¸€ì í¬ê¸° ì•½ê°„ ì¤„ì„ */
        line-height: 1.5; /* ì¤„ ê°„ê²© ì¡°ì • */
    }
    .divider-or {
        display: flex;
        align-items: center;
        text-align: center;
        color: #6e6052;
        margin: 1.25rem 0;
    }
    .divider-or::before, .divider-or::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid rgba(110, 96, 82, 0.3);
    }
    .divider-or:not(:empty)::before { margin-right: .5em; }
    .divider-or:not(:empty)::after { margin-left: .5em; }

    /* --- ë¡œë” ìŠ¤íƒ€ì¼ --- */
    .loader {
      border: 5px solid #f0e9e2;
      border-top: 5px solid #8a7a69;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* --- ìœ í‹¸ë¦¬í‹° --- */
    .hidden { display: none; }
    .recommendation-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-weight: 700;
      font-size: 0.875rem;
      text-align: center;
    }
    .recommendation-good { background-color: #2f855a; color: white; } /* ì¢‹ìŒ */
    .recommendation-caution { background-color: #d69e2e; color: white; } /* ì£¼ì˜ */
    .recommendation-bad { background-color: #c53030; color: white; } /* ë‚˜ì¨ */
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md mx-auto">
    <header class="mb-6">
      <div class="content-card rounded-2xl p-6 text-center">
        <div class="flex items-center justify-center">
          <img src="icon.png" alt="Health Icon" class="h-16 w-16 mr-4 rounded-full shadow-md">
          <h1 class="text-4xl font-bold text-[#4a3f33]">For Baek's Health</h1>
        </div>
        <p class="text-[#6e6052] mt-2 text-lg font-light">ë°±ìˆœì•  100ì‚´ ê±´ê°• í”„ë¡œì íŠ¸</p>
      </div>
    </header>

    <main class="content-card rounded-2xl p-6 space-y-5">
      <!-- ì…ë ¥ ì„¹ì…˜ -->
      <div>
        <label for="food-text" class="block text-sm font-medium text-[#6e6052] mb-1">ìŒì‹ ì´ë¦„ ë˜ëŠ” ì¬ë£Œ</label>
        <div class="flex items-center gap-2">
            <input type="text" id="food-text" class="input-field w-full" placeholder="ì˜ˆ: ë‹­ê°€ìŠ´ì‚´, ë¸Œë¡œì½œë¦¬">
            <button id="refresh-button-icon" class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center hover:bg-black/5 transition" title="ê°•ì œ ìƒˆë¡œê³ ì¹¨">
                <svg class="w-5 h-5 text-[#6e6052]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.695v-2.695A8.25 8.25 0 004.668 7.158l-3.181 3.183" />
                </svg>
            </button>
            <button id="clear-button-icon" class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center hover:bg-black/5 transition" title="í™”ë©´ ì§€ìš°ê¸°">
                <svg class="w-5 h-5 text-[#6e6052]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <label for="food-image-input" class="btn-secondary w-full cursor-pointer text-center font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-2" title="ê°¤ëŸ¬ë¦¬ì—ì„œ ì‚¬ì§„ ì„ íƒ">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
            <span>ì‚¬ì§„ ì—…ë¡œë“œ</span>
        </label>
        <input type="file" id="food-image-input" accept="image/*" class="hidden" multiple>
        <button id="start-camera-button" class="btn-secondary w-full font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-2" title="ì¹´ë©”ë¼ë¡œ ì§ì ‘ ì´¬ì˜">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h1.172a2 2 0 011.414.586l.828.828A2 2 0 008.828 6H12a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /><path d="M15 8a1 1 0 11-2 0 1 1 0 012 0z" /></svg>
            <span>ì¹´ë©”ë¼ ì´¬ì˜</span>
        </button>
      </div>
      <div id="image-preview-container" class="mt-4 flex flex-wrap gap-3 justify-center"></div>

      <div class="divider-or"><span>ê±´ê°• Q&A</span></div>

      <div>
        <textarea id="qna-text" class="textarea-field w-full h-24 resize-none"></textarea>
      </div>

      <div class="space-y-3 pt-4 border-t border-gray-300/70">
        <div class="grid grid-cols-2 gap-4">
            <button id="recommend-diet-button" class="btn-secondary w-full font-medium py-2 px-4 rounded-xl flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                <span>ì¶”ì²œ ì‹ë‹¨</span>
            </button>
             <button id="view-log-button" class="btn-secondary w-full font-medium py-2 px-4 rounded-xl flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" /></svg>
                <span>ì‹ë‹¨ ê¸°ë¡</span>
            </button>
        </div>
        <button id="recommend-weekly-diet-button" class="btn-secondary w-full font-medium py-2 px-4 rounded-xl flex items-center justify-center gap-2">
            âœ¨ ì£¼ê°„ ì‹ë‹¨ ê³„íš âœ¨
        </button>
        <div class="flex gap-2 pt-2 border-t border-gray-300/70">
            <button id="analyze-button" class="btn-primary w-full font-bold py-3 px-4 rounded-xl text-lg flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <span>ê±´ê°• ë‹µë³€í•˜ê¸°</span>
            </button>
            <button id="recipe-button" class="btn-accent flex-shrink-0 font-bold py-3 px-4 rounded-xl text-lg flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h8a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.737 11l-.546 9h7.618l-.546-9M12 11V9m0 0a2 2 0 100-4 2 2 0 000 4z" /></svg>
                <span>ìš”ë¦¬ ë ˆì‹œí”¼</span>
            </button>
        </div>
      </div>

      <!-- ë¡œë”© ë° ê²°ê³¼ ì„¹ì…˜ -->
      <div id="loading-indicator" class="text-center my-6 hidden">
        <div class="loader mx-auto"></div>
        <p class="mt-4 text-[#6e6052]">ê±´ê°•ë°•ì‚¬ê°€ ë¶„ì„ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
      <div id="result-section" class="mt-6 hidden">
          <!-- Q&A ê²°ê³¼ -->
          <div id="result-qna-section" class="hidden p-4 rounded-lg bg-white/50 space-y-4">
              <h2 class="text-xl font-bold text-[#4a3f33] border-b border-gray-400/50 pb-2">ê±´ê°• ë‹µë³€</h2>
              <div id="result-qna-answer" class="text-[#4a3f33] whitespace-pre-wrap space-y-3"></div>
          </div>
          <!-- ì‹ë‹¨ ë¶„ì„ ê²°ê³¼ -->
          <div id="result-food-section" class="hidden space-y-4 p-4 rounded-lg bg-white/50">
            <div>
              <h3 class="font-semibold text-lg text-[#6e6052]">ì¢…í•© ì˜ê²¬</h3>
              <div id="result-opinion" class="text-[#4a3f33] whitespace-pre-wrap space-y-3"></div>
            </div>
            <div>
              <h3 class="font-semibold text-lg text-[#6e6052]">ì˜ˆìƒ ì¹¼ë¡œë¦¬</h3>
              <p id="result-calories" class="text-[#4a3f33]"></p>
            </div>
            <div id="recommendation-section">
              <h3 class="font-semibold text-lg text-[#6e6052]">ì¶”ì²œ</h3>
              <p id="result-recommendation" class="text-[#4a3f33]"></p>
            </div>
          </div>
          <!-- ê±´ê°•ìš”ë¦¬ ì¶”ì²œ ê²°ê³¼ -->
          <div id="result-recipe-section" class="hidden space-y-4 p-4 rounded-lg bg-white/50">
            <h2 id="recipe-name" class="text-2xl font-bold text-[#4a3f33]"></h2>
            <div id="recipe-details" class="space-y-4"></div>
          </div>
          <!-- ê²°ê³¼ ì•¡ì…˜ ë²„íŠ¼ -->
            <div id="result-actions-container" class="hidden mt-4 pt-4 border-t border-gray-400/50 space-y-2">
                <button id="save-log-button" class="btn-primary w-full font-bold py-2 px-4 rounded-xl hidden">ì´ ê²°ê³¼ ê¸°ë¡í•˜ê¸°</button>
                <button id="save-image-button" class="btn-secondary w-full font-bold py-2 px-4 rounded-xl flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    <span>JPGë¡œ ì €ì¥</span>
                </button>
            </div>
      </div>
      <div id="error-section" class="mt-6 hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl" role="alert">
        <strong class="font-bold">ì˜¤ë¥˜: </strong>
        <span id="error-message" class="block sm-inline"></span>
      </div>
    </main>
    
    <footer class="mt-6">
        <div class="content-card rounded-2xl p-4 text-center text-xs text-[#6e6052]">
            <p>ë³¸ ê²°ê³¼ëŠ” AIì— ì˜í•´ ìƒì„±ëœ ì •ë³´ì´ë©°, ì˜í•™ì  ì§„ë‹¨ì„ ëŒ€ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <p>ì •í™•í•œ ê±´ê°• ì •ë³´ëŠ” ì „ë¬¸ì˜ì™€ ìƒë‹´í•˜ì„¸ìš”.</p>
        </div>
    </footer>
  </div>

  <!-- 'ë§¨ ìœ„ë¡œ' ë²„íŠ¼ -->
  <button id="top-button" class="hidden fixed bottom-5 right-5 z-50 btn-primary w-12 h-12 rounded-full flex items-center justify-center shadow-lg">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
  </button>

  <!-- Modals -->
    <div id="camera-view" class="fixed inset-0 bg-black/90 hidden flex-col items-center justify-center p-4 z-50">
        <video id="camera-stream" class="w-full max-w-md h-auto rounded-lg" autoplay playsinline></video>
        <div class="flex items-center space-x-4 mt-4">
            <button id="capture-button" class="btn-primary py-3 px-6 rounded-full text-lg">ì‚¬ì§„ ì¶”ê°€</button>
            <button id="cancel-camera-button" class="text-gray-300 hover:text-white bg-white/20 py-2 px-4 rounded-full">ë‹«ê¸°</button>
        </div>
    </div>
    <div id="diet-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
        <div class="modal-card rounded-2xl p-6 w-full max-w-md relative max-h-[90vh] overflow-y-auto">
             <button id="close-diet-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            <h2 class="text-2xl font-bold text-[#4a3f33] mb-4 border-b border-gray-400/50 pb-2">ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì‹ë‹¨</h2>
            <div id="diet-loading" class="text-center hidden py-8">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-[#6e6052]">ë‹¹ì‹ ì„ ìœ„í•œ ìš”ë¦¬ê°€ì´ë“œë¥¼ ì¶”ì²œì¤‘ì…ë‹ˆë‹¤</p>
            </div>
            <div id="diet-content" class="space-y-4 text-[#4a3f33]"></div>
        </div>
    </div>
    <div id="weekly-diet-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
        <div class="modal-card rounded-2xl p-6 w-full max-w-2xl relative max-h-[90vh] flex flex-col">
             <button id="close-weekly-diet-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            
            <div id="weekly-diet-capture-wrapper">
                <h2 class="text-2xl font-bold text-[#4a3f33] mb-4 border-b border-gray-400/50 pb-2">ì£¼ê°„ ì¶”ì²œ ì‹ë‹¨</h2>
                <div id="weekly-diet-content" class="flex-grow overflow-y-auto text-[#4a3f33]"></div>
            </div>

            <div id="weekly-diet-loading" class="text-center hidden py-8">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-[#6e6052]">ë‹¹ì‹ ì„ ìœ„í•œ ì¼ì£¼ì¼ ì‹ë‹¨ì„ ê³„íšì¤‘ì…ë‹ˆë‹¤...</p>
            </div>

            <div id="weekly-diet-actions" class="hidden mt-4 flex flex-col sm:flex-row gap-2">
                <button id="save-weekly-diet-jpg-button" class="btn-secondary flex-1 font-bold py-2 px-4 rounded-xl flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                    <span>JPGë¡œ ì €ì¥</span>
                </button>
                <button id="create-shopping-list-button" class="btn-accent flex-1 font-bold py-2 px-4 rounded-xl">âœ¨ ì‡¼í•‘ ëª©ë¡ ë§Œë“¤ê¸°</button>
            </div>
        </div>
    </div>
    <div id="log-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
        <div class="modal-card rounded-2xl p-6 w-full max-w-md relative max-h-[90vh] flex flex-col">
             <button id="close-log-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            <h2 class="text-2xl font-bold text-[#4a3f33] mb-4 border-b border-gray-400/50 pb-2">ë‚˜ì˜ ì‹ë‹¨ ê¸°ë¡</h2>
            <div id="log-analysis-loading" class="text-center hidden py-4">
                <div class="loader mx-auto" style="width:30px; height:30px; border-width: 3px;"></div>
                <p class="mt-2 text-sm text-[#6e6052]">ê¸°ë¡ì„ ë¶„ì„ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
            <div id="log-analysis-result" class="hidden mt-4 p-3 rounded-lg bg-blue-100/70 border border-blue-300 text-blue-900 space-y-2"></div>
            <div id="log-list" class="flex-grow overflow-y-auto space-y-3 pr-2 mt-4"></div>
            <button id="analyze-log-button" class="mt-4 btn-accent w-full font-bold py-2 px-4 rounded-xl">âœ¨ ë‚´ ê¸°ë¡ ë¶„ì„í•˜ê¸°</button>
            <button id="clear-log-button" class="mt-2 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition">ì „ì²´ ê¸°ë¡ ì‚­ì œ</button>
        </div>
    </div>
    <div id="shopping-list-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-[51]">
        <div class="modal-card rounded-2xl p-6 w-full max-w-md relative max-h-[90vh] flex flex-col">
            <button id="close-shopping-list-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            <h2 class="text-2xl font-bold text-[#4a3f33] mb-4 border-b border-gray-400/50 pb-2">ì£¼ê°„ ì‡¼í•‘ ëª©ë¡</h2>
            <div id="shopping-list-loading" class="text-center hidden py-8">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-[#6e6052]">ì‡¼í•‘ ëª©ë¡ì„ ìƒì„±ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
            <div id="shopping-list-content" class="flex-grow overflow-y-auto space-y-3 pr-2"></div>
             <button id="save-shopping-list-jpg-button" class="hidden mt-4 btn-primary w-full font-bold py-2 px-4 rounded-xl flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                <span>JPGë¡œ ì €ì¥</span>
            </button>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
        <div class="modal-card rounded-2xl p-6 w-full max-w-sm">
            <h2 id="confirm-title" class="text-xl font-bold text-[#4a3f33] mb-4"></h2>
            <p id="confirm-message" class="text-[#6e6052] mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel-button" class="btn-secondary py-2 px-4 rounded-xl">ì·¨ì†Œ</button>
                <button id="confirm-ok-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl">í™•ì¸</button>
            </div>
        </div>
    </div>
    <div id="food-confirm-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-[51]">
        <div class="modal-card rounded-2xl p-6 w-full max-w-sm">
            <h2 id="food-confirm-title" class="text-xl font-bold text-[#4a3f33] mb-4">ìŒì‹ í™•ì¸</h2>
            <p id="food-confirm-message" class="text-[#6e6052] mb-6"></p>
            <div id="food-confirm-initial-buttons" class="flex justify-end space-x-4">
                <button id="food-confirm-no-button" class="btn-secondary py-2 px-4 rounded-xl">ì•„ë‹ˆìš”</button>
                <button id="food-confirm-yes-button" class="btn-primary py-2 px-4 rounded-xl">ë„¤, ë§ì•„ìš”</button>
            </div>
            <div id="food-confirm-alternatives-section" class="hidden mt-4 space-y-3">
                <p class="text-[#6e6052] font-medium">ì•„ë˜ì—ì„œ ìŒì‹ì„ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                <div id="food-confirm-alternatives-buttons" class="flex flex-wrap gap-2">
                    <!-- Alternative buttons will be injected here -->
                </div>
                <input type="text" id="food-confirm-custom-input" class="input-field w-full" placeholder="ìŒì‹ ì´ë¦„ ì§ì ‘ ì…ë ¥">
                <button id="food-confirm-submit-button" class="btn-primary w-full font-bold py-2 px-4 rounded-xl">ì„ íƒ ì™„ë£Œ ë° ë¶„ì„</button>
            </div>
        </div>
    </div>
  
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const foodTextInput = document.getElementById('food-text');
    const foodImageInput = document.getElementById('food-image-input');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const qnaTextInput = document.getElementById('qna-text');
    const analyzeButton = document.getElementById('analyze-button');
    const recipeButton = document.getElementById('recipe-button');
    const loadingIndicator = document.getElementById('loading-indicator');
    const resultSection = document.getElementById('result-section');
    const resultQnaSection = document.getElementById('result-qna-section');
    const resultQnaAnswer = document.getElementById('result-qna-answer');
    const resultFoodSection = document.getElementById('result-food-section');
    const resultOpinion = document.getElementById('result-opinion');
    const resultCalories = document.getElementById('result-calories');
    const resultRecommendation = document.getElementById('result-recommendation');
    const saveLogButton = document.getElementById('save-log-button');
    const resultRecipeSection = document.getElementById('result-recipe-section');
    const recipeName = document.getElementById('recipe-name');
    const recipeDetails = document.getElementById('recipe-details');
    const errorSection = document.getElementById('error-section');
    const errorMessage = document.getElementById('error-message');
    const startCameraButton = document.getElementById('start-camera-button');
    const recommendDietButton = document.getElementById('recommend-diet-button');
    const viewLogButton = document.getElementById('view-log-button');
    const clearButton = document.getElementById('clear-button-icon');
    const refreshButton = document.getElementById('refresh-button-icon');
    const topButton = document.getElementById('top-button');
    const resultActionsContainer = document.getElementById('result-actions-container');
    const saveImageButton = document.getElementById('save-image-button');
    
    // Modals and their controls
    const cameraView = document.getElementById('camera-view');
    const cameraStream = document.getElementById('camera-stream');
    const captureButton = document.getElementById('capture-button');
    const cancelCameraButton = document.getElementById('cancel-camera-button');
    const dietModal = document.getElementById('diet-modal');
    const closeDietModal = document.getElementById('close-diet-modal');
    const dietLoading = document.getElementById('diet-loading');
    const dietContent = document.getElementById('diet-content');
    const logModal = document.getElementById('log-modal');
    const closeLogModal = document.getElementById('close-log-modal');
    const logList = document.getElementById('log-list');
    const clearLogButton = document.getElementById('clear-log-button');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmCancelButton = document.getElementById('confirm-cancel-button');
    const confirmOkButton = document.getElementById('confirm-ok-button');

    // Weekly Diet Modal Elements
    const recommendWeeklyDietButton = document.getElementById('recommend-weekly-diet-button');
    const weeklyDietModal = document.getElementById('weekly-diet-modal');
    const closeWeeklyDietModal = document.getElementById('close-weekly-diet-modal');
    const weeklyDietLoading = document.getElementById('weekly-diet-loading');
    const weeklyDietContent = document.getElementById('weekly-diet-content');
    const weeklyDietCaptureWrapper = document.getElementById('weekly-diet-capture-wrapper');
    const weeklyDietActions = document.getElementById('weekly-diet-actions');
    const createShoppingListButton = document.getElementById('create-shopping-list-button');
    const saveWeeklyDietJpgButton = document.getElementById('save-weekly-diet-jpg-button');


    // Food Confirmation Modal Elements
    const foodConfirmModal = document.getElementById('food-confirm-modal');
    const foodConfirmMessage = document.getElementById('food-confirm-message');
    const foodConfirmInitialButtons = document.getElementById('food-confirm-initial-buttons');
    const foodConfirmYesButton = document.getElementById('food-confirm-yes-button');
    const foodConfirmNoButton = document.getElementById('food-confirm-no-button');
    const foodConfirmAlternativesSection = document.getElementById('food-confirm-alternatives-section');
    const foodConfirmAlternativesButtons = document.getElementById('food-confirm-alternatives-buttons');
    const foodConfirmCustomInput = document.getElementById('food-confirm-custom-input');
    const foodConfirmSubmitButton = document.getElementById('food-confirm-submit-button');
    
    // New Feature Elements
    const shoppingListModal = document.getElementById('shopping-list-modal');
    const closeShoppingListModal = document.getElementById('close-shopping-list-modal');
    const shoppingListLoading = document.getElementById('shopping-list-loading');
    const shoppingListContent = document.getElementById('shopping-list-content');
    const saveShoppingListJpgButton = document.getElementById('save-shopping-list-jpg-button');
    const analyzeLogButton = document.getElementById('analyze-log-button');
    const logAnalysisResult = document.getElementById('log-analysis-result');
    const logAnalysisLoading = document.getElementById('log-analysis-loading');

    let confirmCallback = null;
    let stream = null;
    let uploadedImages = [];
    let currentAnalysisResult = null;
    let currentResultElement = null;
    let currentWeeklyPlan = null;

    // --- Core Health Profile for Baek Sun-ae ---
    const BAEK_SUN_AE_PROFILE = `
      - **Primary User**: ë°±ìˆœì•  (Baek Sun-ae)
      - **Key Health Concerns**:
        - Significant family history of digestive cancers (pancreas, colon).
        - Diagnosed with a small pancreatic cyst, requiring regular monitoring and a proactive, preventative lifestyle.
        - Sensitive digestive system.
        - Mildly high blood pressure, requiring a low-sodium diet.
      - **Dietary Requirements**: Must be low-sodium, low-spice, easily digestible, and focused on supporting pancreatic and overall digestive health. Avoid known carcinogens and inflammatory foods (e.g., processed meats, high sugar, excessive red meat, alcohol, greasy/fried foods).
      - **Communication Rule (VERY IMPORTANT)**: NEVER explicitly mention her family history, cancer, or the pancreatic cyst in your responses. This is to avoid causing stress. Frame all advice positively around "long-term digestive wellness," "supporting healthy pancreas function," and "maintaining a balanced system."
    `;


    function show(el, displayMode = 'flex') { if(el) { el.classList.remove('hidden'); el.style.display = displayMode; } }
    function hide(el) { if(el) { el.classList.add('hidden'); el.style.display = 'none'; } }
    
    function setRandomGreeting() {
        const greetings = [
            "ì˜¤ëŠ˜ë„ ê±´ê°•í•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”! ë‹¹ì‹ ì˜ ë„ì „ì„ ì‘ì›í•©ë‹ˆë‹¤.",
            "ì‘ì€ ìŠµê´€ì´ 100ì„¸ ê±´ê°•ì„ ë§Œë“­ë‹ˆë‹¤. ì˜¤ëŠ˜ë„ í™”ì´íŒ…!",
            "ê±´ê°•ì„ í–¥í•œ ë‹¹ì‹ ì˜ ëª¨ë“  ë°œê±¸ìŒì´ ë¹›ë‚˜ê³  ìˆì–´ìš”.",
            "ìµœê³ ì˜ ì»¨ë””ì…˜ìœ¼ë¡œ ë¹›ë‚˜ëŠ” í•˜ë£¨ ë˜ì„¸ìš”!",
            "ë‹¹ì‹ ì˜ ê±´ê°•í•œ ë¯¸ë˜, ë°”ë¡œ ì˜¤ëŠ˜ë¶€í„° ì‹œì‘ë©ë‹ˆë‹¤!",
            "ì„¸ìƒì—ì„œ ê°€ì¥ ì†Œì¤‘í•œ ë‹¹ì‹ , ì˜¤ëŠ˜ë„ ê±´ê°•í•˜ê²Œ ì§€ë‚´ì„¸ìš”."
        ];
        const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
        qnaTextInput.placeholder = `ë°±ìˆœì• ë‹˜!\n${randomGreeting}`;
    }
    setRandomGreeting();


    function setButtonsState(isLoading) {
        analyzeButton.disabled = isLoading;
        recipeButton.disabled = isLoading;
        const spinIcon = analyzeButton.querySelector('svg');
        if (isLoading) {
            spinIcon.classList.add('animate-spin');
        } else {
            spinIcon.classList.remove('animate-spin');
        }
    }

    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
        });
    }

    async function handleFiles(files) {
        if (!files || files.length === 0) return;
        qnaTextInput.value = '';
        foodTextInput.value = '';
        const fileReadPromises = Array.from(files)
            .filter(file => file.type.startsWith('image/'))
            .map(readFileAsDataURL);
        try {
            const dataURLs = await Promise.all(fileReadPromises);
            dataURLs.forEach(url => {
                 const parsed = url.match(/^data:(.*?);base64,(.*)$/);
                 if (parsed) {
                    uploadedImages.push({ mime: parsed[1], data: parsed[2] });
                 }
            });
        } catch (error) {
            console.error("Error reading one or more files:", error);
            displayError("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
             renderImagePreviews();
        }
    }


    function renderImagePreviews() {
        imagePreviewContainer.innerHTML = '';
        uploadedImages.forEach((item, index) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'relative w-20 h-20';
            const img = document.createElement('img');
            img.src = `data:${item.mime};base64,${item.data}`;
            img.className = 'w-full h-full object-cover rounded-md shadow-md';
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold leading-none';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                uploadedImages.splice(index, 1);
                renderImagePreviews();
            };
            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            imagePreviewContainer.appendChild(wrapper);
        });
    }

    qnaTextInput.addEventListener('input', () => {
      if (qnaTextInput.value) {
        foodTextInput.value = '';
        uploadedImages = [];
        renderImagePreviews();
      }
    });
    foodTextInput.addEventListener('input', () => {
      if (foodTextInput.value) {
        qnaTextInput.value = '';
        uploadedImages = [];
        renderImagePreviews();
      }
    });
    foodImageInput.addEventListener('change', (event) => {
        handleFiles(event.target.files);
    });

    analyzeButton.addEventListener('click', () => {
      const foodText = foodTextInput.value.trim();
      const qnaText = qnaTextInput.value.trim();
      if (qnaText) {
          handleQnAAnalysis(qnaText);
      } else if (uploadedImages.length > 0) {
          handleImageAnalysis();
      } else if (foodText) {
          analyzeConfirmedFood(foodText);
      } else {
          displayError("ìŒì‹, ì‚¬ì§„, ë˜ëŠ” ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      }
    });

    async function handleQnAAnalysis(qnaText) {
        hide(resultSection); hide(errorSection); show(loadingIndicator, 'block');
        setButtonsState(true);
        try {
            const systemPrompt = `ë‹¹ì‹ ì€ 'ë°±ìˆœì• ' ë‹˜ì„ ìœ„í•œ AI ê±´ê°• ë¹„ì„œì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ìµœìš°ì„  ëª©í‘œëŠ” ë°±ìˆœì•  ë‹˜ì˜ ê±´ê°•ì„ ì§€í‚¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ì•„ë˜ì˜ í•µì‹¬ ê±´ê°• ì •ë³´ë¥¼ ë°˜ë“œì‹œ ê¸°ì–µí•˜ê³  ëª¨ë“  ë‹µë³€ì— ì ìš©í•´ì£¼ì„¸ìš”.
            
            [ë°±ìˆœì• ë‹˜ í•µì‹¬ ê±´ê°• ì •ë³´]
            ${BAEK_SUN_AE_PROFILE}

            [ë‹µë³€ ê°€ì´ë“œë¼ì¸]
            - ë°±ìˆœì•  ë‹˜ì˜ ê±´ê°• ìƒíƒœë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•˜ì—¬, ë§¤ìš° ì‹ ì¤‘í•˜ê³  ì•ˆì „í•œ ë‹µë³€ë§Œ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.
            - ê¸ì •ì ì´ê³  í¬ë§ì ì¸ ì–´ì¡°ë¥¼ ìœ ì§€í•´ì£¼ì„¸ìš”.
            
            [JSON ì¶œë ¥ í˜•ì‹]
            ì‘ë‹µì€ ë°˜ë“œì‹œ ë‹¤ìŒ í‚¤ë¥¼ ê°€ì§„ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤:
            - "answer": ë‹¤ìŒ 3ê°œì˜ í‚¤ë¥¼ ê°€ì§„ ê°ì²´:
                - "conclusion": (ë¬¸ìì—´) ì§ˆë¬¸ì— ëŒ€í•œ í•µì‹¬ì ì¸ ê²°ë¡ ì„ 2~3ì¤„ë¡œ ìš”ì•½.
                - "details": (ë¬¸ìì—´) ê²°ë¡ ì— ëŒ€í•œ ìƒì„¸í•œ ì´ìœ ë‚˜ ì„¤ëª…ì„ ì œê³µ.
                - "tip": (ë¬¸ìì—´) ì‚¬ìš©ìê°€ ì‹¤ìƒí™œì—ì„œ ì‹¤ì²œí•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ íŒì´ë‚˜ ì£¼ì˜ì‚¬í•­ì„ ì œì•ˆ.
            ì ˆëŒ€ë¡œ ë‹µë³€ì— '**'ì™€ ê°™ì€ ë§ˆí¬ë‹¤ìš´ ë¬¸ìë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`;
            const parts = [{ text: qnaText }];
            const data = await callGeminiAPI(systemPrompt, parts);
            displayResult(data, 'qna');
        } catch (error) {
            console.error("Q&A ë¶„ì„ ì˜¤ë¥˜:", error);
            displayError(error.message || "Q&A ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            hide(loadingIndicator);
            setButtonsState(false);
        }
    }

    async function handleImageAnalysis() {
        hide(resultSection); hide(errorSection); show(loadingIndicator, 'block');
        setButtonsState(true);
        try {
            const systemPrompt = `ë‹¹ì‹ ì€ ìŒì‹ ì¸ì‹ ì „ë¬¸ AIì…ë‹ˆë‹¤. ì œê³µëœ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ ìŒì‹ ì´ë¦„ì„ ë§ì¶°ì£¼ì„¸ìš”.
            - ë§Œì•½ ì–´ë–¤ ìŒì‹ì¸ì§€ 95% ì´ìƒ í™•ì‹ í•œë‹¤ë©´, isConfidentë¥¼ trueë¡œ ì„¤ì •í•˜ê³ , alternativesëŠ” nullë¡œ í•˜ì„¸ìš”.
            - í™•ì‹ ì´ ì—†ë‹¤ë©´, isConfidentë¥¼ falseë¡œ ì„¤ì •í•˜ê³ , ê°€ëŠ¥ì„± ìˆëŠ” ìŒì‹ ì´ë¦„ 2~3ê°œë¥¼ alternatives ë°°ì—´ì— ë‹´ì•„ì£¼ì„¸ìš”.
            ì‘ë‹µì€ ë°˜ë“œì‹œ ë‹¤ìŒ í‚¤ë¥¼ ê°€ì§„ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤:
            - "identifiedFood": (ë¬¸ìì—´) ê°€ì¥ ê°€ëŠ¥ì„± ë†’ì€ ìŒì‹ ì´ë¦„.
            - "alternatives": (ë¬¸ìì—´ ë°°ì—´ ë˜ëŠ” null) ê°€ëŠ¥ì„± ìˆëŠ” ë‹¤ë¥¸ ìŒì‹ ì´ë¦„ ëª©ë¡.
            - "isConfident": (boolean) ë¶„ì„ ê²°ê³¼ì— ëŒ€í•œ í™•ì‹  ì—¬ë¶€.`;
            const parts = [{ text: "ì´ ìŒì‹ë“¤ì˜ ì´ë¦„ì„ ì¢…í•©í•´ì„œ ì•Œë ¤ì£¼ì„¸ìš”." }];
            uploadedImages.forEach(item => parts.push({ inlineData: { mimeType: item.mime, data: item.data }}));
            const data = await callGeminiAPI(systemPrompt, parts);
            if (data.isConfident) {
                analyzeConfirmedFood(data.identifiedFood);
            } else {
                hide(loadingIndicator);
                showFoodConfirmationModal(data);
            }
        } catch (error) {
            console.error("ì´ë¯¸ì§€ ì¸ì‹ ì˜¤ë¥˜:", error);
            displayError(error.message || "ì´ë¯¸ì§€ ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            hide(loadingIndicator);
            setButtonsState(false);
        }
    }

    function showFoodConfirmationModal(identificationData) {
        foodConfirmMessage.textContent = `AIê°€ ë¶„ì„í•œ ê²°ê³¼, ì´ ìŒì‹ì€ '${identificationData.identifiedFood}'(ìœ¼)ë¡œ ë³´ì…ë‹ˆë‹¤. ë§ìœ¼ì‹ ê°€ìš”?`;
        show(foodConfirmInitialButtons);
        hide(foodConfirmAlternativesSection);
        foodConfirmYesButton.onclick = () => {
            hide(foodConfirmModal);
            analyzeConfirmedFood(identificationData.identifiedFood);
        };
        foodConfirmNoButton.onclick = () => {
            hide(foodConfirmInitialButtons);
            show(foodConfirmAlternativesSection, 'block');
            foodConfirmAlternativesButtons.innerHTML = '';
            const allAlternatives = [identificationData.identifiedFood, ...(identificationData.alternatives || [])];
            allAlternatives.forEach(alt => {
                const btn = document.createElement('button');
                btn.className = 'btn-secondary py-1 px-3 rounded-lg text-sm';
                btn.textContent = alt;
                btn.onclick = () => { foodConfirmCustomInput.value = alt; };
                foodConfirmAlternativesButtons.appendChild(btn);
            });
            foodConfirmCustomInput.value = '';
        };
        foodConfirmSubmitButton.onclick = () => {
            const finalFoodName = foodConfirmCustomInput.value.trim();
            if (finalFoodName) {
                hide(foodConfirmModal);
                analyzeConfirmedFood(finalFoodName);
            } else {
                foodConfirmCustomInput.placeholder = "ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!";
                setTimeout(() => { foodConfirmCustomInput.placeholder = "ìŒì‹ ì´ë¦„ ì§ì ‘ ì…ë ¥"; }, 2000);
            }
        };
        show(foodConfirmModal);
    }

    async function analyzeConfirmedFood(foodName) {
        hide(resultSection); hide(errorSection); show(loadingIndicator, 'block');
        setButtonsState(true);
        try {
            const systemPrompt = `ë‹¹ì‹ ì€ 'ë°±ìˆœì• ' ë‹˜ì„ ìœ„í•œ AI ì „ë‹´ ì˜ì–‘ì‚¬ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ìµœìš°ì„  ëª©í‘œëŠ” ë°±ìˆœì•  ë‹˜ì˜ ê±´ê°•ì„ ì§€í‚¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ì•„ë˜ì˜ í•µì‹¬ ê±´ê°• ì •ë³´ë¥¼ ë°˜ë“œì‹œ ê¸°ì–µí•˜ê³  ëª¨ë“  ë¶„ì„ì— ì ìš©í•´ì£¼ì„¸ìš”.

            [ë°±ìˆœì• ë‹˜ í•µì‹¬ ê±´ê°• ì •ë³´]
            ${BAEK_SUN_AE_PROFILE}

            [ë¶„ì„ ê°€ì´ë“œë¼ì¸]
            - ìœ„ ê±´ê°• ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì œê³µëœ ìŒì‹ì´ ë°±ìˆœì•  ë‹˜ì—ê²Œ ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ê·¹ë„ë¡œ ì‹ ì¤‘í•˜ê²Œ ë¶„ì„í•´ì•¼ í•©ë‹ˆë‹¤.
            - íŠ¹íˆ ì·Œì¥ê³¼ ì†Œí™”ê¸° ê±´ê°•ì— ë¶€ë‹´ì„ ì¤„ ìˆ˜ ìˆëŠ” ìš”ì†Œë¥¼ ì¤‘ì ì ìœ¼ë¡œ í‰ê°€í•´ì£¼ì„¸ìš”.
            - ê¸ì •ì ì´ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ í‘œí˜„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.

            [JSON ì¶œë ¥ í˜•ì‹]
            ì‘ë‹µì€ ë°˜ë“œì‹œ ë‹¤ìŒ í‚¤ë¥¼ ê°€ì§„ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤:
            - "opinion": ë‹¤ìŒ 4ê°œì˜ í‚¤ë¥¼ ê°€ì§„ ê°ì²´:
                - "summary": (ë¬¸ìì—´) ìŒì‹ì— ëŒ€í•œ í•µì‹¬ì ì¸ í‰ê°€ë¥¼ 2~3ì¤„ë¡œ ìš”ì•½.
                - "pros": (ë¬¸ìì—´ ë˜ëŠ” null) ê±´ê°•ì— ê¸ì •ì ì¸ ì¸¡ë©´ì´ ìˆë‹¤ë©´ ê°„ëµíˆ ì„œìˆ , ì—†ë‹¤ë©´ null.
                - "cons": (ë¬¸ìì—´) ê±´ê°• ê´€ì ì—ì„œ ì£¼ì˜í•  ì ì´ë‚˜ ê°œì„  ë°©í–¥ì„ ë¶€ë“œëŸ½ê²Œ ì„œìˆ .
                - "tip": (ë¬¸ìì—´ ë˜ëŠ” null) ì´ ìŒì‹ì´ 'ì£¼ì˜' ë˜ëŠ” 'ë‚˜ì¨' ë“±ê¸‰ì¼ ê²½ìš°, ë” ê±´ê°•í•˜ê²Œ ì„­ì·¨í•  ìˆ˜ ìˆëŠ” í˜„ì‹¤ì ì¸ ë°©ë²•(ì˜ˆ: 'ê¸°ë¦„ê¸°ê°€ ë§ì€ ê»ì§ˆ ëŒ€ì‹  ì‚´ì½”ê¸° ìœ„ì£¼ë¡œ ë“œì‹œë©´ ì¢‹ìŠµë‹ˆë‹¤')ì„ ì œì•ˆ. 'ì¢‹ìŒ' ë“±ê¸‰ì´ë©´ null.
            - "calories": (ë¬¸ìì—´) ì˜ˆìƒ ì¹¼ë¡œë¦¬.
            - "recommendation": (ë¬¸ìì—´) "ì¢‹ìŒ", "ì£¼ì˜", "ë‚˜ì¨" ì¤‘ í•˜ë‚˜.
            - "recommendationSummary": (ë¬¸ìì—´) 'recommendation' ë“±ê¸‰ì— ëŒ€í•œ ì´ìœ ë¥¼ 1~3ì¤„ë¡œ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ì„œ ì„¤ëª….
            ì ˆëŒ€ë¡œ ë‹µë³€ì— '**'ì™€ ê°™ì€ ë§ˆí¬ë‹¤ìš´ ë¬¸ìë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`;
            let parts;
            const promptText = `ìŒì‹: ${foodName}. ì´ ìŒì‹ì´ ë°±ìˆœì•  ë‹˜ ê±´ê°•ì— ì–´ë–¤ ì˜í–¥ì„ ì£¼ëŠ”ì§€ ë¶„ì„í•´ì£¼ì„¸ìš”.`;
            if (uploadedImages.length > 0) {
                parts = [{ text: promptText }];
                uploadedImages.forEach(item => parts.push({ inlineData: { mimeType: item.mime, data: item.data } }));
            } else {
                parts = [{ text: promptText }];
            }
            const data = await callGeminiAPI(systemPrompt, parts);
            currentAnalysisResult = { ...data, food: foodName, date: new Date().toISOString() };
            displayResult(data, 'food');
        } catch (error) {
            console.error("ìŒì‹ ë¶„ì„ ì˜¤ë¥˜:", error);
            displayError(error.message || "ìŒì‹ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            hide(loadingIndicator);
            setButtonsState(false);
        }
    }
    
    recipeButton.addEventListener('click', async () => {
        const foodText = foodTextInput.value.trim();
        if (!foodText && uploadedImages.length === 0) {
            displayError("ë ˆì‹œí”¼ë¥¼ ì¶”ì²œë°›ìœ¼ë ¤ë©´ ì¬ë£Œ ì´ë¦„ì´ë‚˜ ì‚¬ì§„ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        hide(resultSection); hide(errorSection); show(loadingIndicator, 'block');
        setButtonsState(true);
        try {
            const systemPrompt = `ë‹¹ì‹ ì€ 'ë°±ìˆœì• ' ë‹˜ì„ ìœ„í•œ AI ê±´ê°• ìš”ë¦¬ì‚¬ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ìµœìš°ì„  ëª©í‘œëŠ” ë°±ìˆœì•  ë‹˜ì˜ ê±´ê°•ì„ ì§€í‚¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ì•„ë˜ì˜ í•µì‹¬ ê±´ê°• ì •ë³´ë¥¼ ë°˜ë“œì‹œ ê¸°ì–µí•˜ê³  ëª¨ë“  ë ˆì‹œí”¼ì— ì ìš©í•´ì£¼ì„¸ìš”.

            [ë°±ìˆœì• ë‹˜ í•µì‹¬ ê±´ê°• ì •ë³´]
            ${BAEK_SUN_AE_PROFILE}

            [ë ˆì‹œí”¼ ê°€ì´ë“œë¼ì¸]
            - ìœ„ ê±´ê°• ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì†Œí™”ê°€ ì˜ ë˜ê³  ì·Œì¥ ê±´ê°•ì— ìœ ìµí•œ ì €ì—¼ì‹/ì €ìê·¹ ë ˆì‹œí”¼ë§Œ ì¶”ì²œí•´ì•¼ í•©ë‹ˆë‹¤.
            - ê¸ì •ì ì´ê³  ë”°ë¼í•˜ê¸° ì‰¬ìš´ ì„¤ëª…ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤.

            [JSON ì¶œë ¥ í˜•ì‹]
            ì‘ë‹µì€ ë°˜ë“œì‹œ ë‹¤ìŒ í‚¤ë¥¼ ê°€ì§„ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤:
            - "recipeName": (ë¬¸ìì—´) ìš”ë¦¬ ì´ë¦„.
            - "chefTip": (ë¬¸ìì—´) ìš”ë¦¬ë¥¼ ë” ê±´ê°•í•˜ê³  ë§›ìˆê²Œ ë§Œë“¤ê¸° ìœ„í•œ ì…°í”„ì˜ íŒ.
            - "ingredients": (ë¬¸ìì—´ ë°°ì—´) í•„ìš”í•œ ì¬ë£Œ ëª©ë¡.
            - "instructions": (ê°ì²´ ë°°ì—´) ë§Œë“œëŠ” ë²•ì„ ë‹¨ê³„ë³„ë¡œ ì„¤ëª…. ê° ê°ì²´ëŠ” ë‹¤ìŒ í‚¤ë¥¼ ê°€ì§‘ë‹ˆë‹¤:
                - "stage": (ë¬¸ìì—´) ìš”ë¦¬ ë‹¨ê³„ì˜ ì¹´í…Œê³ ë¦¬ (ì˜ˆ: "ì¬ë£Œ ì†ì§ˆ", "ì¡°ë¦¬", "ë§ˆë¬´ë¦¬").
                - "description": (ë¬¸ìì—´) í•´ë‹¹ ë‹¨ê³„ì—ì„œ ìˆ˜í–‰í•  êµ¬ì²´ì ì¸ ì‘ì—… ì„¤ëª….
            ì ˆëŒ€ë¡œ ë‹µë³€ì— '**'ì™€ ê°™ì€ ë§ˆí¬ë‹¤ìš´ ë¬¸ìë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`;
            let parts;
            if (uploadedImages.length > 0) {
                parts = [{ text: "ì´ ì‚¬ì§„ ì† ì¬ë£Œë“¤ë¡œ ë°±ìˆœì•  ë‹˜ì„ ìœ„í•œ ê±´ê°• ìš”ë¦¬ ë ˆì‹œí”¼ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”." }];
                uploadedImages.forEach(item => parts.push({ inlineData: { mimeType: item.mime, data: item.data } }));
            } else {
                parts = [{ text: `ì´ ì¬ë£Œë“¤ë¡œ ë°±ìˆœì•  ë‹˜ì„ ìœ„í•œ ê±´ê°• ìš”ë¦¬ ë ˆì‹œí”¼ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”: ${foodText}` }];
            }
            const data = await callGeminiAPI(systemPrompt, parts);
            displayResult(data, 'recipe');
        } catch (error) {
            console.error("ë ˆì‹œí”¼ ìƒì„± ì˜¤ë¥˜:", error);
            displayError(error.message || "ë ˆì‹œí”¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            hide(loadingIndicator);
            setButtonsState(false);
        }
    });

    function displayResult(data, type) {
        hide(resultQnaSection); hide(resultFoodSection); hide(resultRecipeSection);
        hide(resultActionsContainer); hide(saveLogButton);

        if (type === 'qna') {
            currentResultElement = resultQnaSection;
            show(resultQnaSection, 'block');
            resultQnaAnswer.innerHTML = '';
            const answerData = data.answer;

            if (answerData && answerData.conclusion) {
                const conclusionSection = document.createElement('div');
                conclusionSection.innerHTML = `<h4 class="font-bold text-lg text-[#574a3a] mb-1">âœ… í•µì‹¬ ê²°ë¡ </h4><p class="whitespace-pre-wrap">${answerData.conclusion}</p>`;
                resultQnaAnswer.appendChild(conclusionSection);
            }
            if (answerData && answerData.details) {
                const detailsSection = document.createElement('div');
                detailsSection.className = 'mt-4';
                detailsSection.innerHTML = `<h4 class="font-bold text-lg text-gray-700 mb-1">ğŸ”¬ ìƒì„¸ ì„¤ëª…</h4><p class="whitespace-pre-wrap">${answerData.details}</p>`;
                resultQnaAnswer.appendChild(detailsSection);
            }
            if (answerData && answerData.tip) {
                const tipSection = document.createElement('div');
                tipSection.className = 'mt-4 p-3 rounded-lg bg-blue-100/70 border border-blue-300';
                tipSection.innerHTML = `<h4 class="font-bold text-lg text-blue-900 mb-1">ğŸ’¡ ì‹¤ì²œ íŒ</h4><p class="text-blue-900 whitespace-pre-wrap">${answerData.tip}</p>`;
                resultQnaAnswer.appendChild(tipSection);
            }
        } else if (type === 'food') {
            currentResultElement = resultFoodSection;
            show(resultFoodSection, 'block');
            show(saveLogButton, 'block');
            resultOpinion.innerHTML = ''; 

            const opinionData = data.opinion;
            if(opinionData && opinionData.summary) {
                const summarySection = document.createElement('div');
                summarySection.innerHTML = `<h4 class="font-bold text-lg text-[#574a3a] mb-1">âœ… í•µì‹¬ ìš”ì•½</h4><p class="whitespace-pre-wrap">${opinionData.summary}</p>`;
                resultOpinion.appendChild(summarySection);
            }
            const prosConsContainer = document.createElement('div');
            prosConsContainer.className = 'mt-4 grid gap-4';
            let prosConsHTML = '';
            if (opinionData && opinionData.pros) {
                prosConsHTML += `<div><h4 class="font-bold text-lg text-green-700 mb-1">ğŸ‘ ê¸ì •ì  ì¸¡ë©´</h4><p class="whitespace-pre-wrap">${opinionData.pros}</p></div>`;
            }
            if (opinionData && opinionData.cons) {
                prosConsHTML += `<div><h4 class="font-bold text-lg text-red-700 mb-1">ğŸš¨ ë¶€ì •ì  ì¸¡ë©´</h4><p class="whitespace-pre-wrap">${opinionData.cons}</p></div>`;
            }
            if(prosConsHTML) {
                prosConsContainer.innerHTML = prosConsHTML;
                resultOpinion.appendChild(prosConsContainer);
            }
            if (opinionData && opinionData.tip) {
                const tipSection = document.createElement('div');
                tipSection.className = 'mt-4 p-3 rounded-lg bg-yellow-100/70 border border-yellow-400';
                tipSection.innerHTML = `<h4 class="font-bold text-lg text-yellow-900 mb-1">ğŸ’¡ ëŒ€ì²˜ë²• ê°€ì´ë“œ</h4><p class="text-yellow-900 whitespace-pre-wrap">${opinionData.tip}</p>`;
                resultOpinion.appendChild(tipSection);
            }
            resultCalories.textContent = data.calories || "ì •ë³´ ì—†ìŒ";
            
            const recommendationContainer = document.getElementById('recommendation-section');
            recommendationContainer.innerHTML = ''; 
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex items-center gap-2 mb-1';
            const headerText = document.createElement('h3');
            headerText.className = 'font-semibold text-lg text-[#6e6052]';
            headerText.textContent = 'ì¶”ì²œ';
            const recommendation = data.recommendation || "ì •ë³´ ì—†ìŒ";
            const badge = document.createElement('span');
            badge.textContent = recommendation;
            badge.className = 'recommendation-badge';
            if (recommendation === 'ì¢‹ìŒ') badge.classList.add('recommendation-good');
            else if (recommendation === 'ì£¼ì˜') badge.classList.add('recommendation-caution');
            else if (recommendation === 'ë‚˜ì¨') badge.classList.add('recommendation-bad');
            headerDiv.appendChild(headerText);
            headerDiv.appendChild(badge);
            const summaryP = document.createElement('p');
            summaryP.className = 'text-[#4a3f33]';
            summaryP.textContent = data.recommendationSummary || '';
            recommendationContainer.appendChild(headerDiv);
            recommendationContainer.appendChild(summaryP);
            
            saveLogButton.textContent = "ì´ ê²°ê³¼ ê¸°ë¡í•˜ê¸°";
            saveLogButton.disabled = false;
            saveLogButton.className = 'btn-primary w-full font-bold py-2 px-4 rounded-xl';
        } else if (type === 'recipe') {
            currentResultElement = resultRecipeSection;
            show(resultRecipeSection, 'block');
            recipeName.textContent = data.recipeName || "ì´ë¦„ ì—†ëŠ” ë ˆì‹œí”¼";
            recipeDetails.innerHTML = '';

            if (data.chefTip) {
                const tipSection = document.createElement('div');
                tipSection.className = 'mb-4 p-3 rounded-lg bg-blue-100/70 border border-blue-300';
                tipSection.innerHTML = `<h4 class="font-bold text-lg text-blue-900 mb-1">ğŸ‘¨â€ğŸ³ ì…°í”„ì˜ íŒ</h4><p class="text-blue-900 whitespace-pre-wrap">${data.chefTip}</p>`;
                recipeDetails.appendChild(tipSection);
            }
            const ingredientsSection = document.createElement('div');
            let ingredientsHTML = `<h3 class="font-semibold text-lg text-[#6e6052]">ì¬ë£Œ</h3><ul class="list-disc list-inside text-[#4a3f33]">`;
            (data.ingredients || []).forEach(ing => {
                ingredientsHTML += `<li>${ing}</li>`;
            });
            ingredientsHTML += `</ul>`;
            ingredientsSection.innerHTML = ingredientsHTML;
            recipeDetails.appendChild(ingredientsSection);

            const instructionsSection = document.createElement('div');
            instructionsSection.className = 'mt-4';
            let instructionsHTML = `<h3 class="font-semibold text-lg text-[#6e6052] mb-2">ë§Œë“œëŠ” ë²•</h3>
            <div class="overflow-x-auto">
            <table class="w-full text-sm text-left border-collapse">
                <thead class="text-xs text-[#6e6052] uppercase bg-gray-50/50">
                    <tr><th scope="col" class="px-4 py-2 w-12 text-center border">ìˆœì„œ</th><th scope="col" class="px-4 py-2 border">ìš”ë¦¬ ë‹¨ê³„</th><th scope="col" class="px-4 py-2 border">ìš”ë¦¬ë²•</th></tr>
                </thead>
                <tbody>`;
            (data.instructions || []).forEach((step, index) => {
                instructionsHTML += `<tr class="bg-white/50 border-b"><td class="px-4 py-2 font-medium text-center border">${index + 1}</td><td class="px-4 py-2 border">${step.stage || ''}</td><td class="px-4 py-2 border whitespace-pre-wrap">${step.description || ''}</td></tr>`;
            });
            instructionsHTML += `</tbody></table></div>`;
            instructionsSection.innerHTML = instructionsHTML;
            recipeDetails.appendChild(instructionsSection);
        }
      show(resultSection, 'block');
      show(resultActionsContainer, 'block');
      renderImagePreviews();
    }

    async function callGeminiAPI(systemPrompt, parts) {
      const apiKey = "AIzaSyBbEsfDqt5ojPAJoo70Nozro4LacKk__4k";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const maxRetries = 3;
      let delay = 1000;
      for (let i = 0; i < maxRetries; i++) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 40000); // Increased timeout to 40 seconds
        try {
          const payload = { contents: [{ role: "user", parts }], systemInstruction: { parts: [{ text: systemPrompt }] }, generationConfig: { responseMimeType: "application/json" } };
          const res = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal });
          clearTimeout(timeoutId);
          if (res.ok) {
            const result = await res.json();
            if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
              return JSON.parse(result.candidates[0].content.parts[0].text);
            }
            throw new Error("AI ì‘ë‹µ êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤.");
          }
          if (res.status === 503 || res.status === 429) {
            if (i === maxRetries - 1) { throw new Error(`API ìš”ì²­ ì‹¤íŒ¨ (ì¬ì‹œë„ ëª¨ë‘ ì‹¤íŒ¨): ${res.status}`); }
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2;
          } else { const t = await res.text(); throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${res.status} - ${t}`); }
        } catch (error) {
          clearTimeout(timeoutId);
          if (error.name === 'AbortError') {
              console.error(`API request timed out after 40 seconds. Retrying...`);
          }
          if (i === maxRetries - 1) { throw error; }
          await new Promise(resolve => setTimeout(resolve, delay));
          delay *= 2;
        }
      }
      throw new Error("API ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨)");
    }
    
    function clearInputs() {
        foodTextInput.value = ""; qnaTextInput.value = ""; foodImageInput.value = ""; 
        uploadedImages = []; renderImagePreviews();
    }
    function resetApp() {
        clearInputs(); currentAnalysisResult = null;
        hide(resultSection); hide(errorSection); hide(loadingIndicator);
        setRandomGreeting();
    }
    clearButton.addEventListener('click', resetApp);
    refreshButton.addEventListener('click', () => {
        const currentUrl = window.location.href.split('?')[0];
        window.location.href = currentUrl + '?cache_bust=' + new Date().getTime();
    });
    function displayError(msg) { errorMessage.textContent = msg; show(errorSection, 'block'); }
    
    startCameraButton.addEventListener('click', async () => {
        if (location.protocol !== 'https:') { displayError("ì¹´ë©”ë¼ëŠ” HTTPSì—ì„œë§Œ ë™ì‘í•©ë‹ˆë‹¤."); return; }
        if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) { displayError("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          show(cameraView, 'flex'); cameraStream.srcObject = stream;
        } catch (e) { console.error(e); displayError("ì¹´ë©”ë¼ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆê±°ë‚˜ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
    });
    captureButton.addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = cameraStream.videoWidth || 1280;
        canvas.height = cameraStream.videoHeight || 720;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(cameraStream, 0, 0, canvas.width, canvas.height);
        const dataURL = canvas.toDataURL('image/jpeg', 0.85);
        const parsed = dataURL.match(/^data:(.*?);base64,(.*)$/);
        if (parsed) {
            qnaTextInput.value = ''; foodTextInput.value = '';
            uploadedImages.push({ data: parsed[2], mime: parsed[1] }); 
            renderImagePreviews();
        }
        stopCamera();
    });
    cancelCameraButton.addEventListener('click', () => stopCamera());
    function stopCamera() { if (stream) stream.getTracks().forEach(t => t.stop()); hide(cameraView); stream = null; }
    
    saveImageButton.addEventListener('click', () => {
        if (!currentResultElement) return;
        saveImageButton.textContent = 'ì €ì¥ ì¤‘...'; saveImageButton.disabled = true;
        html2canvas(currentResultElement, { useCORS: true, backgroundColor: '#fdfaf6' }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'health_result.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        }).catch(err => {
            console.error("ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜:", err);
            displayError("ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }).finally(() => {
            saveImageButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg><span>JPGë¡œ ì €ì¥</span>`;
            saveImageButton.disabled = false;
        });
    });

    // --- Diet & Log Modal Logic ---
    recommendDietButton.addEventListener('click', async () => {
        show(dietModal, 'flex'); show(dietLoading, 'block'); dietContent.innerHTML = '';
        try {
            const systemPrompt = `ë‹¹ì‹ ì€ 'ë°±ìˆœì• ' ë‹˜ì„ ìœ„í•œ AI ì „ë‹´ ì˜ì–‘ì‚¬ì…ë‹ˆë‹¤. ì•„ë˜ì˜ í•µì‹¬ ê±´ê°• ì •ë³´ë¥¼ ë°˜ë“œì‹œ ê¸°ì–µí•˜ê³  í•˜ë£¨ ì‹ë‹¨ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”.

            [ë°±ìˆœì• ë‹˜ í•µì‹¬ ê±´ê°• ì •ë³´]
            ${BAEK_SUN_AE_PROFILE}
            
            [ì‹ë‹¨ ê°€ì´ë“œë¼ì¸]
            - ìœ„ ê±´ê°• ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì†Œí™”ê°€ í¸í•˜ê³  ì·Œì¥ ê±´ê°•ì— ì¢‹ì€ ì €ì—¼ì‹/ì €ìê·¹ ì‹ë‹¨ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
            
            [JSON ì¶œë ¥ í˜•ì‹]
            ë‹µë³€ì€ 'breakfast', 'lunch', 'dinner', 'snacks' í‚¤ë¥¼ ê°€ì§„ JSON ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤. 
            ì ˆëŒ€ë¡œ ë‹µë³€ì— '**'ì™€ ê°™ì€ ë§ˆí¬ë‹¤ìš´ ë¬¸ìë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`;
            const parts = [{ text: "ë°±ìˆœì•  ë‹˜ì„ ìœ„í•œ ê±´ê°•ì— ì¢‹ì€ í•˜ë£¨ ì¶”ì²œ ì‹ë‹¨ì„ ìƒì„±í•´ì£¼ì„¸ìš”." }];
            const data = await callGeminiAPI(systemPrompt, parts);
            dietContent.innerHTML = `<div class="mb-3"><h3 class="font-semibold text-lg">ì•„ì¹¨</h3><p>${data.breakfast || 'ì •ë³´ ì—†ìŒ'}</p></div><div class="mb-3"><h3 class="font-semibold text-lg">ì ì‹¬</h3><p>${data.lunch || 'ì •ë³´ ì—†ìŒ'}</p></div><div class="mb-3"><h3 class="font-semibold text-lg">ì €ë…</h3><p>${data.dinner || 'ì •ë³´ ì—†ìŒ'}</p></div><div><h3 class="font-semibold text-lg">ê°„ì‹</h3><p>${data.snacks || 'ì •ë³´ ì—†ìŒ'}</p></div>`;
        } catch(error) {
            dietContent.innerHTML = `<p class="text-red-500">ì‹ë‹¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
        } finally { hide(dietLoading); }
    });

    recommendWeeklyDietButton.addEventListener('click', async () => {
        show(weeklyDietModal, 'flex');
        weeklyDietContent.innerHTML = '';
        hide(weeklyDietActions);
        hide(weeklyDietCaptureWrapper);
        show(weeklyDietLoading, 'block');
        try {
             const systemPrompt = `ë‹¹ì‹ ì€ 'ë°±ìˆœì• ' ë‹˜ì„ ìœ„í•œ AI ì „ë‹´ ì˜ì–‘ì‚¬ì…ë‹ˆë‹¤. ì•„ë˜ì˜ í•µì‹¬ ê±´ê°• ì •ë³´ë¥¼ ë°˜ë“œì‹œ ê¸°ì–µí•˜ê³  7ì¼ì¹˜ ì‹ë‹¨ì„ ê³„íší•´ì£¼ì„¸ìš”.

            [ë°±ìˆœì• ë‹˜ í•µì‹¬ ê±´ê°• ì •ë³´]
            ${BAEK_SUN_AE_PROFILE}

            [ì‹ë‹¨ ê°€ì´ë“œë¼ì¸]
            - ìœ„ ê±´ê°• ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì†Œí™”ê°€ ì˜ ë˜ê³  ì·Œì¥ ê±´ê°•ì— ì¢‹ì€ ì €ì—¼ì‹/ì €ìê·¹ ì‹ë‹¨ìœ¼ë¡œ 7ì¼ì¹˜ë¥¼ ê³„íší•´ì•¼ í•©ë‹ˆë‹¤.
            
            [JSON ì¶œë ¥ í˜•ì‹]
            ì‘ë‹µì€ ë°˜ë“œì‹œ 'plan'ì´ë¼ëŠ” í‚¤ë¥¼ ê°€ì§„ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤. 'plan'ì˜ ê°’ì€ 7ê°œì˜ ê°ì²´ ë°°ì—´ì´ë©°, ê° ê°ì²´ëŠ” 'day', 'breakfast', 'lunch', 'dinner' í‚¤ë¥¼ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤.
            ì˜ˆì‹œ: { "plan": [ {"day": "ì›”ìš”ì¼", "breakfast": "ê³„ë€ì°œ", "lunch": "ìƒì„ êµ¬ì´ì™€ ì°ì±„ì†Œ", "dinner": "ë‘ë¶€ ìƒëŸ¬ë“œ"}, ... ] }
            ì ˆëŒ€ë¡œ ë‹µë³€ì— '**'ì™€ ê°™ì€ ë§ˆí¬ë‹¤ìš´ ë¬¸ìë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`;
            const parts = [{ text: "ë°±ìˆœì•  ë‹˜ì„ ìœ„í•œ ì¼ì£¼ì¼ì¹˜ ê±´ê°• ì‹ë‹¨ì„ ì§œì£¼ì„¸ìš”." }];
            const data = await callGeminiAPI(systemPrompt, parts);
            
            let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm text-left border-collapse">
            <thead class="text-xs text-[#6e6052] uppercase bg-gray-50/50">
            <tr>
                <th class="px-4 py-2 border">ìš”ì¼</th><th class="px-4 py-2 border">ì•„ì¹¨</th><th class="px-4 py-2 border">ì ì‹¬</th><th class="px-4 py-2 border">ì €ë…</th>
            </tr>
            </thead><tbody>`;

            data.plan.forEach(dayPlan => {
                tableHTML += `<tr class="bg-white/50 border-b">
                    <td class="px-4 py-2 font-medium border">${dayPlan.day}</td>
                    <td class="px-4 py-2 border">${dayPlan.breakfast}</td>
                    <td class="px-4 py-2 border">${dayPlan.lunch}</td>
                    <td class="px-4 py-2 border">${dayPlan.dinner}</td>
                </tr>`;
            });
            tableHTML += `</tbody></table></div>`;
            weeklyDietContent.innerHTML = tableHTML;
            currentWeeklyPlan = data.plan;
            show(weeklyDietActions, 'flex');
            show(weeklyDietCaptureWrapper, 'block');
        } catch(error) {
            weeklyDietContent.innerHTML = `<p class="text-red-500">ì£¼ê°„ ì‹ë‹¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
            show(weeklyDietCaptureWrapper, 'block');
        } finally { 
            hide(weeklyDietLoading); 
        }
    });

    function displayLogs() {
        const logs = JSON.parse(localStorage.getItem('foodLog')) || [];
        logList.innerHTML = '';
        if (logs.length === 0) {
            logList.innerHTML = `<p class="text-center text-gray-500">ê¸°ë¡ëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            hide(clearLogButton); 
            hide(analyzeLogButton);
            return;
        }
        show(clearLogButton, 'block');
        show(analyzeLogButton, 'block');
        logs.forEach(log => {
            const logDate = new Date(log.date);
            const dateString = `${logDate.getFullYear()}.${logDate.getMonth() + 1}.${logDate.getDate()} ${logDate.getHours()}:${String(logDate.getMinutes()).padStart(2, '0')}`;
            const badge = `<span class="recommendation-badge ${log.recommendation === 'ì¢‹ìŒ' ? 'recommendation-good' : log.recommendation === 'ì£¼ì˜' ? 'recommendation-caution' : 'recommendation-bad'}">${log.recommendation}</span>`;
            const logItem = document.createElement('div');
            logItem.className = 'bg-white/50 p-3 rounded-lg';
            logItem.innerHTML = `<div class="flex justify-between items-center"><p class="font-bold">${log.food}</p>${badge}</div><p class="text-xs text-gray-600 mt-1">${dateString}</p>`;
            logList.appendChild(logItem);
        });
    }

    viewLogButton.addEventListener('click', () => { 
        hide(logAnalysisResult);
        hide(logAnalysisLoading);
        displayLogs(); 
        show(logModal, 'flex'); 
    });
    saveLogButton.addEventListener('click', () => {
        if (currentAnalysisResult) {
            const logs = JSON.parse(localStorage.getItem('foodLog')) || [];
            logs.unshift(currentAnalysisResult);
            localStorage.setItem('foodLog', JSON.stringify(logs));
            saveLogButton.textContent = "ì €ì¥ ì™„ë£Œ!"; saveLogButton.disabled = true;
            saveLogButton.classList.add('opacity-50');
        }
    });
    clearLogButton.addEventListener('click', () => {
        showConfirm("ëª¨ë“  ê¸°ë¡ ì‚­ì œ", "ì •ë§ë¡œ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", () => {
            localStorage.removeItem('foodLog');
            displayLogs();
        });
    });

    // --- New Feature Logic ---
    createShoppingListButton.addEventListener('click', async () => {
        if (!currentWeeklyPlan) {
            displayError("ì£¼ê°„ ì‹ë‹¨ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        show(shoppingListModal, 'flex');
        show(shoppingListLoading, 'block');
        hide(saveShoppingListJpgButton);
        shoppingListContent.innerHTML = '';

        try {
            const systemPrompt = `ë‹¹ì‹ ì€ ì‡¼í•‘ ëª©ë¡ì„ ì •ë¦¬í•˜ëŠ” ìœ ìš©í•œ AI ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ì œê³µëœ ì£¼ê°„ ì‹ë‹¨ ê³„íšì„ ë°”íƒ•ìœ¼ë¡œ í•„ìš”í•œ ëª¨ë“  ì¬ë£Œë¥¼ ì¶”ì¶œí•˜ê³ , 1ì¸ ê¸°ì¤€ ì¼ì£¼ì¼ì¹˜ì— í•„ìš”í•œ ëŒ€ëµì ì¸ ìˆ˜ëŸ‰ì´ë‚˜ ì–‘ì„ ì˜ˆì¸¡í•´ì£¼ì„¸ìš”. ê²°ê³¼ë¥¼ "ì±„ì†Œ ë° ê³¼ì¼", "ìœ¡ë¥˜ ë° í•´ì‚°ë¬¼", "ìœ ì œí’ˆ ë° ê³„ë€", "ê³¡ë¬¼ ë° ë¹µë¥˜", "í†µì¡°ë¦¼ ë° ê°€ê³µì‹í’ˆ", "ì¡°ë¯¸ë£Œ ë° ê¸°íƒ€" ì™€ ê°™ì€ ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ì‡¼í•‘ ëª©ë¡ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”. ê° ì¬ë£ŒëŠ” í•œ ë²ˆë§Œ ëª©ë¡ì— í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì‘ë‹µì€ 'shoppingList'ë¼ëŠ” í‚¤ë¥¼ ê°€ì§„ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤. 'shoppingList'ì˜ ê°’ì€ ê° ê°ì²´ê°€ 'category'ì™€ 'items' í‚¤ë¥¼ ê°–ëŠ” ê°ì²´ ë°°ì—´ì…ë‹ˆë‹¤. 'items' ë°°ì—´ ì•ˆì˜ ê° ê°ì²´ëŠ” 'name'(ì¬ë£Œ ì´ë¦„)ê³¼ 'amount'(ì˜ˆìƒ ìˆ˜ëŸ‰, ì˜ˆ: "1ê°œ", "200g", "1ëª¨") í‚¤ë¥¼ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤.`;
            const planText = currentWeeklyPlan.map(p => `${p.day}: ${p.breakfast}, ${p.lunch}, ${p.dinner}`).join('; ');
            const parts = [{ text: `ë‹¤ìŒ ì‹ë‹¨ ê³„íšìœ¼ë¡œ ì‡¼í•‘ ëª©ë¡ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”: ${planText}` }];
            const data = await callGeminiAPI(systemPrompt, parts);
            
            shoppingListContent.innerHTML = ''; // Clear previous content
            data.shoppingList.forEach(category => {
                const categoryWrapper = document.createElement('div');
                categoryWrapper.className = 'mb-4';

                const categoryTitle = document.createElement('h3');
                categoryTitle.className = 'font-semibold text-lg text-[#574a3a] mb-2';
                categoryTitle.textContent = category.category;
                categoryWrapper.appendChild(categoryTitle);

                const table = document.createElement('table');
                table.className = 'w-full text-sm text-left border-collapse';
                table.innerHTML = `
                    <thead class="text-xs text-[#6e6052] uppercase bg-gray-50/50">
                        <tr>
                            <th scope="col" class="px-4 py-2 border">í’ˆëª©</th>
                            <th scope="col" class="px-4 py-2 border w-24 text-center">ì˜ˆìƒ ìˆ˜ëŸ‰</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;
                const tbody = table.querySelector('tbody');
                category.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white/50 border-b';
                    row.innerHTML = `
                        <td class="px-4 py-2 border">${item.name}</td>
                        <td class="px-4 py-2 border text-center">${item.amount}</td>
                    `;
                    tbody.appendChild(row);
                });
                categoryWrapper.appendChild(table);
                shoppingListContent.appendChild(categoryWrapper);
            });
            
            show(saveShoppingListJpgButton, 'block');

        } catch (error) {
            shoppingListContent.innerHTML = `<p class="text-red-500">ì‡¼í•‘ ëª©ë¡ì„ ë§Œë“œëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
            console.error("Shopping list creation error:", error);
        } finally {
            hide(shoppingListLoading);
        }
    });

    saveShoppingListJpgButton.addEventListener('click', () => {
        if (!shoppingListContent.hasChildNodes()) return;
        
        saveShoppingListJpgButton.textContent = 'ì €ì¥ ì¤‘...';
        saveShoppingListJpgButton.disabled = true;

        html2canvas(shoppingListContent, {
            useCORS: true,
            backgroundColor: '#fdfaf6',
            scale: 2
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'shopping-list.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.click();
        }).catch(err => {
            console.error("ì‡¼í•‘ ëª©ë¡ ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜:", err);
            displayError("ì‡¼í•‘ ëª©ë¡ ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }).finally(() => {
            saveShoppingListJpgButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg><span>JPGë¡œ ì €ì¥</span>`;
            saveShoppingListJpgButton.disabled = false;
        });
    });

    analyzeLogButton.addEventListener('click', async () => {
        const logs = JSON.parse(localStorage.getItem('foodLog')) || [];
        if (logs.length < 3) {
            logAnalysisResult.innerHTML = `<p>ê¸°ë¡ì´ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. 3ê°œ ì´ìƒ ê¸°ë¡ í›„ ë¶„ì„í•´ì£¼ì„¸ìš”.</p>`;
            show(logAnalysisResult, 'block');
            return;
        }
        hide(logAnalysisResult);
        show(logAnalysisLoading, 'block');

        try {
            const systemPrompt = `ë‹¹ì‹ ì€ 'ë°±ìˆœì• ' ë‹˜ì˜ ì‹ë‹¨ ê¸°ë¡ì„ ë¶„ì„í•˜ëŠ” AI ì˜ì–‘ì‚¬ì…ë‹ˆë‹¤. ì•„ë˜ì˜ í•µì‹¬ ê±´ê°• ì •ë³´ë¥¼ ë°˜ë“œì‹œ ê¸°ì–µí•˜ê³  ì‹ë‹¨ ê¸°ë¡ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.

            [ë°±ìˆœì• ë‹˜ í•µì‹¬ ê±´ê°• ì •ë³´]
            ${BAEK_SUN_AE_PROFILE}
            
            [ë¶„ì„ ê°€ì´ë“œë¼ì¸]
            - ìœ„ ê±´ê°• ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ê¸°ë¡ëœ ì‹ë‹¨ì˜ ê¸ì •ì ì¸ íŒ¨í„´ê³¼ ê°œì„ ì ì„ ì°¾ì•„ì£¼ì„¸ìš”.
            - ë¶„ì„ì€ ë§¤ìš° ê¸ì •ì ì´ê³ , ë¶€ë“œëŸ½ê³ , ê²©ë ¤í•˜ëŠ” í†¤ìœ¼ë¡œ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. ì§ˆì±…í•˜ëŠ” ë‚´ìš©ì€ ì ˆëŒ€ë¡œ í¬í•¨í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.
            
            [JSON ì¶œë ¥ í˜•ì‹]
            ì‘ë‹µì€ 'summary' (ì „ë°˜ì ì¸ í•œ ì¤„ ìš”ì•½)ì™€ 'suggestion' (êµ¬ì²´ì ì´ê³  ì‹¤ì²œ ê°€ëŠ¥í•œ ê¸ì •ì  ì œì•ˆ) í‚¤ë¥¼ ê°€ì§„ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`;
            const logText = logs.map(log => `${log.food} (${log.recommendation})`).join(', ');
            const parts = [{ text: `ë‹¤ìŒì€ ë°±ìˆœì•  ë‹˜ì˜ ì‹ë‹¨ ê¸°ë¡ì…ë‹ˆë‹¤. ë¶„ì„í•´ì£¼ì„¸ìš”: ${logText}` }];
            const data = await callGeminiAPI(systemPrompt, parts);

            logAnalysisResult.innerHTML = `
                <p><strong class="font-semibold">ğŸ“ ì¢…í•© ì˜ê²¬:</strong> ${data.summary}</p>
                <p><strong class="font-semibold">ğŸ’¡ ê±´ê°• íŒ:</strong> ${data.suggestion}</p>
            `;
            show(logAnalysisResult, 'block');

        } catch (error) {
            logAnalysisResult.innerHTML = `<p>ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
            show(logAnalysisResult, 'block');
            console.error("Log analysis error:", error);
        } finally {
            hide(logAnalysisLoading);
        }
    });


    // --- Modal Close Listeners ---
    closeDietModal.addEventListener('click', () => hide(dietModal));
    closeWeeklyDietModal.addEventListener('click', () => hide(weeklyDietModal));
    closeLogModal.addEventListener('click', () => hide(logModal));
    closeShoppingListModal.addEventListener('click', () => hide(shoppingListModal));
    
    function showConfirm(title, message, callback) {
        confirmTitle.textContent = title; confirmMessage.textContent = message; confirmCallback = callback; show(confirmModal, 'flex');
    }
    confirmCancelButton.addEventListener('click', () => { hide(confirmModal); confirmCallback = null; });
    confirmOkButton.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hide(confirmModal); confirmCallback = null; });
    
    saveWeeklyDietJpgButton.addEventListener('click', () => {
        const captureTarget = document.getElementById('weekly-diet-capture-wrapper');
        if (!captureTarget || !captureTarget.hasChildNodes()) return;
        
        saveWeeklyDietJpgButton.textContent = 'ì €ì¥ ì¤‘...';
        saveWeeklyDietJpgButton.disabled = true;

        html2canvas(captureTarget, {
            useCORS: true,
            backgroundColor: '#fdfaf6',
            scale: 2 // Higher scale for better quality
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'weekly-diet-plan.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.click();
        }).catch(err => {
            console.error("ì£¼ê°„ ì‹ë‹¨ ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜:", err);
            displayError("ì£¼ê°„ ì‹ë‹¨ ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }).finally(() => {
            saveWeeklyDietJpgButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg><span>JPGë¡œ ì €ì¥</span>`;
            saveWeeklyDietJpgButton.disabled = false;
        });
    });

    window.addEventListener('scroll', () => {
        if (window.scrollY > 200) { topButton.classList.remove('hidden'); } 
        else { topButton.classList.add('hidden'); }
    });
    topButton.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });

  });
  </script>
</body>
</html>

