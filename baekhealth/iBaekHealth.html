<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>For Baek's Health (100ì„¸ ìˆœì• ê±´ê°•)</title>
  
  <!-- Icons and Manifest -->
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://placehold.co/64x64/8a7a69/FFFFFF?text=BH" type="image/png">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- ê¸°ë³¸ & ë°°ê²½ ìŠ¤íƒ€ì¼ --- */
    html {
        scroll-behavior: smooth;
    }
    body {
      font-family: 'Noto Sans KR', sans-serif;
      color: #4a3f33; /* Deep brown for text */
      background-image: url('https://images.unsplash.com/photo-1505935428862-770b6f24f629?q=80&w=2067&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    /* --- Glassmorphism ì¹´ë“œ ìŠ¤íƒ€ì¼ --- */
    .content-card, .modal-card {
      background: rgba(255, 255, 255, 0.65); /* Semi-transparent white */
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px); /* For Safari */
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
    }
    /* --- ë²„íŠ¼ & ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ --- */
    .btn-primary {
      background: linear-gradient(135deg, #574a3a, #8a7a69);
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px 0 rgba(0, 0, 0, 0.1);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.15);
    }
     .btn-accent {
      background: linear-gradient(135deg, #6d5e4f, #9c8a7a);
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px 0 rgba(0, 0, 0, 0.1);
    }
     .btn-accent:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.15);
    }
    .btn-secondary {
      background-color: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.7);
      color: #4a3f33;
      transition: background-color 0.3s ease;
    }
    .btn-secondary:hover {
      background-color: rgba(255, 255, 255, 0.8);
    }
    .btn-primary:disabled, .btn-accent:disabled {
        background: #a9a29a;
        cursor: not-allowed;
    }
    .input-field, .textarea-field {
      background-color: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.9);
      color: #4a3f33;
      border-radius: 0.75rem;
      padding: 0.75rem;
      transition: all 0.3s ease;
    }
    .input-field:focus, .textarea-field:focus {
      outline: none;
      box-shadow: 0 0 0 2px #8a7a69;
      background-color: rgba(255, 255, 255, 0.9);
    }
    .textarea-field::placeholder {
        text-align: center;
        color: #6e6052;
        font-weight: 400;
        opacity: 0.9;
        font-size: 0.95rem; /* ê¸€ì í¬ê¸° ì•½ê°„ ì¤„ì„ */
        line-height: 1.5; /* ì¤„ ê°„ê²© ì¡°ì • */
    }
    .divider-or {
        display: flex;
        align-items: center;
        text-align: center;
        color: #6e6052;
        margin: 1.25rem 0;
    }
    .divider-or::before, .divider-or::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid rgba(110, 96, 82, 0.3);
    }
    .divider-or:not(:empty)::before { margin-right: .5em; }
    .divider-or:not(:empty)::after { margin-left: .5em; }

    /* --- ë¡œë” ìŠ¤íƒ€ì¼ --- */
    .loader {
      border: 5px solid #f0e9e2;
      border-top: 5px solid #8a7a69;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* --- ìœ í‹¸ë¦¬í‹° --- */
    .hidden { display: none; }
    .recommendation-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-weight: 700;
      font-size: 0.875rem;
      text-align: center;
    }
    .recommendation-good { background-color: #2f855a; color: white; } /* ì¢‹ìŒ */
    .recommendation-caution { background-color: #d69e2e; color: white; } /* ì£¼ì˜ */
    .recommendation-bad { background-color: #c53030; color: white; } /* ë‚˜ì¨ */
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md mx-auto">
    <header class="mb-6">
      <div class="content-card rounded-2xl p-6 text-center">
        <div class="flex items-center justify-center">
          <img src="https://placehold.co/64x64/8a7a69/FFFFFF?text=BH" alt="Health Icon" class="h-16 w-16 mr-4 rounded-full shadow-md">
          <h1 class="text-4xl font-bold text-[#4a3f33]">For Baek's Health</h1>
        </div>
        <p class="text-[#6e6052] mt-2 text-lg font-light">ë°±ìˆœì•  100ì‚´ ê±´ê°• í”„ë¡œì íŠ¸</p>
      </div>
    </header>

    <main class="content-card rounded-2xl p-6 space-y-5">
      <!-- ì…ë ¥ ì„¹ì…˜ -->
      <div>
        <label for="food-text" class="block text-sm font-medium text-[#6e6052] mb-1">ìŒì‹ ì´ë¦„ ë˜ëŠ” ì¬ë£Œ</label>
        <div class="flex items-center gap-2">
            <input type="text" id="food-text" class="input-field w-full" placeholder="ì˜ˆ: ë‹­ê°€ìŠ´ì‚´, ë¸Œë¡œì½œë¦¬">
            <button id="refresh-button-icon" class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center hover:bg-black/5 transition" title="ê°•ì œ ìƒˆë¡œê³ ì¹¨">
                <svg class="w-5 h-5 text-[#6e6052]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.695v-2.695A8.25 8.25 0 004.668 7.158l-3.181 3.183" />
                </svg>
            </button>
            <button id="clear-button-icon" class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center hover:bg-black/5 transition" title="í™”ë©´ ì§€ìš°ê¸°">
                <svg class="w-5 h-5 text-[#6e6052]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <label for="food-image-input" class="btn-secondary w-full cursor-pointer text-center font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-2" title="ê°¤ëŸ¬ë¦¬ì—ì„œ ì‚¬ì§„ ì„ íƒ">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
            <span>ì‚¬ì§„ ì—…ë¡œë“œ</span>
        </label>
        <input type="file" id="food-image-input" accept="image/*" class="hidden" multiple>
        <button id="start-camera-button" class="btn-secondary w-full font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-2" title="ì¹´ë©”ë¼ë¡œ ì§ì ‘ ì´¬ì˜">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h1.172a2 2 0 011.414.586l.828.828A2 2 0 008.828 6H12a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /><path d="M15 8a1 1 0 11-2 0 1 1 0 012 0z" /></svg>
            <span>ì¹´ë©”ë¼ ì´¬ì˜</span>
        </button>
      </div>
      <div id="image-preview-container" class="mt-4 flex flex-wrap gap-3 justify-center"></div>

      <div class="divider-or"><span>ê±´ê°• Q&A</span></div>

      <div>
        <textarea id="qna-text" class="textarea-field w-full h-24 resize-none"></textarea>
      </div>

      <div class="space-y-3 pt-4 border-t border-gray-300/70">
        <div class="grid grid-cols-2 gap-4">
            <button id="recommend-diet-button" class="btn-secondary w-full font-medium py-2 px-4 rounded-xl flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                <span>ì¶”ì²œ ì‹ë‹¨</span>
            </button>
             <button id="view-log-button" class="btn-secondary w-full font-medium py-2 px-4 rounded-xl flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" /></svg>
                <span>ì‹ë‹¨ ê¸°ë¡</span>
            </button>
        </div>
        <div class="flex gap-2">
            <button id="analyze-button" class="btn-primary w-full font-bold py-3 px-4 rounded-xl text-lg flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <span>ê±´ê°• ë‹µë³€í•˜ê¸°</span>
            </button>
            <button id="recipe-button" class="btn-accent flex-shrink-0 font-bold py-3 px-4 rounded-xl text-lg flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h8a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.737 11l-.546 9h7.618l-.546-9M12 11V9m0 0a2 2 0 100-4 2 2 0 000 4z" /></svg>
                <span>ìš”ë¦¬ì¶”ì²œ</span>
            </button>
        </div>
      </div>

      <!-- ë¡œë”© ë° ê²°ê³¼ ì„¹ì…˜ -->
      <div id="loading-indicator" class="text-center my-6 hidden">
        <div class="loader mx-auto"></div>
        <p class="mt-4 text-[#6e6052]">ê±´ê°•ë°•ì‚¬ê°€ ë¶„ì„ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
      <div id="result-section" class="mt-6 hidden">
          <!-- Q&A ê²°ê³¼ -->
          <div id="result-qna-section" class="hidden p-4 rounded-lg bg-white/50 space-y-4">
              <h2 class="text-xl font-bold text-[#4a3f33] border-b border-gray-400/50 pb-2">ê±´ê°• ë‹µë³€</h2>
              <div id="result-qna-answer" class="text-[#4a3f33] whitespace-pre-wrap space-y-3"></div>
          </div>
          <!-- ì‹ë‹¨ ë¶„ì„ ê²°ê³¼ -->
          <div id="result-food-section" class="hidden space-y-4 p-4 rounded-lg bg-white/50">
            <div>
              <h3 class="font-semibold text-lg text-[#6e6052]">ì¢…í•© ì˜ê²¬</h3>
              <div id="result-opinion" class="text-[#4a3f33] whitespace-pre-wrap space-y-3"></div>
            </div>
            <div>
              <h3 class="font-semibold text-lg text-[#6e6052]">ì˜ˆìƒ ì¹¼ë¡œë¦¬</h3>
              <p id="result-calories" class="text-[#4a3f33]"></p>
            </div>
            <div>
              <h3 class="font-semibold text-lg text-[#6e6052]">ì¶”ì²œ</h3>
              <p id="result-recommendation" class="text-[#4a3f33]"></p>
            </div>
          </div>
          <!-- ê±´ê°•ìš”ë¦¬ ì¶”ì²œ ê²°ê³¼ -->
          <div id="result-recipe-section" class="hidden space-y-4 p-4 rounded-lg bg-white/50">
            <h2 id="recipe-name" class="text-2xl font-bold text-[#4a3f33]"></h2>
            <div id="recipe-details" class="space-y-4"></div>
          </div>
          <!-- ê²°ê³¼ ì•¡ì…˜ ë²„íŠ¼ -->
            <div id="result-actions-container" class="hidden mt-4 pt-4 border-t border-gray-400/50 space-y-2">
                <button id="save-log-button" class="btn-primary w-full font-bold py-2 px-4 rounded-xl hidden">ì´ ê²°ê³¼ ê¸°ë¡í•˜ê¸°</button>
                <button id="save-image-button" class="btn-secondary w-full font-bold py-2 px-4 rounded-xl flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    <span>JPGë¡œ ì €ì¥</span>
                </button>
            </div>
      </div>
      <div id="error-section" class="mt-6 hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl" role="alert">
        <strong class="font-bold">ì˜¤ë¥˜: </strong>
        <span id="error-message" class="block sm:inline"></span>
      </div>
    </main>
    
    <footer class="mt-6">
        <div class="content-card rounded-2xl p-4 text-center text-xs text-[#6e6052]">
            <p>ë³¸ ê²°ê³¼ëŠ” AIì— ì˜í•´ ìƒì„±ëœ ì •ë³´ì´ë©°, ì˜í•™ì  ì§„ë‹¨ì„ ëŒ€ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <p>ì •í™•í•œ ê±´ê°• ì •ë³´ëŠ” ì „ë¬¸ì˜ì™€ ìƒë‹´í•˜ì„¸ìš”.</p>
        </div>
    </footer>
  </div>

  <!-- 'ë§¨ ìœ„ë¡œ' ë²„íŠ¼ -->
  <button id="top-button" class="hidden fixed bottom-5 right-5 z-50 btn-primary w-12 h-12 rounded-full flex items-center justify-center shadow-lg">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
  </button>

  <!-- Modals -->
    <div id="camera-view" class="fixed inset-0 bg-black/90 hidden flex-col items-center justify-center p-4 z-50">
        <video id="camera-stream" class="w-full max-w-md h-auto rounded-lg" autoplay playsinline></video>
        <div class="flex items-center space-x-4 mt-4">
            <button id="capture-button" class="btn-primary py-3 px-6 rounded-full text-lg">ì‚¬ì§„ ì¶”ê°€</button>
            <button id="cancel-camera-button" class="text-gray-300 hover:text-white bg-white/20 py-2 px-4 rounded-full">ë‹«ê¸°</button>
        </div>
    </div>
    <div id="diet-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
        <div class="modal-card rounded-2xl p-6 w-full max-w-md relative max-h-[90vh] overflow-y-auto">
             <button id="close-diet-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            <h2 class="text-2xl font-bold text-[#4a3f33] mb-4 border-b border-gray-400/50 pb-2">ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì‹ë‹¨</h2>
            <div id="diet-loading" class="text-center hidden py-8">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-[#6e6052]">ë‹¹ì‹ ì„ ìœ„í•œ ìš”ë¦¬ê°€ì´ë“œë¥¼ ì¶”ì²œì¤‘ì…ë‹ˆë‹¤</p>
            </div>
            <div id="diet-content" class="space-y-4 text-[#4a3f33]"></div>
        </div>
    </div>
    <div id="log-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
        <div class="modal-card rounded-2xl p-6 w-full max-w-md relative max-h-[90vh] flex flex-col">
             <button id="close-log-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            <h2 class="text-2xl font-bold text-[#4a3f33] mb-4 border-b border-gray-400/50 pb-2">ë‚˜ì˜ ì‹ë‹¨ ê¸°ë¡</h2>
            <div id="log-list" class="flex-grow overflow-y-auto space-y-3 pr-2"></div>
             <button id="clear-log-button" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition">ì „ì²´ ê¸°ë¡ ì‚­ì œ</button>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
        <div class="modal-card rounded-2xl p-6 w-full max-w-sm">
            <h2 id="confirm-title" class="text-xl font-bold text-[#4a3f33] mb-4"></h2>
            <p id="confirm-message" class="text-[#6e6052] mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel-button" class="btn-secondary py-2 px-4 rounded-xl">ì·¨ì†Œ</button>
                <button id="confirm-ok-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl">í™•ì¸</button>
            </div>
        </div>
    </div>
  
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const foodTextInput = document.getElementById('food-text');
    const foodImageInput = document.getElementById('food-image-input');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const qnaTextInput = document.getElementById('qna-text');
    const analyzeButton = document.getElementById('analyze-button');
    const recipeButton = document.getElementById('recipe-button');
    const loadingIndicator = document.getElementById('loading-indicator');
    const resultSection = document.getElementById('result-section');
    const resultQnaSection = document.getElementById('result-qna-section');
    const resultQnaAnswer = document.getElementById('result-qna-answer');
    const resultFoodSection = document.getElementById('result-food-section');
    const resultOpinion = document.getElementById('result-opinion');
    const resultCalories = document.getElementById('result-calories');
    const resultRecommendation = document.getElementById('result-recommendation');
    const saveLogButton = document.getElementById('save-log-button');
    const resultRecipeSection = document.getElementById('result-recipe-section');
    const recipeName = document.getElementById('recipe-name');
    const recipeDetails = document.getElementById('recipe-details');
    const errorSection = document.getElementById('error-section');
    const errorMessage = document.getElementById('error-message');
    const startCameraButton = document.getElementById('start-camera-button');
    const recommendDietButton = document.getElementById('recommend-diet-button');
    const viewLogButton = document.getElementById('view-log-button');
    const clearButton = document.getElementById('clear-button-icon');
    const refreshButton = document.getElementById('refresh-button-icon');
    const topButton = document.getElementById('top-button');
    const resultActionsContainer = document.getElementById('result-actions-container');
    const saveImageButton = document.getElementById('save-image-button');
    
    // Modals and their controls
    const cameraView = document.getElementById('camera-view');
    const cameraStream = document.getElementById('camera-stream');
    const captureButton = document.getElementById('capture-button');
    const cancelCameraButton = document.getElementById('cancel-camera-button');
    const dietModal = document.getElementById('diet-modal');
    const closeDietModal = document.getElementById('close-diet-modal');
    const dietLoading = document.getElementById('diet-loading');
    const dietContent = document.getElementById('diet-content');
    const logModal = document.getElementById('log-modal');
    const closeLogModal = document.getElementById('close-log-modal');
    const logList = document.getElementById('log-list');
    const clearLogButton = document.getElementById('clear-log-button');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmCancelButton = document.getElementById('confirm-cancel-button');
    const confirmOkButton = document.getElementById('confirm-ok-button');
    
    let confirmCallback = null;
    let stream = null;
    let uploadedImages = [];
    let currentAnalysisResult = null;
    let currentResultElement = null;

    function show(el, displayMode = 'flex') { if(el) { el.classList.remove('hidden'); el.style.display = displayMode; } }
    function hide(el) { if(el) { el.classList.add('hidden'); el.style.display = 'none'; } }
    
    function setRandomGreeting() {
        const greetings = [
            "ì˜¤ëŠ˜ë„ ê±´ê°•í•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”! ë‹¹ì‹ ì˜ ë„ì „ì„ ì‘ì›í•©ë‹ˆë‹¤.",
            "ì‘ì€ ìŠµê´€ì´ 100ì„¸ ê±´ê°•ì„ ë§Œë“­ë‹ˆë‹¤. ì˜¤ëŠ˜ë„ í™”ì´íŒ…!",
            "ê±´ê°•ì„ í–¥í•œ ë‹¹ì‹ ì˜ ëª¨ë“  ë°œê±¸ìŒì´ ë¹›ë‚˜ê³  ìˆì–´ìš”.",
            "ìµœê³ ì˜ ì»¨ë””ì…˜ìœ¼ë¡œ ë¹›ë‚˜ëŠ” í•˜ë£¨ ë˜ì„¸ìš”!",
            "ë‹¹ì‹ ì˜ ê±´ê°•í•œ ë¯¸ë˜, ë°”ë¡œ ì˜¤ëŠ˜ë¶€í„° ì‹œì‘ë©ë‹ˆë‹¤!",
            "ì„¸ìƒì—ì„œ ê°€ì¥ ì†Œì¤‘í•œ ë‹¹ì‹ , ì˜¤ëŠ˜ë„ ê±´ê°•í•˜ê²Œ ì§€ë‚´ì„¸ìš”."
        ];
        const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
        qnaTextInput.placeholder = `ë°±ìˆœì• ë‹˜!\n${randomGreeting}`;
    }
    setRandomGreeting();


    function setButtonsState(isLoading) {
        analyzeButton.disabled = isLoading;
        recipeButton.disabled = isLoading;
        const spinIcon = analyzeButton.querySelector('svg');
        if (isLoading) {
            spinIcon.classList.add('animate-spin');
        } else {
            spinIcon.classList.remove('animate-spin');
        }
    }

    function handleFiles(files) {
        if (files && files.length > 0) {
             qnaTextInput.value = '';
             foodTextInput.value = '';
        }
        for (const file of files) {
            if (!file.type.startsWith('image/')) continue;
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result.split(',')[1];
                const mimeType = e.target.result.match(/:(.*?);/)[1];
                uploadedImages.push({ data: base64, mime: mimeType });
                renderImagePreviews();
            };
            reader.readAsDataURL(file);
        }
    }

    function renderImagePreviews() {
        imagePreviewContainer.innerHTML = '';
        uploadedImages.forEach((item, index) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'relative w-20 h-20';
            const img = document.createElement('img');
            img.src = `data:${item.mime};base64,${item.data}`;
            img.className = 'w-full h-full object-cover rounded-md shadow-md';
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold leading-none';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                uploadedImages.splice(index, 1);
                renderImagePreviews();
            };
            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            imagePreviewContainer.appendChild(wrapper);
        });
    }

    qnaTextInput.addEventListener('input', () => {
      if (qnaTextInput.value) {
        foodTextInput.value = '';
        uploadedImages = [];
        renderImagePreviews();
      }
    });
    foodTextInput.addEventListener('input', () => {
      if (foodTextInput.value) {
        qnaTextInput.value = '';
        uploadedImages = [];
        renderImagePreviews();
      }
    });
    foodImageInput.addEventListener('change', (event) => {
        handleFiles(event.target.files);
    });

    analyzeButton.addEventListener('click', async () => {
      const foodText = foodTextInput.value.trim();
      const qnaText = qnaTextInput.value.trim();
      if (!foodText && uploadedImages.length === 0 && !qnaText) {
        displayError("ìŒì‹, ì‚¬ì§„, ë˜ëŠ” ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      hide(resultSection); hide(errorSection); show(loadingIndicator, 'block');
      setButtonsState(true);
      try {
        let systemPrompt, parts, analysisType;
        let foodName = foodText;
        if (qnaText) {
          analysisType = 'qna';
          systemPrompt = `ë‹¹ì‹ ì€ ê°œì¸ ë§ì¶¤í˜• ê±´ê°• ê´€ë¦¬ë¥¼ ë•ëŠ” í—¬ìŠ¤ì¼€ì–´ AIì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ê±´ê°• ìƒíƒœë¥¼ ê³ ë ¤í•˜ì—¬, ì§ˆë¬¸ì— ëŒ€í•´ ì•ˆì „í•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”. ë‹µë³€ì€ ê¸ì •ì ì´ê³  í¬ë§ì ì¸ ì–´ì¡°ë¥¼ ìœ ì§€í•´ì£¼ì„¸ìš”.
          ì‘ë‹µì€ ë°˜ë“œì‹œ ë‹¤ìŒ í‚¤ë¥¼ ê°€ì§„ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤:
          - "answer": ë‹¤ìŒ 3ê°œì˜ í‚¤ë¥¼ ê°€ì§„ ê°ì²´:
              - "conclusion": (ë¬¸ìì—´) ì§ˆë¬¸ì— ëŒ€í•œ í•µì‹¬ì ì¸ ê²°ë¡ ì„ 2~3ì¤„ë¡œ ìš”ì•½.
              - "details": (ë¬¸ìì—´) ê²°ë¡ ì— ëŒ€í•œ ìƒì„¸í•œ ì´ìœ ë‚˜ ì„¤ëª…ì„ ì œê³µ.
              - "tip": (ë¬¸ìì—´) ì‚¬ìš©ìê°€ ì‹¤ìƒí™œì—ì„œ ì‹¤ì²œí•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ íŒì´ë‚˜ ì£¼ì˜ì‚¬í•­ì„ ì œì•ˆ.
          ì ˆëŒ€ë¡œ ë‹µë³€ì— '**'ì™€ ê°™ì€ ë§ˆí¬ë‹¤ìš´ ë¬¸ìë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`;
          parts = [{ text: qnaText }];
        } else {
          analysisType = 'food';
          systemPrompt = `ë‹¹ì‹ ì€ ì‹ë‹¨ ê´€ë¦¬ë¥¼ ë•ëŠ” ì „ë¬¸ ì˜ì–‘ì‚¬ AIì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ê±´ê°• ìƒíƒœë¥¼ ê³ ë ¤í•˜ì—¬, ì œê³µëœ ìŒì‹ì— ëŒ€í•´ ë§¤ìš° ì‹ ì¤‘í•˜ê³  ì•ˆì „í•œ ê´€ì ì—ì„œ ë¶„ì„í•´ì£¼ì„¸ìš”. ì‘ë‹µì€ ê¸ì •ì ì´ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ í‘œí˜„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.
          ì‘ë‹µì€ ë°˜ë“œì‹œ ë‹¤ìŒ í‚¤ë¥¼ ê°€ì§„ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤:
          - "opinion": ë‹¤ìŒ 4ê°œì˜ í‚¤ë¥¼ ê°€ì§„ ê°ì²´:
              - "summary": (ë¬¸ìì—´) ìŒì‹ì— ëŒ€í•œ í•µì‹¬ì ì¸ í‰ê°€ë¥¼ 2~3ì¤„ë¡œ ìš”ì•½.
              - "pros": (ë¬¸ìì—´ ë˜ëŠ” null) ê±´ê°•ì— ê¸ì •ì ì¸ ì¸¡ë©´ì´ ìˆë‹¤ë©´ ê°„ëµíˆ ì„œìˆ , ì—†ë‹¤ë©´ null.
              - "cons": (ë¬¸ìì—´) ê±´ê°• ê´€ì ì—ì„œ ì£¼ì˜í•  ì ì´ë‚˜ ê°œì„  ë°©í–¥ì„ ë¶€ë“œëŸ½ê²Œ ì„œìˆ .
              - "tip": (ë¬¸ìì—´ ë˜ëŠ” null) ì´ ìŒì‹ì´ 'ì£¼ì˜' ë˜ëŠ” 'ë‚˜ì¨' ë“±ê¸‰ì¼ ê²½ìš°, ë” ê±´ê°•í•˜ê²Œ ì„­ì·¨í•  ìˆ˜ ìˆëŠ” í˜„ì‹¤ì ì¸ ë°©ë²•(ì˜ˆ: 'ê¸°ë¦„ê¸°ê°€ ë§ì€ ê»ì§ˆ ëŒ€ì‹  ì‚´ì½”ê¸° ìœ„ì£¼ë¡œ ë“œì‹œë©´ ì¢‹ìŠµë‹ˆë‹¤')ì„ ì œì•ˆ. 'ì¢‹ìŒ' ë“±ê¸‰ì´ë©´ null.
          - "calories": (ë¬¸ìì—´) ì˜ˆìƒ ì¹¼ë¡œë¦¬.
          - "recommendation": (ë¬¸ìì—´) "ì¢‹ìŒ", "ì£¼ì˜", "ë‚˜ì¨" ì¤‘ í•˜ë‚˜.
          - "recommendationSummary": (ë¬¸ìì—´) 'recommendation' ë“±ê¸‰ì— ëŒ€í•œ ì´ìœ ë¥¼ 1~3ì¤„ë¡œ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ì„œ ì„¤ëª….
          ì ˆëŒ€ë¡œ ë‹µë³€ì— '**'ì™€ ê°™ì€ ë§ˆí¬ë‹¤ìš´ ë¬¸ìë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`;
          if (uploadedImages.length > 0) {
            parts = [{ text: "ì´ ìŒì‹ë“¤ì´ ê±´ê°•ì— ì–´ë–¤ ì˜í–¥ì„ ì£¼ëŠ”ì§€ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”." }];
            uploadedImages.forEach(item => parts.push({ inline_data: { mime_type: item.mime, data: item.data } }));
            foodName = `ì‚¬ì§„ ${uploadedImages.length}ì¥ ì¢…í•© ë¶„ì„`;
          } else {
            parts = [{ text: `ìŒì‹: ${foodText}. ì´ ìŒì‹ì´ ê±´ê°•ì— ì–´ë–¤ ì˜í–¥ì„ ì£¼ëŠ”ì§€ ë¶„ì„í•´ì£¼ì„¸ìš”.` }];
          }
        }
        const data = await callGeminiAPI(systemPrompt, parts);
        if (analysisType === 'food') {
          currentAnalysisResult = { ...data, food: foodName, date: new Date().toISOString() };
        }
        displayResult(data, analysisType);
      } catch (error) {
        console.error("ë¶„ì„ ì˜¤ë¥˜:", error);
        displayError(error.message || "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
        hide(loadingIndicator);
        setButtonsState(false);
      }
    });
    
    recipeButton.addEventListener('click', async () => {
        const foodText = foodTextInput.value.trim();
        if (!foodText && uploadedImages.length === 0) {
            displayError("ë ˆì‹œí”¼ë¥¼ ì¶”ì²œë°›ìœ¼ë ¤ë©´ ì¬ë£Œ ì´ë¦„ì´ë‚˜ ì‚¬ì§„ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        hide(resultSection); hide(errorSection); show(loadingIndicator, 'block');
        setButtonsState(true);
        try {
            const systemPrompt = `ë‹¹ì‹ ì€ ê±´ê°• ìš”ë¦¬ ì „ë¬¸ ì…°í”„ AIì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ê±´ê°• ìƒíƒœë¥¼ ê³ ë ¤í•˜ì—¬, ì œê³µëœ ì¬ë£Œë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ì†Œí™”ê°€ ì˜ ë˜ê³  ê±´ê°•í•œ ìš”ë¦¬ë²•ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”. ê¸ì •ì ì´ê³  ë”°ë¼í•˜ê¸° ì‰¬ìš´ ì„¤ëª…ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
            ì‘ë‹µì€ ë°˜ë“œì‹œ ë‹¤ìŒ í‚¤ë¥¼ ê°€ì§„ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤:
            - "recipeName": (ë¬¸ìì—´) ìš”ë¦¬ ì´ë¦„.
            - "chefTip": (ë¬¸ìì—´) ìš”ë¦¬ë¥¼ ë” ê±´ê°•í•˜ê³  ë§›ìˆê²Œ ë§Œë“¤ê¸° ìœ„í•œ ì…°í”„ì˜ íŒ.
            - "ingredients": (ë¬¸ìì—´ ë°°ì—´) í•„ìš”í•œ ì¬ë£Œ ëª©ë¡.
            - "instructions": (ë¬¸ìì—´ ë°°ì—´) ë§Œë“œëŠ” ë²•ì„ ë‹¨ê³„ë³„ë¡œ ì„¤ëª….
            ì ˆëŒ€ë¡œ ë‹µë³€ì— '**'ì™€ ê°™ì€ ë§ˆí¬ë‹¤ìš´ ë¬¸ìë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`;
            let parts;
            if (uploadedImages.length > 0) {
                parts = [{ text: "ì´ ì‚¬ì§„ ì† ì¬ë£Œë“¤ë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ê±´ê°• ìš”ë¦¬ ë ˆì‹œí”¼ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”." }];
                uploadedImages.forEach(item => parts.push({ inline_data: { mime_type: item.mime, data: item.data } }));
            } else {
                parts = [{ text: `ì´ ì¬ë£Œë“¤ë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ê±´ê°• ìš”ë¦¬ ë ˆì‹œí”¼ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”: ${foodText}` }];
            }
            const data = await callGeminiAPI(systemPrompt, parts);
            displayResult(data, 'recipe');
        } catch (error) {
            console.error("ë ˆì‹œí”¼ ìƒì„± ì˜¤ë¥˜:", error);
            displayError(error.message || "ë ˆì‹œí”¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            hide(loadingIndicator);
            setButtonsState(false);
        }
    });

    function displayResult(data, type) {
        hide(resultQnaSection);
        hide(resultFoodSection);
        hide(resultRecipeSection);
        hide(resultActionsContainer);
        hide(saveLogButton);

        if (type === 'qna') {
            currentResultElement = resultQnaSection;
            show(resultQnaSection, 'block');
            resultQnaAnswer.innerHTML = '';
            const answerData = data.answer;

            if (answerData && answerData.conclusion) {
                const conclusionSection = document.createElement('div');
                conclusionSection.innerHTML = `<h4 class="font-bold text-lg text-[#574a3a] mb-1">âœ… í•µì‹¬ ê²°ë¡ </h4><p class="whitespace-pre-wrap">${answerData.conclusion}</p>`;
                resultQnaAnswer.appendChild(conclusionSection);
            }
            if (answerData && answerData.details) {
                const detailsSection = document.createElement('div');
                detailsSection.className = 'mt-4';
                detailsSection.innerHTML = `<h4 class="font-bold text-lg text-gray-700 mb-1">ğŸ”¬ ìƒì„¸ ì„¤ëª…</h4><p class="whitespace-pre-wrap">${answerData.details}</p>`;
                resultQnaAnswer.appendChild(detailsSection);
            }
            if (answerData && answerData.tip) {
                const tipSection = document.createElement('div');
                tipSection.className = 'mt-4 p-3 rounded-lg bg-blue-100/70 border border-blue-300';
                tipSection.innerHTML = `<h4 class="font-bold text-lg text-blue-900 mb-1">ğŸ’¡ ì‹¤ì²œ íŒ</h4><p class="text-blue-900 whitespace-pre-wrap">${answerData.tip}</p>`;
                resultQnaAnswer.appendChild(tipSection);
            }

        } else if (type === 'food') {
            currentResultElement = resultFoodSection;
            show(resultFoodSection, 'block');
            show(saveLogButton, 'block');
            resultOpinion.innerHTML = ''; 

            const opinionData = data.opinion;

            if(opinionData && opinionData.summary) {
                const summarySection = document.createElement('div');
                summarySection.innerHTML = `<h4 class="font-bold text-lg text-[#574a3a] mb-1">âœ… í•µì‹¬ ìš”ì•½</h4><p class="whitespace-pre-wrap">${opinionData.summary}</p>`;
                resultOpinion.appendChild(summarySection);
            }

            const prosConsContainer = document.createElement('div');
            prosConsContainer.className = 'mt-4 grid gap-4';
            let prosConsHTML = '';
            if (opinionData && opinionData.pros) {
                prosConsHTML += `<div><h4 class="font-bold text-lg text-green-700 mb-1">ğŸ‘ ê¸ì •ì  ì¸¡ë©´</h4><p class="whitespace-pre-wrap">${opinionData.pros}</p></div>`;
            }
            if (opinionData && opinionData.cons) {
                prosConsHTML += `<div><h4 class="font-bold text-lg text-red-700 mb-1">ğŸš¨ ë¶€ì •ì  ì¸¡ë©´</h4><p class="whitespace-pre-wrap">${opinionData.cons}</p></div>`;
            }
            if(prosConsHTML) {
                prosConsContainer.innerHTML = prosConsHTML;
                resultOpinion.appendChild(prosConsContainer);
            }
            
            if (opinionData && opinionData.tip) {
                const tipSection = document.createElement('div');
                tipSection.className = 'mt-4 p-3 rounded-lg bg-yellow-100/70 border border-yellow-400';
                tipSection.innerHTML = `<h4 class="font-bold text-lg text-yellow-900 mb-1">ğŸ’¡ ëŒ€ì²˜ë²• ê°€ì´ë“œ</h4><p class="text-yellow-900 whitespace-pre-wrap">${opinionData.tip}</p>`;
                resultOpinion.appendChild(tipSection);
            }

            resultCalories.textContent = data.calories || "ì •ë³´ ì—†ìŒ";
            
            const resultRecommendationEl = document.getElementById('result-recommendation');
            const recommendationContainer = resultRecommendationEl.parentElement;
            recommendationContainer.innerHTML = ''; // Clear previous content

            // Create header div
            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex items-center gap-2 mb-1';

            // Create h3
            const headerText = document.createElement('h3');
            headerText.className = 'font-semibold text-lg text-[#6e6052]';
            headerText.textContent = 'ì¶”ì²œ';

            // Create badge
            const recommendation = data.recommendation || "ì •ë³´ ì—†ìŒ";
            const badge = document.createElement('span');
            badge.textContent = recommendation;
            badge.className = 'recommendation-badge';
            if (recommendation === 'ì¢‹ìŒ') badge.classList.add('recommendation-good');
            else if (recommendation === 'ì£¼ì˜') badge.classList.add('recommendation-caution');
            else if (recommendation === 'ë‚˜ì¨') badge.classList.add('recommendation-bad');
            
            headerDiv.appendChild(headerText);
            headerDiv.appendChild(badge);
            
            // Create summary paragraph
            const summaryP = document.createElement('p');
            summaryP.className = 'text-[#4a3f33]';
            summaryP.textContent = data.recommendationSummary || '';

            recommendationContainer.appendChild(headerDiv);
            recommendationContainer.appendChild(summaryP);
            
            saveLogButton.textContent = "ì´ ê²°ê³¼ ê¸°ë¡í•˜ê¸°";
            saveLogButton.disabled = false;
            saveLogButton.className = 'btn-primary w-full font-bold py-2 px-4 rounded-xl';

        } else if (type === 'recipe') {
            currentResultElement = resultRecipeSection;
            show(resultRecipeSection, 'block');
            recipeName.textContent = data.recipeName || "ì´ë¦„ ì—†ëŠ” ë ˆì‹œí”¼";
            recipeDetails.innerHTML = '';

            if (data.chefTip) {
                const tipSection = document.createElement('div');
                tipSection.className = 'mb-4 p-3 rounded-lg bg-blue-100/70 border border-blue-300';
                tipSection.innerHTML = `<h4 class="font-bold text-lg text-blue-900 mb-1">ğŸ‘¨â€ğŸ³ ì…°í”„ì˜ íŒ</h4><p class="text-blue-900 whitespace-pre-wrap">${data.chefTip}</p>`;
                recipeDetails.appendChild(tipSection);
            }

            const ingredientsSection = document.createElement('div');
            let ingredientsHTML = `<h3 class="font-semibold text-lg text-[#6e6052]">ì¬ë£Œ</h3><ul class="list-disc list-inside text-[#4a3f33]">`;
            (data.ingredients || []).forEach(ing => {
                ingredientsHTML += `<li>${ing}</li>`;
            });
            ingredientsHTML += `</ul>`;
            ingredientsSection.innerHTML = ingredientsHTML;
            recipeDetails.appendChild(ingredientsSection);

            const instructionsSection = document.createElement('div');
            instructionsSection.className = 'mt-4';
            let instructionsHTML = `<h3 class="font-semibold text-lg text-[#6e6052]">ë§Œë“œëŠ” ë²•</h3><ol class="list-decimal list-inside text-[#4a3f33] space-y-1">`;
            (data.instructions || []).forEach(step => {
                instructionsHTML += `<li>${step}</li>`;
            });
            instructionsHTML += `</ol>`;
            instructionsSection.innerHTML = instructionsHTML;
            recipeDetails.appendChild(instructionsSection);
        }
      show(resultSection, 'block');
      show(resultActionsContainer, 'block');
    }

    async function callGeminiAPI(systemPrompt, parts) {
      const apiKey = "AIzaSyBJEtwmOTMo1yB3VtfGre72AOIxZKpi8SU"; 
      if (apiKey === "YOUR_API_KEY_HERE" || apiKey === "") {
        throw new Error("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. callGeminiAPI í•¨ìˆ˜ ì•ˆì— ìˆëŠ” apiKey ë³€ìˆ˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      
      const maxRetries = 3;
      let delay = 1000; // 1ì´ˆë¶€í„° ì‹œì‘

      for (let i = 0; i < maxRetries; i++) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000); // ê° ì‹œë„ë§ˆë‹¤ 20ì´ˆ íƒ€ì„ì•„ì›ƒ

        try {
          const payload = { contents: [{ parts }], systemInstruction: { parts: [{ text: systemPrompt }] }, generationConfig: { responseMimeType: "application/json" } };
          const res = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal });
          
          clearTimeout(timeoutId);

          if (res.ok) {
            const result = await res.json();
            if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
              return JSON.parse(result.candidates[0].content.parts[0].text);
            }
            throw new Error("AI ì‘ë‹µ êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤.");
          }

          if (res.status === 503) {
            if (i === maxRetries - 1) {
                const t = await res.text();
                throw new Error(`API ìš”ì²­ ì‹¤íŒ¨ (ì¬ì‹œë„ ëª¨ë‘ ì‹¤íŒ¨): ${res.status} - ${t}`);
            }
            console.log(`API Overloaded (503). Retrying in ${delay / 1000} seconds...`);
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2; // ì§€ìˆ˜ ë°±ì˜¤í”„
          } else {
            const t = await res.text();
            throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${res.status} - ${t}`);
          }
        } catch (error) {
          clearTimeout(timeoutId);
          if (i === maxRetries - 1) {
            throw error;
          }
           console.log(`Fetch error. Retrying in ${delay / 1000} seconds... Error: ${error.message}`);
           await new Promise(resolve => setTimeout(resolve, delay));
           delay *= 2;
        }
      }
      throw new Error("API ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨)");
    }
    
    function clearInputs() {
        foodTextInput.value = "";
        qnaTextInput.value = "";
        foodImageInput.value = ""; 
        uploadedImages = [];
        renderImagePreviews();
    }
    function resetApp() {
        clearInputs();
        currentAnalysisResult = null;
        hide(resultSection);
        hide(errorSection);
        hide(loadingIndicator);
        setRandomGreeting(); // ì´ˆê¸°í™” ì‹œì—ë„ ìƒˆë¡œìš´ ì‘ì› ë©”ì‹œì§€ ì„¤ì •
    }
    clearButton.addEventListener('click', resetApp);

    refreshButton.addEventListener('click', () => {
        // URLì— í˜„ì¬ ì‹œê°„ì„ ì¶”ê°€í•˜ì—¬ ìºì‹œë¥¼ ë¬´ì‹œí•˜ê³  ê°•ì œë¡œ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.
        const currentUrl = window.location.href.split('?')[0];
        window.location.href = currentUrl + '?cache_bust=' + new Date().getTime();
    });

    function displayError(msg) { errorMessage.textContent = msg; show(errorSection, 'block'); }
    
    startCameraButton.addEventListener('click', async () => {
        if (location.protocol !== 'https:') { displayError("ì¹´ë©”ë¼ëŠ” HTTPSì—ì„œë§Œ ë™ì‘í•©ë‹ˆë‹¤."); return; }
        if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) { displayError("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          show(cameraView, 'flex'); cameraStream.srcObject = stream;
        } catch (e) { console.error(e); displayError("ì¹´ë©”ë¼ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆê±°ë‚˜ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
    });
    captureButton.addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = cameraStream.videoWidth || 1280;
        canvas.height = cameraStream.videoHeight || 720;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(cameraStream, 0, 0, canvas.width, canvas.height);
        const dataURL = canvas.toDataURL('image/jpeg', 0.85);
        const parsed = dataURL.match(/^data:(.*?);base64,(.*)$/);
        if (parsed) {
            handleFiles([]); 
            uploadedImages.push({ data: parsed[2], mime: parsed[1] }); 
            renderImagePreviews();
        }
        stopCamera();
    });
    cancelCameraButton.addEventListener('click', () => stopCamera());
    function stopCamera() { if (stream) stream.getTracks().forEach(t => t.stop()); hide(cameraView); stream = null; }
    
    saveImageButton.addEventListener('click', () => {
        if (!currentResultElement) return;

        saveImageButton.textContent = 'ì €ì¥ ì¤‘...';
        saveImageButton.disabled = true;

        html2canvas(currentResultElement, {
            useCORS: true,
            backgroundColor: '#fdfaf6'
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'health_result.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
            saveImageButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg><span>JPGë¡œ ì €ì¥</span>`;
            saveImageButton.disabled = false;
        }).catch(err => {
            console.error("ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜:", err);
            displayError("ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            saveImageButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg><span>JPGë¡œ ì €ì¥</span>`;
            saveImageButton.disabled = false;
        });
    });

    // --- Diet & Log Modal Logic ---
    recommendDietButton.addEventListener('click', async () => {
        show(dietModal, 'flex');
        show(dietLoading, 'block');
        dietContent.innerHTML = '';
        try {
            const systemPrompt = `ë‹¹ì‹ ì€ ê· í˜• ì¡íŒ ì‹ë‹¨ì„ ì¶”ì²œí•˜ëŠ” ì „ë¬¸ ì˜ì–‘ì‚¬ AIì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ê±´ê°• ìƒíƒœë¥¼ ê³ ë ¤í•˜ì—¬, ì†Œí™”ê°€ í¸í•˜ê³  ê±´ê°•í•œ í•˜ë£¨ ì¶”ì²œ ì‹ë‹¨ì„ ìƒì„±í•´ì£¼ì„¸ìš”. ì‹ë‹¨ì€ ì €ì§€ë°©, ì €ìê·¹, ì†Œí™”ê°€ ì˜ë˜ëŠ” ê²ƒì„ ê¸°ë³¸ìœ¼ë¡œ í•©ë‹ˆë‹¤. ë‹µë³€ì€ 'breakfast', 'lunch', 'dinner', 'snacks' í‚¤ë¥¼ ê°€ì§„ JSON ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤. ì ˆëŒ€ë¡œ ë‹µë³€ì— '**'ì™€ ê°™ì€ ë§ˆí¬ë‹¤ìš´ ë¬¸ìë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`;
            const parts = [{ text: "ê±´ê°•ì— ì¢‹ì€ í•˜ë£¨ ì¶”ì²œ ì‹ë‹¨ì„ ìƒì„±í•´ì£¼ì„¸ìš”." }];
            const data = await callGeminiAPI(systemPrompt, parts);
            dietContent.innerHTML = `
                <div class="mb-3"><h3 class="font-semibold text-lg">ì•„ì¹¨</h3><p>${data.breakfast || 'ì •ë³´ ì—†ìŒ'}</p></div>
                <div class="mb-3"><h3 class="font-semibold text-lg">ì ì‹¬</h3><p>${data.lunch || 'ì •ë³´ ì—†ìŒ'}</p></div>
                <div class="mb-3"><h3 class="font-semibold text-lg">ì €ë…</h3><p>${data.dinner || 'ì •ë³´ ì—†ìŒ'}</p></div>
                <div><h3 class="font-semibold text-lg">ê°„ì‹</h3><p>${data.snacks || 'ì •ë³´ ì—†ìŒ'}</p></div>
            `;
        } catch(error) {
            dietContent.innerHTML = `<p class="text-red-500">ì‹ë‹¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
        } finally {
            hide(dietLoading);
        }
    });

    function displayLogs() {
        const logs = JSON.parse(localStorage.getItem('foodLog')) || [];
        logList.innerHTML = '';
        if (logs.length === 0) {
            logList.innerHTML = `<p class="text-center text-gray-500">ê¸°ë¡ëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            hide(clearLogButton);
            return;
        }
        show(clearLogButton, 'block');
        logs.forEach(log => {
            const logDate = new Date(log.date);
            const dateString = `${logDate.getFullYear()}.${logDate.getMonth() + 1}.${logDate.getDate()} ${logDate.getHours()}:${String(logDate.getMinutes()).padStart(2, '0')}`;
            const badge = `<span class="recommendation-badge ${log.recommendation === 'ì¢‹ìŒ' ? 'recommendation-good' : log.recommendation === 'ì£¼ì˜' ? 'recommendation-caution' : 'recommendation-bad'}">${log.recommendation}</span>`;
            const logItem = document.createElement('div');
            logItem.className = 'bg-white/50 p-3 rounded-lg';
            logItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <p class="font-bold">${log.food}</p>
                    ${badge}
                </div>
                <p class="text-xs text-gray-600 mt-1">${dateString}</p>
            `;
            logList.appendChild(logItem);
        });
    }

    viewLogButton.addEventListener('click', () => {
        displayLogs();
        show(logModal, 'flex');
    });

    saveLogButton.addEventListener('click', () => {
        if (currentAnalysisResult) {
            const logs = JSON.parse(localStorage.getItem('foodLog')) || [];
            logs.unshift(currentAnalysisResult);
            localStorage.setItem('foodLog', JSON.stringify(logs));
            saveLogButton.textContent = "ì €ì¥ ì™„ë£Œ!";
            saveLogButton.disabled = true;
            saveLogButton.classList.add('opacity-50');
        }
    });

    clearLogButton.addEventListener('click', () => {
        showConfirm("ëª¨ë“  ê¸°ë¡ ì‚­ì œ", "ì •ë§ë¡œ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", () => {
            localStorage.removeItem('foodLog');
            displayLogs();
        });
    });

    closeDietModal.addEventListener('click', () => hide(dietModal));
    closeLogModal.addEventListener('click', () => hide(logModal));
    
    function showConfirm(title, message, callback) {
        confirmTitle.textContent = title; confirmMessage.textContent = message; confirmCallback = callback; show(confirmModal, 'flex');
    }
    confirmCancelButton.addEventListener('click', () => { hide(confirmModal); confirmCallback = null; });
    confirmOkButton.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hide(confirmModal); confirmCallback = null; });
    
    // --- Top Button Logic ---
    window.addEventListener('scroll', () => {
        if (window.scrollY > 200) {
            topButton.classList.remove('hidden');
        } else {
            topButton.classList.add('hidden');
        }
    });

    topButton.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

  });
  </script>
</body>
</html>





