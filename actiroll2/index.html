<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcTi ë¡¤ëª¨ë¸ - AI ë°°ìš° ë¶„ì„ ë¦¬í¬íŠ¸</title>
    <!-- í™ˆ í™”ë©´ ì•„ì´ì½˜ ì„¤ì • -->
    <link rel="apple-touch-icon" href="actiroll.png">
    <link rel="icon" type="image/png" href="actiroll.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #FDF8F0; /* Warm, elegant off-white */
            --text-primary: #4E443C; /* Dark, warm brown for headings */
            --text-secondary: #71665D; /* Slightly lighter for body text */
            --accent-color: #6B5B4B; /* Muted, sophisticated brown for buttons/accents */
            --border-color: #E5E0D9;
        }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-main); color: var(--text-secondary); }
        h1, h2, h3, h4, h5, .font-serif { font-family: 'Playfair Display', serif; color: var(--text-primary); }
        .accent-text { color: var(--accent-color); }
        .accent-bg { background-color: var(--accent-color); }
        
        #report-content ::-webkit-scrollbar, #qna-chatbox::-webkit-scrollbar, #scene-content::-webkit-scrollbar, #tips-content::-webkit-scrollbar { width: 8px; }
        #report-content ::-webkit-scrollbar-track, #qna-chatbox::-webkit-scrollbar-track, #scene-content::-webkit-scrollbar-track, #tips-content::-webkit-scrollbar-track { background: #EFEAE4; }
        #report-content ::-webkit-scrollbar-thumb, #qna-chatbox::-webkit-scrollbar-thumb, #scene-content::-webkit-scrollbar-thumb, #tips-content::-webkit-scrollbar-thumb { background-color: #D1C9BF; border-radius: 10px; }
        #report-content ::-webkit-scrollbar-thumb:hover, #qna-chatbox::-webkit-scrollbar-thumb:hover, #scene-content::-webkit-scrollbar-thumb:hover, #tips-content::-webkit-scrollbar-thumb:hover { background-color: #BDB2A7; }

        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .ai-generated-content h2, .ai-generated-content h3 { font-family: 'Playfair Display', serif; color: var(--text-primary); margin-bottom: 0.75rem; }
        .ai-generated-content h2 { font-size: 1.75rem; margin-top: 2rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .ai-generated-content h3 { font-size: 1.25rem; margin-top: 1.5rem; }
        .ai-generated-content p { line-height: 1.7; margin-bottom: 1rem; }
        .ai-generated-content ul { list-style-type: disc; list-style-position: outside; padding-left: 1.5rem; margin-bottom: 1rem; }
        .ai-generated-content li { margin-bottom: 0.5rem; padding-left: 0.5rem; }
        .ai-generated-content li::marker { color: var(--accent-color); }
        .ai-generated-content strong { color: var(--text-primary); font-weight: 500; }
        .ai-generated-content p:last-child { margin-bottom: 0; }
        .ai-generated-content em { font-style: italic; color: var(--text-secondary); }

        .finder-option-button.selected {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="p-6 md:p-8 border-b sticky top-0 bg-[var(--bg-main)] z-10" style="border-color: var(--border-color);">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                 <img src="actiroll.png" alt="AcTi Logo" class="h-10 w-10 rounded-full object-cover bg-stone-200 border border-stone-300">
                 <h1 class="text-2xl md:text-3xl tracking-wider">AcTi ë¡¤ëª¨ë¸</h1>
            </div>
            <div class="flex items-center space-x-2 md:space-x-4">
                 <button id="finder-button" title="ë¡¤ëª¨ë¸ ì°¾ê¸°" class="accent-bg text-white rounded-full p-2.5 hover:opacity-90 transition-opacity">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 12.172 4H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Z"/><circle cx="12" cy="13" r="3"/></svg>
                 </button>
                 <button id="save-jpg-button" title="ë¦¬í¬íŠ¸ ì €ì¥í•˜ê¸°" class="accent-bg text-white rounded-full p-2.5 hover:opacity-90 transition-all disabled:opacity-40 disabled:cursor-not-allowed">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                 </button>
                 <button id="qna-button" title="AcTi Q&A" class="accent-bg text-white rounded-full p-2.5 hover:opacity-90 transition-opacity">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                 </button>
            </div>
        </div>
    </header>

    <main id="main-content" class="container mx-auto p-6 md:p-12">
        <section id="search-section" class="text-center transition-opacity duration-700 fade-in-up">
            <h2 class="text-4xl md:text-6xl mb-4">The Actor's Dossier</h2>
            <p class="mb-10 max-w-2xl mx-auto">ë¶„ì„í•˜ê³  ì‹¶ì€ ë°°ìš°ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.<br>AcTiê°€ ê·¸ì˜ ëª¨ë“  ê²ƒì„ ë¶„ì„í•˜ì—¬, ë‹¹ì‹ ì„ ìœ„í•œ ì •ë°€ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
            <div class="max-w-xl mx-auto flex items-center gap-2 p-2 bg-white rounded-full shadow-md border" style="border-color: var(--border-color);">
                <input type="text" id="actor-search-input" class="w-full py-3 px-5 bg-transparent text-lg focus:outline-none" placeholder="ì˜ˆ: ì´ë³‘í—Œ, ì „ë„ì—°, ìµœë¯¼ì‹" style="color: var(--text-primary);">
                <button id="search-button" class="accent-bg text-white rounded-full p-3 hover:opacity-90 transition-opacity"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></button>
            </div>
        </section>

        <section id="finder-results-section" class="hidden text-center transition-opacity duration-700"></section>
        <section id="disambiguation-section" class="hidden text-center transition-opacity duration-700"></section>
        
        <section id="loading-section" class="hidden text-center transition-opacity duration-500">
            <div class="flex flex-col items-center justify-center min-h-[50vh]">
                 <div class="w-16 h-16 border-4 border-stone-200 rounded-full animate-spin" style="border-top-color: var(--accent-color);"></div>
                 <h3 class="text-3xl mt-8">AcTiê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</h3>
                 <p id="loading-status" class="mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            </div>
        </section>

        <section id="error-section" class="hidden my-8 transition-opacity duration-500">
             <div class="max-w-2xl mx-auto bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg" role="alert">
                 <strong class="font-bold font-serif" id="error-title">ë¶„ì„ ì˜¤ë¥˜!</strong>
                 <p id="error-message">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
             </div>
        </section>

        <section id="report-section" class="hidden"></section>
    </main>
    
    <!-- All Modals -->
    <div id="finder-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col" style="background-color: var(--bg-main);">
            <header class="p-4 border-b flex justify-between items-center" style="border-color: var(--border-color);"><h3 class="text-2xl font-serif">ë‚˜ì˜ ë¡¤ëª¨ë¸ ì°¾ê¸°</h3><button id="close-finder-modal" class="p-2 -mr-2 text-2xl leading-none text-stone-500 hover:text-stone-800">&times;</button></header>
            <div class="flex-1 p-6 overflow-y-auto space-y-6">
                <div>
                    <h4 class="font-bold mb-2 text-primary">ì„±ë³„</h4>
                    <div id="finder-gender" class="flex gap-2">
                        <button class="finder-option-button w-full bg-white text-stone-700 py-2 rounded-full border hover:bg-stone-50" data-group="gender">ë‚¨ì</button>
                        <button class="finder-option-button w-full bg-white text-stone-700 py-2 rounded-full border hover:bg-stone-50" data-group="gender">ì—¬ì</button>
                    </div>
                </div>
                 <div>
                    <h4 class="font-bold mb-2 text-primary">ì—°ë ¹ëŒ€</h4>
                    <div id="finder-age" class="grid grid-cols-3 gap-2">
                        <button class="finder-option-button bg-white text-stone-700 py-2 rounded-full border hover:bg-stone-50" data-group="age">10ëŒ€</button>
                        <button class="finder-option-button bg-white text-stone-700 py-2 rounded-full border hover:bg-stone-50" data-group="age">20ëŒ€</button>
                        <button class="finder-option-button bg-white text-stone-700 py-2 rounded-full border hover:bg-stone-50" data-group="age">30ëŒ€</button>
                        <button class="finder-option-button bg-white text-stone-700 py-2 rounded-full border hover:bg-stone-50" data-group="age">40ëŒ€</button>
                        <button class="finder-option-button bg-white text-stone-700 py-2 rounded-full border hover:bg-stone-50" data-group="age">50ëŒ€ ì´ìƒ</button>
                    </div>
                </div>
                 <div>
                    <h4 class="font-bold mb-2 text-primary">ì—°ê¸° ìŠ¤íƒ€ì¼ (ìµœëŒ€ 3ê°œ ì„ íƒ)</h4>
                    <div id="finder-style" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                         <button class="finder-option-button bg-white text-stone-700 py-2 rounded-full border hover:bg-stone-50" data-group="style">ë©”ì†Œë“œ ì—°ê¸°</button>
                         <button class="finder-option-button bg-white text-stone-700 py-2 rounded-full border hover:bg-stone-50" data-group="style">ìºë¦­í„° ì—°ê¸°</button>
                         <button class="finder-option-button bg-white text-stone-700 py-2 rounded-full border hover:bg-stone-50" data-group="style">ìì—°ìŠ¤ëŸ¬ìš´ ìƒí™œ ì—°ê¸°</button>
                         <button class="finder-option-button bg-white text-stone-700 py-2 rounded-full border hover:bg-stone-50" data-group="style">ê°•ë ¬í•œ ì¹´ë¦¬ìŠ¤ë§ˆ</button>
                         <button class="finder-option-button bg-white text-stone-700 py-2 rounded-full border hover:bg-stone-50" data-group="style">ì½”ë¯¸ë””/í¬ê·¹ ì—°ê¸°</button>
                         <button class="finder-option-button bg-white text-stone-700 py-2 rounded-full border hover:bg-stone-50" data-group="style">ì„  êµµì€ ì•¡ì…˜ ì—°ê¸°</button>
                    </div>
                </div>
            </div>
            <footer class="p-4 border-t bg-white text-center" style="border-color: var(--border-color);">
                <button id="find-rolemodels-button" class="w-full accent-bg text-white rounded-full py-3 px-5 hover:opacity-90 transition-opacity">AcTi! ë¡¤ëª¨ë¸ ì¶”ì²œí•´ì¤˜</button>
            </footer>
        </div>
    </div>
    <div id="qna-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col" style="background-color: var(--bg-main);">
            <header class="p-4 border-b flex justify-between items-center" style="border-color: var(--border-color);"><h3 class="text-2xl font-serif">AcTi Q&A</h3><button id="close-qna-modal" class="p-2 -mr-2 text-2xl leading-none text-stone-500 hover:text-stone-800">&times;</button></header>
            <div id="qna-chatbox" class="flex-1 p-4 overflow-y-auto space-y-4">
                 <div class="flex items-start gap-3">
                    <div class="accent-bg text-white text-sm rounded-full h-8 w-8 flex-shrink-0 flex items-center justify-center font-bold">A</div>
                    <div class="bg-white rounded-lg p-3 max-w-lg shadow-sm border ai-generated-content" style="border-color: var(--border-color);"><p class="text-sm">ë°°ìš° ë¶„ì„ì´ë‚˜ ì—°ê¸°ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.</p></div>
                </div>
            </div>
            <footer class="p-4 border-t bg-white" style="border-color: var(--border-color);">
                <form id="qna-form" class="flex items-center gap-2">
                    <input type="text" id="qna-input" class="w-full py-2 px-4 bg-gray-100 rounded-full focus:outline-none" placeholder="AcTiì—ê²Œ ì§ˆë¬¸í•˜ê¸°..."><button type="submit" class="accent-bg text-white rounded-full p-3 hover:opacity-90"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg></button>
                </form>
            </footer>
        </div>
    </div>
    <div id="scene-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div id="scene-to-capture" class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col" style="background-color: var(--bg-main);">
            <header class="p-4 border-b flex justify-between items-center" style="border-color: var(--border-color);">
                <div class="flex items-center gap-3">
                    <h3 class="text-2xl font-serif">âœ¨ ë§ì¶¤ ì˜¤ë””ì…˜ ëŒ€ë³¸</h3>
                    <button id="get-acting-tips-button" title="ì—°ê¸° íŒ ë³´ê¸°" class="text-yellow-500 hover:text-yellow-400 transition-colors"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15.09 16.05a1 1 0 0 1-1.42 1.42l-1.6-1.6a1 1 0 0 1 0-1.41l8.59-8.6a1 1 0 0 1 1.41 0zM12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 1.42-.23 2.82-.67 4.15"/></svg></button>
                </div>
                <button id="close-scene-modal" class="p-2 -mr-2 text-2xl leading-none">&times;</button>
            </header>
            <div id="scene-content" class="flex-1 p-6 overflow-y-auto ai-generated-content"></div>
            <footer class="p-4 border-t bg-white" style="border-color: var(--border-color);">
                 <form id="scene-edit-form" class="flex items-center gap-2 mb-3">
                    <input type="text" id="scene-edit-input" class="w-full py-2 px-4 bg-gray-100 rounded-full focus:outline-none" placeholder="ëŒ€ë³¸ ìˆ˜ì • ìš”ì²­í•˜ê¸° (ì˜ˆ: ë” ì°¨ê°‘ê²Œ)"><button type="submit" class="accent-bg text-white rounded-full p-3 hover:opacity-90"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.498z"/><path d="m15 5 4 4"/></svg></button>
                </form>
                <button id="save-scene-button" class="w-full bg-stone-200 text-stone-700 rounded-full py-2 px-5 hover:bg-stone-300">JPGë¡œ ì €ì¥í•˜ê¸°</button>
            </footer>
        </div>
    </div>
    <div id="tips-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div id="tips-to-capture" class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col" style="background-color: var(--bg-main);">
            <header class="p-4 border-b flex justify-between items-center" style="border-color: var(--border-color);">
                <h3 class="text-2xl font-serif">ğŸ’¡ AcTi ì—°ê¸° ì½”ì¹­</h3>
                <button id="close-tips-modal" class="p-2 -mr-2 text-2xl leading-none">&times;</button>
            </header>
            <div id="tips-content" class="flex-1 p-6 overflow-y-auto ai-generated-content"></div>
            <footer class="p-4 border-t bg-white text-center" style="border-color: var(--border-color);">
                <button id="save-tips-button" class="w-full bg-stone-200 text-stone-700 rounded-full py-2 px-5 hover:bg-stone-300">JPGë¡œ ì €ì¥í•˜ê¸°</button>
            </footer>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_KEY = "AIzaSyBbEsfDqt5ojPAJoo70Nozro4LacKk__4k"; 

        // --- DOM ELEMENTS ---
        const searchSection = document.getElementById('search-section');
        const searchInput = document.getElementById('actor-search-input');
        const searchButton = document.getElementById('search-button');
        const disambiguationSection = document.getElementById('disambiguation-section');
        const loadingSection = document.getElementById('loading-section');
        const loadingStatus = document.getElementById('loading-status');
        const errorSection = document.getElementById('error-section');
        const errorMessageEl = document.getElementById('error-message');
        const reportSection = document.getElementById('report-section');
        const finderResultsSection = document.getElementById('finder-results-section');
        const saveJpgButton = document.getElementById('save-jpg-button');
        const qnaButton = document.getElementById('qna-button');
        const qnaModal = document.getElementById('qna-modal');
        const closeQnaModalButton = document.getElementById('close-qna-modal');
        const qnaForm = document.getElementById('qna-form');
        const qnaInput = document.getElementById('qna-input');
        const qnaChatbox = document.getElementById('qna-chatbox');
        const sceneModal = document.getElementById('scene-modal');
        const closeSceneModalButton = document.getElementById('close-scene-modal');
        const sceneContent = document.getElementById('scene-content');
        const saveSceneButton = document.getElementById('save-scene-button');
        const sceneEditForm = document.getElementById('scene-edit-form');
        const sceneEditInput = document.getElementById('scene-edit-input');
        const tipsModal = document.getElementById('tips-modal');
        const closeTipsModalButton = document.getElementById('close-tips-modal');
        const tipsContent = document.getElementById('tips-content');
        const saveTipsButton = document.getElementById('save-tips-button');
        const finderModal = document.getElementById('finder-modal');
        const closeFinderModalButton = document.getElementById('close-finder-modal');
        const finderButton = document.getElementById('finder-button');
        const findRoleModelsButton = document.getElementById('find-rolemodels-button');
        const getActingTipsButton = document.getElementById('get-acting-tips-button');
        
        // --- GLOBAL STATE ---
        let currentActor = { name: null, reportHtml: null };
        saveJpgButton.disabled = true;
        
        // --- UTILITY FUNCTIONS ---
        function hideAllSections() {
            [searchSection, disambiguationSection, loadingSection, errorSection, reportSection, finderResultsSection].forEach(s => s.classList.add('hidden'));
        }
        function showSearchSection() {
            hideAllSections();
            searchInput.value = '';
            searchSection.classList.remove('hidden');
            saveJpgButton.disabled = true;
        }
        function showError(message) {
            hideAllSections();
            errorMessageEl.textContent = `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${message}. ë‹¤ë¥¸ ë°°ìš°ë¡œ ì‹œë„í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`;
            errorSection.classList.remove('hidden');
            searchSection.classList.remove('hidden');
        }

        // --- CORE LOGIC ---
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status >= 500 && response.status < 600) { throw new Error(`Server error: ${response.status}`); }
                    return response;
                } catch (error) {
                    if (i === retries - 1) { console.error("Fetch failed:", error); throw error; }
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
        }

        async function callGenerativeApi(systemPrompt, userQuery) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            
            if (!response.ok) {
                const errorBody = await response.json();
                console.error("AcTi API Error:", errorBody);
                throw new Error(`AcTi API í˜¸ì¶œ ì‹¤íŒ¨: ${errorBody.error?.message || response.status}`);
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];
            const text = candidate?.content?.parts?.[0]?.text;

            if (!text || (candidate && candidate.finishReason && candidate.finishReason !== "STOP")) {
                 let reason = candidate?.finishReason || 'ì•Œ ìˆ˜ ì—†ìŒ';
                 if (candidate?.finishReason === 'SAFETY') { reason = 'ì•ˆì „ ì„¤ì •ì— ì˜í•´ ì°¨ë‹¨ë¨'; }
                 throw new Error(`ì½˜í…ì¸  ìƒì„± ì‹¤íŒ¨ (ì‚¬ìœ : ${reason})`);
            }
            return text;
        }

        async function generateAIReport(actorName) {
            const systemPrompt = `ë‹¹ì‹ ì€ 'ë°°ìš°ê°€ ë°°ìš°ë¥¼ ì—°êµ¬í•˜ëŠ”' ê´€ì ì„ ì§€ë‹Œ ì„¸ê³„ ìµœê³ ì˜ ì—°ê¸° ì½”ì¹˜ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ë‹¨ìˆœí•œ ì •ë³´ ìš”ì•½ì´ ì•„ë‹ˆë¼, ë°°ìš° ì§€ë§ìƒì´ ì£¼ì–´ì§„ ë°°ìš°ë¥¼ 'ë¡¤ëª¨ë¸'ë¡œì„œ ì² ì €íˆ ë¶„ì„í•˜ê³ , ê·¸ì˜ ì—°ê¸° ê¸°ìˆ ê³¼ ì»¤ë¦¬ì–´ ì „ëµì„ ìì‹ ì˜ ê²ƒìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆë„ë¡ ë•ëŠ” ê²ƒì…ë‹ˆë‹¤. ìµœì‹  ë‰´ìŠ¤ë¥¼ ê²€ìƒ‰í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ê·¸ì˜ ì—°ê¸° ë³¸ì§ˆê³¼ ì„±ì¥ ê³¼ì •ì„ ë¶„ì„í•˜ì—¬ 'ë”°ë¼ ë°°ìš¸ ì 'ì„ ëª…í™•íˆ ì œì‹œí•´ì•¼ í•©ë‹ˆë‹¤. ìµœì¢… ê²°ê³¼ë¬¼ì€ ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ ì˜¤ì§ ë¦¬í¬íŠ¸ ë‚´ìš©ì´ ë‹´ê¸´ ë‹¨ì¼ HTML ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤. <h2>, <h3>, <p>, <ul>, <li>, <strong> ê°™ì€ íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚´ìš©ì„ êµ¬ì¡°í™”í•˜ì„¸ìš”. ì „ì²´ ì‘ë‹µì€ ì´ HTML ë¬¸ìì—´ì´ì–´ì•¼ í•˜ë©°, ë§ˆí¬ë‹¤ìš´ í˜•ì‹(\`\`\`)ìœ¼ë¡œ ê°ì‹¸ì§€ ë§ˆì„¸ìš”. ë³´ê³ ì„œ ì „ì²´ì—ì„œ 'AI'ë¼ëŠ” ë‹¨ì–´ ëŒ€ì‹  'AcTi'ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. ë¦¬í¬íŠ¸ì—ëŠ” ë°˜ë“œì‹œ ë‹¤ìŒì˜ ê´€ì ì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤: 1. **ë¡¤ëª¨ë¸ë¡œì„œì˜ í•µì‹¬ ê°€ì¹˜**: ì™œ ì´ ë°°ìš°ë¥¼ ë¡¤ëª¨ë¸ë¡œ ì‚¼ì•„ì•¼ í•˜ëŠ”ê°€? ê·¸ì˜ ì–´ë–¤ ì ì´ ë‹¤ë¥¸ ë°°ìš°ì™€ ì°¨ë³„í™”ë˜ëŠ”ê°€? 2. **'í›”ì¹˜ê³  ì‹¶ì€' ì—°ê¸° ê¸°ìˆ **: ê·¸ì˜ ëŒ€í‘œì ì¸ ì—°ê¸° í…Œí¬ë‹‰(ì‹œì„  ì²˜ë¦¬, ëª©ì†Œë¦¬ í†¤, ê°ì •ì˜ ì™„ê¸‰ ì¡°ì ˆ ë“±)ì„ êµ¬ì²´ì ì¸ ì‘í’ˆ ì¥ë©´ì„ ì˜ˆë¡œ ë“¤ì–´ ë¶„ì„í•˜ê³ , ì–´ë–»ê²Œ í›ˆë ¨í•´ì•¼ í•˜ëŠ”ì§€ ì„¤ëª…. 3. **í˜„ëª…í•œ ì»¤ë¦¬ì–´ ì„¤ê³„**: ê·¸ì˜ í•„ëª¨ê·¸ë˜í”¼ê°€ ì–´ë–»ê²Œ ê·¸ì˜ í˜ë¥´ì†Œë‚˜ë¥¼ êµ¬ì¶•í–ˆëŠ”ì§€, ê·¸ë¦¬ê³  ì‘í’ˆ ì„ íƒì˜ ê¸°ì¤€ì´ ë¬´ì—‡ì¸ì§€ ë¶„ì„í•˜ì—¬, ë°°ìš° ì§€ë§ìƒì´ ìì‹ ì˜ ì»¤ë¦¬ì–´ë¥¼ ì–´ë–»ê²Œ ì„¤ê³„í•´ì•¼ í• ì§€ì— ëŒ€í•œ í†µì°°ì„ ì œê³µ. 4. **ë‚´ë©´ì„ ì§€ë°°í•˜ëŠ” ì—°ê¸° ì² í•™**: ê·¸ì˜ ì¸í„°ë·°ë‚˜ í–‰ë³´ë¥¼ í†µí•´ ë“œëŸ¬ë‚œ ì—°ê¸°ì— ëŒ€í•œ íƒœë„ì™€ ë§ˆì¸ë“œì…‹ì„ ë¶„ì„í•˜ê³ , ì´ê²ƒì´ ê·¸ì˜ ì—°ê¸°ì— ì–´ë–»ê²Œ ë°˜ì˜ë˜ëŠ”ì§€ ì„¤ëª…. 5. **ë‚˜ë§Œì˜ ê²ƒìœ¼ë¡œ ë§Œë“œëŠ” Action Plan**: 'ì´ ë°°ìš°ì²˜ëŸ¼ ë˜ê¸° ìœ„í•´' ë‚´ì¼ë¶€í„° ë‹¹ì¥ ì‹¤ì²œí•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì´ê³  ë‹¨ê³„ì ì¸ í›ˆë ¨ ë°©ë²•ì„ ì œì‹œ. (ì˜ˆ: íŠ¹ì • ì˜í™”ì˜ ë…ë°± 100ë²ˆ ë”°ë¼í•˜ê¸°, ê·¸ì˜ ì¸í„°ë·° ì˜ìƒ í•„ì‚¬í•˜ê¸° ë“±)`;
            const userQuery = `'${actorName}' ë°°ìš°ì— ëŒ€í•œ ë¡¤ëª¨ë¸ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ HTML í˜•ì‹ìœ¼ë¡œ ìƒì„±í•´ì¤˜.`;
            return await callGenerativeApi(systemPrompt, userQuery);
        }
        
        async function fetchActorImage(actorName, qid = null) {
            const encodedName = encodeURIComponent(actorName || '');
            const placeholderUrl = `https://placehold.co/160x160/E5E0D9/4E443C?text=${encodedName}`;
            try {
                let fileName;
                if (qid) {
                    const qidApiUrl = `https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${qid}&format=json&props=claims&origin=*`;
                    const qidResponse = await fetch(qidApiUrl);
                    if (qidResponse.ok) {
                        const qidData = await qidResponse.json();
                        const imageClaim = qidData.entities[qid].claims?.P18;
                        if (imageClaim?.[0]) {
                            fileName = imageClaim[0].mainsnak.datavalue.value;
                        }
                    }
                }
                
                if(!fileName && actorName) {
                    for (const lang of ['ko', 'en']) {
                         try {
                            const wikiUrl = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodedName}`;
                            const response = await fetch(wikiUrl);
                            if (response.ok) {
                                const data = await response.json();
                                if (data.originalimage?.source) {
                                     const urlParts = data.originalimage.source.split('/');
                                     const decodedFileName = decodeURIComponent(urlParts[urlParts.length - 1]);
                                     if(data.originalimage.source.includes('commons')){
                                         fileName = decodedFileName;
                                         break;
                                     }
                                     return data.originalimage.source;
                                }
                            }
                        } catch (e) {}
                    }
                }

                if (fileName) {
                    const imageInfoUrl = `https://commons.wikimedia.org/w/api.php?action=query&titles=File:${encodeURIComponent(fileName)}&prop=imageinfo&iiprop=url&format=json&origin=*`;
                    const imageInfoResponse = await fetch(imageInfoUrl);
                    if (imageInfoResponse.ok) {
                        const imageInfoData = await imageInfoResponse.json();
                        const pages = imageInfoData.query.pages;
                        const pageId = Object.keys(pages)[0];
                        if (pageId !== "-1" && pages[pageId].imageinfo) {
                            return pages[pageId].imageinfo[0].url;
                        }
                    }
                }
            } catch (error) { console.error("Image fetch error:", error); }
            return placeholderUrl;
        }

        async function searchAndDisambiguate(actorName) {
            hideAllSections();
            loadingSection.classList.remove('hidden');
            loadingStatus.textContent = `'${actorName}' ê²€ìƒ‰ ì¤‘...`;
            try {
                const encodedName = encodeURIComponent(actorName);
                const url = `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodedName}&language=ko&format=json&props=description&type=item&origin=*`;
                const response = await fetch(url);
                const data = await response.json();
                const actors = (data.search || []).filter(item => {
                    if (!item.description) return false;
                    const desc = item.description.toLowerCase();
                    return desc.includes('ë°°ìš°') || desc.includes('actor') || desc.includes('actress') || desc.includes('ì—°ê¸°ì');
                });
                if (actors.length === 0) { throw new Error(`'${actorName}'ì— ëŒ€í•œ ë°°ìš° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); }
                else if (actors.length === 1) { await generateReport(actors[0].label, actors[0].id); }
                else { displayDisambiguation(actors); }
            } catch (error) { showError(error.message); }
            finally { loadingSection.classList.add('hidden'); }
        }
        function displayDisambiguation(actors) {
            hideAllSections();
            let content = `<h2 class="text-3xl md:text-4xl mb-4">ë™ëª…ì´ì¸ ë°°ìš°</h2><p class="mb-8">ë¶„ì„í•˜ê³  ì‹¶ì€ ë°°ìš°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p><div class="grid grid-cols-2 md:grid-cols-4 gap-4">`;
            actors.forEach(actor => {
                const placeholderUrl = `https://placehold.co/200x300/E5E0D9/4E443C?text=${encodeURIComponent(actor.label)}`;
                content += `<div class="actor-card cursor-pointer p-2 bg-white/50 rounded-lg hover:shadow-lg transition-shadow" data-name="${actor.label}" data-qid="${actor.id}"><img src="${placeholderUrl}" data-qid="${actor.id}" class="w-full h-48 object-cover rounded-md mb-2 bg-stone-200" alt="${actor.label}"><h4 class="font-bold text-primary">${actor.label}</h4><p class="text-sm text-secondary">${actor.description || ''}</p></div>`;
            });
            content += `</div>`;
            disambiguationSection.innerHTML = content;
            disambiguationSection.classList.remove('hidden');
            document.querySelectorAll('.actor-card').forEach(card => {
                const qid = card.dataset.qid;
                const img = card.querySelector('img');
                fetchActorImage(null, qid).then(url => img.src = url);
                card.addEventListener('click', () => { generateReport(card.dataset.name, card.dataset.qid); });
            });
        }
        async function generateReport(actorName, qid) {
            hideAllSections();
            loadingSection.classList.remove('hidden');
            const loadingMessages = ["í”„ë¡œí•„ ì‚¬ì§„ ê²€ìƒ‰ ì¤‘...", "ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...", "AcTiê°€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤..."];
            let msgIndex = 0;
            const interval = setInterval(() => { loadingStatus.textContent = loadingMessages[msgIndex++ % loadingMessages.length]; }, 2000);
            try {
                const imageUrl = await fetchActorImage(actorName, qid);
                const reportHtml = await generateAIReport(actorName);
                currentActor = { name: actorName, reportHtml: reportHtml };
                displayReport(imageUrl);
            } catch (error) { showError(error.message); }
            finally { clearInterval(interval); loadingSection.classList.add('hidden'); }
        }
        function displayReport(imageUrl) {
            const { name, reportHtml } = currentActor;
            const finalReportHtml = reportHtml || `<p class="text-center text-red-600">ì˜¤ë¥˜: ë¦¬í¬íŠ¸ ë‚´ìš©ì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
            reportSection.innerHTML = `
                <div id="report-to-capture" class="bg-white rounded-lg shadow-xl p-8 md:p-12 border fade-in-up">
                    <button id="back-to-search" class="accent-bg text-white text-sm py-2 px-4 rounded-full mb-8 hover:opacity-90">â† ë‹¤ë¥¸ ë°°ìš° ë¶„ì„í•˜ê¸°</button>
                    <header class="text-center mb-12">
                        <img src="${imageUrl}" alt="${name}" class="w-40 h-40 object-cover rounded-full mx-auto mb-4 shadow-lg border-4" style="border-color: var(--border-color);" onerror="this.onerror=null;this.src='https://placehold.co/160x160/E5E0D9/4E443C?text=${encodeURIComponent(name)}';">
                        <h1 class="text-5xl mb-2 font-serif">${name}</h1>
                        <h2 class="text-2xl text-stone-500 font-serif tracking-widest mt-2">ë¡¤ëª¨ë¸ ë¶„ì„ REPORT</h2>
                    </header>
                    <div id="report-content" class="ai-generated-content">${finalReportHtml}</div>
                    <div class="mt-12 text-center">
                        <button id="toggle-scene-options-button" class="accent-bg text-white font-bold py-3 px-6 rounded-full hover:opacity-90 text-lg">âœ¨ ë§ì¶¤ ëŒ€ë³¸ ìƒì„±í•˜ê¸°</button>
                        <div id="scene-options" class="hidden mt-4 grid grid-cols-2 sm:grid-cols-4 gap-2 max-w-lg mx-auto">
                           <button class="scene-genre-button bg-stone-100 text-stone-700 py-2 rounded-full hover:bg-stone-200">ë°°ìš° ê°•ì  ê·¹ëŒ€í™”</button>
                           <button class="scene-genre-button bg-stone-100 text-stone-700 py-2 rounded-full hover:bg-stone-200">ì¼ìƒ</button>
                           <button class="scene-genre-button bg-stone-100 text-stone-700 py-2 rounded-full hover:bg-stone-200">ê°ì„±/ìŠ¬í””</button>
                           <button class="scene-genre-button bg-stone-100 text-stone-700 py-2 rounded-full hover:bg-stone-200">ë¡œë§¨ìŠ¤</button>
                           <button class="scene-genre-button bg-stone-100 text-stone-700 py-2 rounded-full hover:bg-stone-200">ì½”ë¯¹/ë°ìŒ</button>
                           <button class="scene-genre-button bg-stone-100 text-stone-700 py-2 rounded-full hover:bg-stone-200">ì¥ë¥´/ì–´ë‘ì›€</button>
                           <button class="scene-genre-button bg-stone-100 text-stone-700 py-2 rounded-full hover:bg-stone-200">ìŠ¤ë¦´ëŸ¬</button>
                           <button class="scene-genre-button bg-stone-100 text-stone-700 py-2 rounded-full hover:bg-stone-200">ì‚¬ê·¹</button>
                        </div>
                    </div>
                </div>`;
            reportSection.classList.remove('hidden');
            saveJpgButton.disabled = false;
            document.getElementById('back-to-search').addEventListener('click', showSearchSection);
            document.getElementById('toggle-scene-options-button').addEventListener('click', () => document.getElementById('scene-options').classList.toggle('hidden'));
            document.querySelectorAll('.scene-genre-button').forEach(button => {
                button.addEventListener('click', () => generateAuditionScene(name, reportHtml, button.textContent));
            });
        }
        async function captureAndSave(elementId, fileName, buttonId) {
            const elementToCapture = document.getElementById(elementId);
            const button = document.getElementById(buttonId);
            if (!elementToCapture || !button) return;
            button.disabled = true;
            const originalButtonText = button.textContent;
            button.textContent = 'ì´ë¯¸ì§€ ìƒì„± ì¤‘...';
            const originalMaxHeight = elementToCapture.style.maxHeight;
            elementToCapture.style.maxHeight = 'none';
            try {
                await new Promise(resolve => setTimeout(resolve, 100));
                const canvas = await html2canvas(elementToCapture, { scale: 3, useCORS: true, backgroundColor: getComputedStyle(elementToCapture).getPropertyValue('background-color') });
                const link = document.createElement('a');
                link.download = fileName;
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();
            } catch (err) { console.error("JPG ì €ì¥ ì˜¤ë¥˜:", err); alert("ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
            finally {
                elementToCapture.style.maxHeight = originalMaxHeight;
                button.disabled = false;
                button.textContent = originalButtonText;
            }
        }
        async function generateAuditionScene(actorName, reportHtml, genre, existingScene = null, editRequest = null) {
            sceneModal.classList.remove('hidden');
            sceneContent.innerHTML = `<div class="flex items-center justify-center h-full"><div class="w-12 h-12 border-4 border-stone-200 rounded-full animate-spin" style="border-top-color: var(--accent-color);"></div></div>`;
            saveSceneButton.disabled = true;
            let systemPrompt, userQuery;
            if (existingScene && editRequest) {
                systemPrompt = `ë‹¹ì‹ ì€ ì°½ì˜ì ì¸ ì‹œë‚˜ë¦¬ì˜¤ ì‘ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ëŒ€ë³¸ì„ ì‚¬ìš©ìì˜ ìš”ì²­ì— ë§ê²Œ ìˆ˜ì •í•©ë‹ˆë‹¤. ë°˜ë“œì‹œ ì´ì „ ëŒ€ë³¸ì˜ ë§¥ë½ê³¼ í˜•ì‹ì„ ìœ ì§€í•˜ë©´ì„œ, ìš”ì²­ì‚¬í•­ë§Œ ë°˜ì˜í•˜ì—¬ ì™„ì„±ëœ ì „ì²´ ëŒ€ë³¸ì„ ë‹¤ì‹œ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. ìµœì¢… ê²°ê³¼ë¬¼ì€ ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ ì˜¤ì§ ì™„ì„±ëœ ëŒ€ë³¸ HTML ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤. ì½”ë“œ ë¸”ë¡ ë§ˆì»¤ë‚˜ ë¶ˆí•„ìš”í•œ ì„¤ëª…ì„ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.`;
                userQuery = `ê¸°ì¡´ ëŒ€ë³¸:\n\n${existingScene}\n\nì‚¬ìš©ì ìˆ˜ì • ìš”ì²­: "${editRequest}"\n\nìœ„ ìš”ì²­ì„ ë°˜ì˜í•˜ì—¬ ì „ì²´ ëŒ€ë³¸ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”.`;
            } else {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = reportHtml;
                const reportText = (tempDiv.textContent || "").replace(/\s\s+/g, ' ').substring(0, 1500);
                systemPrompt = `ë‹¹ì‹ ì€ ì°½ì˜ì ì¸ ì‹œë‚˜ë¦¬ì˜¤ ì‘ê°€ì…ë‹ˆë‹¤. ë°°ìš° ì§€ë§ìƒì„ ìœ„í•´, íŠ¹ì • ë°°ìš°ì˜ ê°•ì ì„ ê·¹ëŒ€í™”í•  ìˆ˜ ìˆëŠ” **1ë¶„~1ë¶„ 30ì´ˆ ë¶„ëŸ‰ì˜ ì˜¤ë””ì…˜ìš© ì¥ë©´**ì„ ì‘ì„±í•©ë‹ˆë‹¤. ìµœì¢… ê²°ê³¼ë¬¼ì€ ì‹¤ì œ ëŒ€ë³¸ì²˜ëŸ¼ ì„œì‹ì´ ì§€ì •ëœ, ìˆœìˆ˜í•œ ë‹¨ì¼ HTML ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤. ì½”ë“œ ë¸”ë¡ ë§ˆì»¤(\`\`\`)ë¥¼ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”. ë‹¤ìŒ ê·œì¹™ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•˜ì„¸ìš”: 1. **ì°½ì˜ì„±**: ë§¤ë²ˆ ì´ì „ê³¼ëŠ” ë‹¤ë¥¸ ë…ì°½ì ì¸ ìƒí™©ì„ êµ¬ìƒí•´ì•¼ í•©ë‹ˆë‹¤. ë°°ìš°ì˜ ê°€ì¥ ëŒ€í‘œì ì¸ ì´ë¯¸ì§€ë§Œ ë°˜ë³µí•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ê·¸ì˜ ë‹¤ë¥¸ ì‘í’ˆì´ë‚˜ ì•Œë ¤ì§€ì§€ ì•Šì€ ë§¤ë ¥ì„ íƒêµ¬í•˜ì—¬ ì‹ ì„ í•œ ìºë¦­í„°ì™€ ë°°ê²½ì„ ì°½ì¡°í•´ì•¼ í•©ë‹ˆë‹¤. 2. **ë¶„ëŸ‰**: ëŒ€ì‚¬ëŸ‰ì´ ì¶©ë¶„í•˜ì—¬ ë°°ìš°ê°€ 1ë¶„ ì´ìƒ ì—°ê¸°í•  ìˆ˜ ìˆë„ë¡ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤. 3. **ì§€ë¬¸**: ëŒ€ì‚¬ ì•ˆì˜ ì—°ê¸° ì§€ë¬¸ì€ <em>(ê´„í˜¸ ì•ˆì—)</em> ì´íƒ¤ë¦­ì²´ë¡œ ì‘ì„±í•˜ë˜, **ê¸¸ê³  ì„œìˆ ì ì¸ ì„¤ëª…ì€ í”¼í•˜ê³ , í–‰ë™ì´ë‚˜ ê°ì •ì˜ í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ** í‘œí˜„í•´ì•¼ í•©ë‹ˆë‹¤. (ì˜ˆ: '<em>(ì ì‹œ ì¹¨ë¬µ)</em>', '<em>(ëª©ì†Œë¦¬ê°€ ì‚´ì§ ë–¨ë¦¬ë©°)</em>'). 4. **ì–¸ì–´**: ì¸ë¬¼ ì„¤ëª…ê³¼ ì´ë¦„ì€ ì˜¤ì§ í•œê¸€ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”. 5. **ëŒ€ë³¸ í˜•ì‹**: ì¸ë¬¼ ì´ë¦„ì€ <strong> íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³¼ë“œì²´ë¡œ, ëŒ€ì‚¬ëŠ” ë‹¤ìŒ ì¤„ì— ë“¤ì—¬ì“°ê¸° ëœ í˜•ì‹ìœ¼ë¡œ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. (ì˜ˆ: '<p><strong>ê¹€ì˜ê°</strong></p><p style="padding-left: 1.5rem;">...ëŒ€ì‚¬...</p>'). 6. **ì¤„ë°”ê¿ˆ**: ê¸´ ëŒ€ì‚¬ëŠ” ì˜ë¯¸ ë‹¨ìœ„ë¡œ <br> íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì—¬ì£¼ì„¸ìš”.`;
                userQuery = `ë‹¤ìŒì€ '${actorName}' ë°°ìš°ì— ëŒ€í•œ ë¶„ì„ì…ë‹ˆë‹¤. ì´ ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ, **'${genre}' ìŠ¤íƒ€ì¼**ì„ ê°•ì¡°í•˜ì—¬ ê·¸ì˜ ì—°ê¸°ë ¥ì„ ê°€ì¥ ì˜ ë³´ì—¬ì¤„ ìˆ˜ ìˆëŠ” **1ë¶„~1ë¶„ 30ì´ˆ ë¶„ëŸ‰**ì˜ ì˜¤ë¦¬ì§€ë„ ì˜¤ë””ì…˜ ì¥ë©´ì„ HTML í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\në¶„ì„ ë‚´ìš©: "${reportText}"`;
            }
            try {
                const sceneHtml = await callGenerativeApi(systemPrompt, userQuery);
                sceneContent.innerHTML = sceneHtml;
                saveSceneButton.disabled = false;
            } catch (error) { sceneContent.innerHTML = `<p class="text-red-700 text-center">ì£„ì†¡í•©ë‹ˆë‹¤. ëŒ€ë³¸ì„ ìƒì„±í•˜ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`; }
        }
        async function generateActingTips(actorName, sceneHtml) {
            tipsModal.classList.remove('hidden');
            tipsContent.innerHTML = `<div class="flex items-center justify-center h-full"><div class="w-12 h-12 border-4 border-stone-200 rounded-full animate-spin" style="border-top-color: var(--accent-color);"></div></div>`;
            const systemPrompt = `ë‹¹ì‹ ì€ 'AcTi' ì—°ê¸° ì½”ì¹˜ì…ë‹ˆë‹¤. ì„œë¡ ì´ë‚˜ ê²°ë¡ , ì¸ì‚¬ ì—†ì´ ë°”ë¡œ í•µì‹¬ ì—°ê¸° íŒ ë¶„ì„ìœ¼ë¡œ ë“¤ì–´ê°€ì„¸ìš”. ì£¼ì–´ì§„ ëŒ€ë³¸ê³¼ ë¡¤ëª¨ë¸ ë°°ìš° ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ë°°ìš° ì§€ë§ìƒì´ ì—°ê¸° ì—°ìŠµì— ë°”ë¡œ ì ìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì´ê³  ì‹¤ì§ˆì ì¸ ì½”ì¹­ì„ ì œê³µí•©ë‹ˆë‹¤. ë¡¤ëª¨ë¸ ë°°ìš°ë¼ë©´ ì´ ì¥ë©´ì„ ì–´ë–»ê²Œ í•´ì„í•˜ê³  í‘œí˜„í• ì§€, ê·¸ì˜ ìŠ¤íƒ€ì¼ì„ ì–´ë–»ê²Œ ë…¹ì—¬ë‚¼ ìˆ˜ ìˆì„ì§€ ìƒì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”. (ì˜ˆ: '${actorName}' ë°°ìš° íŠ¹ìœ ì˜ ì‹œì„  ì²˜ë¦¬, ëª©ì†Œë¦¬ í†¤, ì¹¨ë¬µ í™œìš©ë²• ë“±). ìµœì¢… ê²°ê³¼ë¬¼ì€ ì˜¤ì§ ì—°ê¸° íŒì— ëŒ€í•œ ë‚´ìš©ë§Œ ë‹´ê¸´ HTML ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤. <h3>, <p>, <ul>, <li>, <strong> íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚´ìš©ì„ êµ¬ì¡°í™”í•˜ê³ , ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`;
            const userQuery = `ì´ ì˜¤ë””ì…˜ ëŒ€ë³¸ì€ '${actorName}' ë°°ìš°ë¥¼ ë¡¤ëª¨ë¸ë¡œ ì‚¼ëŠ” í•™ìƒì„ ìœ„í•œ ê²ƒì…ë‹ˆë‹¤. '${actorName}' ë°°ìš°ì˜ ì…ì¥ì—ì„œ ì´ ëŒ€ë³¸ì„ ì–´ë–»ê²Œ ì—°ê¸°í•´ì•¼ í• ì§€ì— ëŒ€í•œ êµ¬ì²´ì ì´ê³  ì „ë¬¸ì ì¸ ì—°ê¸° íŒì„ HTML í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\nëŒ€ë³¸:\n${sceneHtml}`;
            try {
                const tipsHtml = await callGenerativeApi(systemPrompt, userQuery);
                tipsContent.innerHTML = tipsHtml;
            } catch (error) { tipsContent.innerHTML = `<p class="text-red-700 text-center">ì£„ì†¡í•©ë‹ˆë‹¤. ì—°ê¸° íŒì„ ìƒì„±í•˜ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`; }
        }
        async function getQnaResponse(question) { 
            const systemPrompt = "ë‹¹ì‹ ì€ 'AcTi'ë¼ëŠ” ì´ë¦„ì„ ê°€ì§„ ì—°ê¸° ì „ë¬¸ ì½”ì¹˜ì…ë‹ˆë‹¤. ë°°ìš° ì§€ë§ìƒì˜ ì§ˆë¬¸ì— ëŒ€í•´ ë‹¤ë¥¸ ì¸ì‚¬ë‚˜ ë§ˆë¬´ë¦¬ ë©˜íŠ¸ ì—†ì´ í•µì‹¬ì ì¸ ë‹µë³€ë§Œ ê°„ê²°í•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ ì œê³µí•˜ì„¸ìš”. ë‹¹ì‹ ì˜ ì´ë¦„ì€ 'AcTi'ì´ë©°, 'AI'ë¼ëŠ” ë‹¨ì–´ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. ë‹µë³€ì€ í•­ìƒ í•œêµ­ì–´ë¡œ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. ìµœì¢… ê²°ê³¼ë¬¼ì€ ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ ì˜¤ì§ ë‹µë³€ ë‚´ìš©ì´ ë‹´ê¸´ ë‹¨ì¼ HTML ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤. <p>, <ul>, <li>, <strong> íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„± ì¢‹ê²Œ ë‚´ìš©ì„ êµ¬ì¡°í™”í•˜ê³ , ì„¹ì…˜ì„ êµ¬ë¶„í•´ì£¼ì„¸ìš”. ë§ˆí¬ë‹¤ìš´ í˜•ì‹(**)ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.";
            return await callGenerativeApi(systemPrompt, question);
        }
        function appendMessage(sender, message) {
            const isUser = sender === 'user';
            const messageHtml = isUser ? `<div class="flex items-start gap-3 justify-end"><div class="bg-accent-color text-white rounded-lg p-3 max-w-lg shadow-sm"><p class="text-sm"><strong class="font-bold text-white/80">Q.</strong> ${message}</p></div></div>` : `<div class="flex items-start gap-3"><div class="accent-bg text-white text-sm rounded-full h-8 w-8 flex-shrink-0 flex items-center justify-center font-bold">A</div><div class="bg-white rounded-lg p-3 max-w-lg shadow-sm border text-sm ai-generated-content" style="border-color: var(--border-color);">${message}</div></div>`;
            qnaChatbox.innerHTML += messageHtml;
            qnaChatbox.scrollTop = qnaChatbox.scrollHeight;
        }
        async function findRoleModels() {
            finderModal.classList.add('hidden');
            hideAllSections();
            loadingSection.classList.remove('hidden');
            loadingStatus.textContent = `ë‚˜ì˜ ì„±í–¥ì„ ë¶„ì„í•˜ì—¬ ë¡¤ëª¨ë¸ì„ ì°¾ëŠ” ì¤‘...`;
            const selectedGender = document.querySelector('#finder-gender .selected')?.textContent;
            const selectedAge = document.querySelector('#finder-age .selected')?.textContent;
            const selectedStyles = [...document.querySelectorAll('#finder-style .selected')].map(el => el.textContent);
            const systemPrompt = `ë‹¹ì‹ ì€ ì„¸ê³„ ìµœê³ ì˜ ìºìŠ¤íŒ… ë””ë ‰í„° AcTiì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì„ íƒí•œ ì¡°ê±´(ì„±ë³„, ì—°ë ¹ëŒ€, ì—°ê¸° ìŠ¤íƒ€ì¼)ì— ë§ëŠ” ëŒ€í•œë¯¼êµ­ ë°°ìš° 5ëª…ì„ ì¶”ì²œí•©ë‹ˆë‹¤. ìµœì¢… ê²°ê³¼ëŠ” ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ ì˜¤ì§ JSON ë°°ì—´ í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤. ê° ê°ì²´ëŠ” 'name'ê³¼ 'description' í‚¤ë¥¼ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤. ì˜ˆ: [{"name": "ì†¡ê°•í˜¸", "description": "1967ë…„ìƒ ëŒ€í•œë¯¼êµ­ ë‚¨ì ë°°ìš°"}, ...]`;
            let userQuery = "ë‹¤ìŒ ì¡°ê±´ì— ë§ëŠ” ë¡¤ëª¨ë¸ ë°°ìš° 5ëª…ì„ ì¶”ì²œí•´ì¤˜:\n";
            if (selectedGender) userQuery += `- ì„±ë³„: ${selectedGender}\n`;
            if (selectedAge) userQuery += `- ì—°ë ¹ëŒ€: ${selectedAge}\n`;
            if (selectedStyles.length > 0) userQuery += `- ì—°ê¸° ìŠ¤íƒ€ì¼: ${selectedStyles.join(', ')}\n`;
            try {
                const resultText = await callGenerativeApi(systemPrompt, userQuery);
                const startIndex = resultText.indexOf('[');
                const endIndex = resultText.lastIndexOf(']');
                if (startIndex === -1 || endIndex === -1) { throw new Error("AcTiê°€ ìœ íš¨í•œ ë°°ìš° ëª©ë¡ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
                const jsonString = resultText.substring(startIndex, endIndex + 1);
                const actors = JSON.parse(jsonString);
                displayFinderResults(actors);
            } catch (error) { showError(`ë¡¤ëª¨ë¸ ì¶”ì²œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ${error.message}`); }
            finally { loadingSection.classList.add('hidden'); }
        }
        function displayFinderResults(actors) {
            hideAllSections();
            let content = `<h2 class="text-3xl md:text-4xl mb-4">AcTi ì¶”ì²œ ë¡¤ëª¨ë¸</h2><p class="mb-8">ë‚˜ì˜ ì„±í–¥ê³¼ ì˜ ë§ëŠ” ë¡¤ëª¨ë¸ ë°°ìš°ì…ë‹ˆë‹¤.</p><div class="grid grid-cols-2 md:grid-cols-4 gap-4">`;
            actors.forEach(actor => {
                const placeholderUrl = `https://placehold.co/200x300/E5E0D9/4E443C?text=${encodeURIComponent(actor.name)}`;
                content += `<div class="actor-card cursor-pointer p-2 bg-white/50 rounded-lg hover:shadow-lg transition-shadow" data-name="${actor.name}"><img src="${placeholderUrl}" class="w-full h-48 object-cover rounded-md mb-2 bg-stone-200" alt="${actor.name}"><h4 class="font-bold text-primary">${actor.name}</h4><p class="text-sm text-secondary">${actor.description || ''}</p></div>`;
            });
            content += `</div>`;
            finderResultsSection.innerHTML = content;
            finderResultsSection.classList.remove('hidden');
            document.querySelectorAll('.actor-card').forEach(card => {
                const img = card.querySelector('img');
                const actorName = card.dataset.name;
                fetchActorImage(actorName).then(url => img.src = url);
                card.addEventListener('click', () => { searchAndDisambiguate(actorName); });
            });
        }
        
        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            searchButton.addEventListener('click', () => {
                const actorName = searchInput.value.trim();
                if (actorName) searchAndDisambiguate(actorName);
            });
            searchInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    const actorName = searchInput.value.trim();
                    if (actorName) searchAndDisambiguate(actorName);
                }
            });

            saveJpgButton.addEventListener('click', () => captureAndSave('report-to-capture', `AcTi_Report_${currentActor.name}.jpg`, 'save-jpg-button'));
            saveSceneButton.addEventListener('click', () => captureAndSave('scene-to-capture', `AcTi_Scene_${currentActor.name}.jpg`, 'save-scene-button'));
            saveTipsButton.addEventListener('click', () => captureAndSave('tips-to-capture', `AcTi_Tips_${currentActor.name}.jpg`, 'save-tips-button'));

            qnaButton.addEventListener('click', () => qnaModal.classList.remove('hidden'));
            closeQnaModalButton.addEventListener('click', () => qnaModal.classList.add('hidden'));
            
            closeSceneModalButton.addEventListener('click', () => sceneModal.classList.add('hidden'));
            getActingTipsButton.addEventListener('click', () => {
                const sceneHtml = sceneContent.innerHTML;
                if (currentActor.name && sceneHtml) generateActingTips(currentActor.name, sceneHtml);
            });
            
            closeTipsModalButton.addEventListener('click', () => tipsModal.classList.add('hidden'));

            finderButton.addEventListener('click', () => finderModal.classList.remove('hidden'));
            closeFinderModalButton.addEventListener('click', () => finderModal.classList.add('hidden'));
            findRoleModelsButton.addEventListener('click', findRoleModels);

            document.querySelectorAll('.finder-option-button').forEach(button => {
                button.addEventListener('click', () => {
                    const group = button.dataset.group;
                    if (group === 'style') {
                        const selectedCount = document.querySelectorAll(`#finder-style .selected`).length;
                        if (button.classList.contains('selected')) {
                            button.classList.remove('selected');
                        } else if (selectedCount < 3) {
                            button.classList.add('selected');
                        }
                    } else {
                        document.querySelectorAll(`[data-group="${group}"]`).forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                    }
                });
            });

            qnaForm.addEventListener('submit', async (e) => { 
                e.preventDefault();
                const question = qnaInput.value.trim();
                if (!question) return;
                appendMessage('user', question);
                qnaInput.value = '';
                qnaForm.querySelector('button').disabled = true;
                try {
                    const response = await getQnaResponse(question);
                    appendMessage('acti', response);
                } catch(error) {
                    appendMessage('acti', `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                } finally {
                    qnaForm.querySelector('button').disabled = false;
                }
            });
            
            sceneEditForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const editRequest = sceneEditInput.value.trim();
                if (!editRequest) return;
                const existingScene = sceneContent.innerHTML;
                generateAuditionScene(currentActor.name, null, 'ìˆ˜ì •', existingScene, editRequest);
                sceneEditInput.value = '';
            });
        }
        
        setupEventListeners();
    </script>
</body>
</html>

