<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AcTi 이미지 컨설팅 (관리자용)</title>
  <meta name="color-scheme" content="dark" />

  <!-- 캐시 방지용 메타 태그 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <!-- 홈 화면 전체화면 실행 (주소창 숨기기) -->
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- 홈 화면 아이콘 및 파비콘 설정 -->
  <link rel="apple-touch-icon" sizes="180x180" href="acti-logo.jpg">
  <link rel="icon" type="image/jpeg" sizes="32x32" href="acti-logo.jpg">
  <link rel="icon" type="image/jpeg" sizes="16x16" href="acti-logo.jpg">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 화면 캡처 라이브러리 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- PDF.js 라이브러리 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <!-- SRT Parser 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/srt-parser-2@1.1.6/dist/srt-parser-2.min.js"></script>
  <style>
    :root{
      --bg:#141414;--paper:#1F1F1F;--card:#2A2A2A;--ink:#F5F5F5;--sub:#A0A0A0;--accent:#E50914;--accent-2:#B20710;--ring:rgba(229, 9, 20, 0.5);--line:#3A3A3A;--shadow-1: 0 8px 25px rgba(0,0,0,.5);--inner: inset 0 1px 0 rgba(255,255,255,.1), inset 0 -1px 0 rgba(0,0,0,.2);
    }
    html, body { height: 100%; }
    body{font-family:'Noto Sans KR', system-ui, sans-serif;color:var(--ink);background-color:var(--bg);}
    .container{max-width:920px;margin:0 auto;padding:24px;}
    .hero{border-radius:28px;background:var(--card);box-shadow:var(--shadow-1);padding:24px;display:flex;align-items:center;gap:16px;border:1px solid var(--line);position:relative;overflow:hidden;}
    .avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;background-color:#333;box-shadow:0 4px 10px rgba(0,0,0,.3);}
    .panel{border-radius:22px;background:var(--card);border:1px solid var(--line);box-shadow:var(--shadow-1);padding:20px;}
    #feelsCard,#hairCard,#skinCard,#makeupCard,#dosCard,.pro-card{border-radius:22px;background:var(--paper);border:1px solid var(--line);box-shadow:var(--shadow-1);padding:20px;}
    .section-title{font-weight:600;font-size:1.05rem;}
    .label{color:var(--sub);font-size:.85rem;}
    .input-field{width:100%;background-color:var(--paper);border:1px solid var(--line);border-radius:12px;padding:10px 12px;color:var(--ink);transition:all .2s ease;}
    .input-field:focus{outline:none;border-color:var(--accent-2);box-shadow:0 0 0 4px var(--ring);}
    select.input-field option[value=""]{color:var(--sub);}
    select.input-field{-webkit-appearance:none;-moz-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23A0A0A0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1.05rem;border-radius:14px;border:1px solid rgba(255,255,255,.1);box-shadow:var(--inner), 0 6px 18px rgba(0,0,0,.2);font-weight:600;transition:all .18s ease;cursor:pointer;}
    .btn:focus{outline:none;box-shadow:0 0 0 4px var(--ring), var(--inner), 0 6px 18px rgba(0,0,0,.2);}
    .btn:hover{transform:translateY(-1px);}
    .btn:active{transform:translateY(0);}
    .btn-primary{background:var(--accent);color:#fff;border-color:var(--accent-2);}
    .btn-primary:hover{background:var(--accent-2);}
    .btn-ghost{background:var(--line);color:var(--ink);}
    .btn-ghost:hover{background:#4a4a4a;}
    .btn-icon{width:52px;height:52px;padding:0;border-radius:18px;}
    .btn-icon svg{width:24px;height:24px;}
    .file-wrap{display:flex;gap:1rem;flex-wrap:wrap;}
    .file-input{display:none;}
    .preview-container{display:flex;gap:.5rem;width:100%;border-radius:20px;background:var(--bg);border:1px solid var(--line);padding:.5rem;overflow-x:auto;overflow-y:hidden;height:180px; align-items: center;}
    .preview-item{height:100%;aspect-ratio:1 / 1;border-radius:16px;overflow:hidden;position:relative;flex-shrink:0;}
    .preview-item img{width:100%;height:100%;object-fit:cover;}
    .preview-item.is-best::after{content:'BEST';position:absolute;top:8px;right:8px;background:var(--accent);color:#fff;padding:2px 8px;font-size:12px;font-weight:bold;border-radius:8px;}
    .pill{display:inline-block;padding:.2rem .55rem;border-radius:999px;background:var(--line);border:1px solid #555;color:var(--ink);font-size:.78rem;margin:.1rem .2rem .1rem 0;}
    .result-card-title{display:inline-block;background:var(--accent);color:#fff;padding:6px 14px;border-radius:12px;font-weight:600;font-size:.9rem;margin-bottom:1rem;}
    .pro-card-title{display:flex;align-items:center;gap:.6rem;font-weight:600;font-size:1.1rem;color:var(--ink);margin-bottom:1rem;}
    .pro-card-title svg{width:22px;height:22px;stroke-width:2.5;color:var(--accent);}
    .result-card-body{font-size:.95rem;color:var(--sub); white-space: pre-wrap;}
    .result-card-body ul{padding-left:4px;}
    .sub-label{font-weight:600;font-size:.9rem;color:var(--ink);margin-bottom:4px;}
    .lookbook-card{border-left:4px solid var(--accent);padding-left:1rem;}
    .progress-bar-bg{background-color:var(--line);border-radius:999px;overflow:hidden;}
    .progress-bar{background-color:var(--accent);height:100%;border-radius:999px;transition:width 1s ease-in-out;}
  </style>
</head>
<body>
  <main class="container">
    <!-- HERO -->
    <section class="hero">
      <img src="acti-logo.jpg" alt="AcTi Logo" class="avatar">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">AcTi 이미지 컨설팅</h1>
        <p class="label mt-1">준비된 엔터, 준비된 배우</p>
      </div>
    </section>

    <!-- 업로드 & 매칭 -->
    <section class="panel mt-5">
      <div class="grid md:grid-cols-2 gap-5 items-start">
        <div>
           <h2 class="section-title mb-4">Take your picture</h2>
            <div class="file-wrap">
                <label for="fileInput" class="btn btn-ghost btn-icon" title="사진 1장 분석">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                </label>
                <label for="compareFileInput" class="btn btn-ghost btn-icon" title="여러 장 비교 분석">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                </label>
                <button id="clearBtn" class="btn btn-ghost btn-icon" title="지우기">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
                <button id="saveBtn" class="btn btn-ghost btn-icon" title="저장하기">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                </button>
            </div>
            <button id="analyzeBtn" class="btn btn-primary w-full mt-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M15 4V2"></path><path d="M15 10V8"></path><path d="M12.5 7H17.5"></path><path d="M12.5 13H17.5"></path><path d="M10 22l-3-3 9-9 3 3-9 9z"></path></svg>
                분석하기
            </button>
          <input id="fileInput" class="file-input" type="file" accept="image/*"/>
          <input id="compareFileInput" class="file-input" type="file" accept="image/*" multiple/>
        </div>
        <div>
          <div id="previewContainer" class="preview-container">
            <div id="placeholder" class="label text-center w-full">Webflix, 오늘 나의 습관이 내일의 미래를 결정한다</div>
          </div>
        </div>
      </div>
      
      <!-- Works Analysis (collapsible) -->
      <div class="mt-4 border-t border-[color:var(--line)] pt-4">
        <details id="works-details">
            <summary class="section-title cursor-pointer select-none">Works Analysis (선택 사항)</summary>
            <div class="mt-4 grid md:grid-cols-2 gap-x-5 gap-y-4">
                <div class="space-y-4">
                    <label for="scriptFileInput" class="btn btn-ghost w-full" title="대본 파일 첨부">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                      <span id="scriptFileName">대본 파일 (srt, pdf, txt)</span>
                    </label>
                    <input id="scriptFileInput" class="file-input" type="file" accept=".srt,.pdf,.txt"/>
                    <input id="roleName" type="text" class="input-field" placeholder="배역 이름">
                </div>
                <div>
                     <textarea id="scriptDesc" class="input-field h-full" placeholder="기타 설명 (대본 요약, 캐릭터 특징 등)"></textarea>
                </div>
            </div>
        </details>
      </div>

      <!-- Actor Matching (collapsible) -->
      <div class="mt-2 border-t border-[color:var(--line)] pt-4">
        <details id="matching-details">
            <summary class="section-title cursor-pointer select-none">Actor Matching (선택 사항)</summary>
            <div class="mt-4 grid md:grid-cols-2 gap-x-5 gap-y-3">
                <div class="space-y-3">
                    <select id="age" class="input-field"><option value="">연령대</option><option value="10대">10대</option><option value="20대">20대</option><option value="30대">30대</option><option value="40대">40대</option><option value="50대">50대</option><option value="60대 이상">60대 이상</option></select>
                    <select id="gender" class="input-field"><option value="">성별</option><option value="남자">남자</option><option value="여자">여자</option></select>
                    <select id="genre" class="input-field"><option value="">장르</option><option value="드라마">드라마</option><option value="로맨스">로맨스</option><option value="코미디">코미디</option><option value="액션/느와르">액션/느와르</option><option value="스릴러/미스터리">스릴러/미스터리</option><option value="판타지/SF">판타지/SF</option><option value="사극">사극</option></select>
                    <select id="job" class="input-field"><option value="">직업</option><option value="전문직 (의사, 변호사 등)">전문직</option><option value="사무직 (회사원 등)">사무직</option><option value="예술가 (화가, 작가 등)">예술가</option><option value="학생">학생</option><option value="형사/경찰">형사/경찰</option><option value="운동선수">운동선수</option><option value="자영업자">자영업자</option></select>
                </div>
                <div>
                     <textarea id="character-desc" class="input-field h-full" placeholder="캐릭터 설명"></textarea>
                </div>
            </div>
        </details>
      </div>
    </section>

    <!-- 결과 -->
    <section id="resultSection" class="mt-5 hidden">
      <div class="flex items-center justify-between"><h2 class="text-2xl font-bold tracking-tight">컨설팅 리포트</h2></div>
      <div id="photoComparisonResultSection" class="mt-4"></div>
      <div id="worksAnalysisResultSection" class="mt-4"></div>
      <div id="matchingResultSection" class="mt-4"></div>
      <div id="summary" class="mt-4 p-4 text-center rounded-xl border border-[color:var(--line)] bg-[var(--paper)]"></div>
      <div id="actorFocusSection" class="mt-6 space-y-4"></div>
      <hr class="my-8 border-t-2 border-dashed border-[color:var(--line)]">
      <h3 class="text-xl font-bold tracking-tight mb-4">상세 분석</h3>
      <div class="grid md:grid-cols-2 gap-4"><div id="feelsCard"></div><div id="hairCard"></div><div id="skinCard"></div><div id="makeupCard"></div></div>
      <div id="dosCard" class="mt-4"></div>
    </section>

    <!-- 로딩 & 메시지 -->
    <div id="overlay" class="fixed inset-0 hidden bg-black/75 grid place-items-center z-50">
        <div id="loadingIndicator" class="panel w-[320px] text-center"><div class="mx-auto mb-3 w-10 h-10 rounded-full border-4 border-[color:var(--accent)] border-t-transparent animate-spin"></div><div class="font-medium">이미지컨설팅 분석중입니다</div><div class="label mt-1">이미지 크기에 따라 수 초가 걸릴 수 있습니다.</div></div>
        <div id="messageBox" class="panel w-[320px] text-center hidden"><h3 class="font-medium text-lg mb-2">알림</h3><p id="messageText" class="mb-4"></p><button id="messageCloseBtn" class="btn btn-primary">확인</button></div>
    </div>
  </main>

  <script>
    // PDF.js worker 설정
    if (window.pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;
    }
    const $ = (sel) => document.querySelector(sel);
    
    // --- 설정 ---
    const API_KEYS = {
        GEMINI: 'AIzaSyBbEsfDqt5ojPAJoo70Nozro4LacKk__4k',
        OPENAI: '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'
    };
    const MODELS = {
        GEMINI: 'gemini-1.5-flash-latest',
        OPENAI: 'gpt-4o'
    };

    // UI 요소
    const fileInput = $('#fileInput'), compareFileInput = $('#compareFileInput'), previewContainer = $('#previewContainer'), placeholder = $('#placeholder'), analyzeBtn = $('#analyzeBtn'), clearBtn = $('#clearBtn'), saveBtn = $('#saveBtn');
    
    // Works Analysis 요소
    const scriptFileInput = $('#scriptFileInput'), scriptFileName = $('#scriptFileName'), roleNameInput = $('#roleName'), scriptDescTextarea = $('#scriptDesc'), worksDetails = $('#works-details');
    
    // Actor Matching 요소
    const ageSelect = $('#age'), genderSelect = $('#gender'), genreSelect = $('#genre'), jobSelect = $('#job'), characterDescTextarea = $('#character-desc'), matchingDetails = $('#matching-details');
    
    // 오버레이 및 메시지 박스
    const overlay = $('#overlay'), loadingIndicator = $('#loadingIndicator'), messageBox = $('#messageBox'), messageText = $('#messageText'), messageCloseBtn = $('#messageCloseBtn');

    // 결과 섹션
    const resultSection = $('#resultSection'), photoComparisonResultSection = $('#photoComparisonResultSection'), worksAnalysisResultSection = $('#worksAnalysisResultSection'), matchingResultSection = $('#matchingResultSection'), summary = $('#summary'), actorFocusSection = $('#actorFocusSection'), feelsCard = $('#feelsCard'), hairCard = $('#hairCard'), skinCard = $('#skinCard'), makeupCard = $('#makeupCard'), dosCard = $('#dosCard');

    let imageBase64 = null;
    let comparisonImages = [];
    let scriptText = '';

    // --- 메시지 박스 관련 함수 ---
    function showMessage(msg, duration = 0) {
        overlay.classList.remove('hidden');loadingIndicator.classList.add('hidden');messageBox.classList.remove('hidden');messageText.textContent = msg;
        if (duration > 0) {
            setTimeout(() => { messageCloseBtn.click(); }, duration);
        }
    }
    messageCloseBtn.addEventListener('click', () => {overlay.classList.add('hidden');messageBox.classList.add('hidden');});

    // --- UI 이벤트 리스너 ---
    clearBtn.addEventListener('click', () => {location.reload(true);});
    
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      clearComparison();
      try {
        const dataUrl = await resizeAndProcessImage(file);
        imageBase64 = dataUrl.split(',')[1];
        updatePreview([dataUrl]);
      } catch (err) {console.error("File processing error:", err); showMessage("파일을 처리하는 중 오류가 발생했습니다.");}
    });

    compareFileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files).slice(0, 4); if (files.length === 0) return;
      clearSingle();
      overlay.classList.remove('hidden'); loadingIndicator.classList.remove('hidden');
      try {
        const promises = files.map(file => resizeAndProcessImage(file));
        const dataUrls = await Promise.all(promises);
        comparisonImages = dataUrls
            .filter(url => typeof url === 'string')
            .map(url => ({ url, b64: url.split(',')[1] }));
        updatePreview(dataUrls.filter(url => typeof url === 'string'));
        if (e.target.files.length > 4) {
            showMessage('최대 4장의 사진만 비교할 수 있습니다.');
        }
      } catch (err) { console.error("File processing error:", err); showMessage("파일 여러 장을 처리하는 중 오류가 발생했습니다.");}
      finally { overlay.classList.add('hidden'); }
    });

    analyzeBtn.addEventListener('click', async () => {
        if (!imageBase64 && comparisonImages.length === 0) { showMessage('이미지를 먼저 선택하세요.'); return; }
        analyzeBtn.disabled = true; overlay.classList.remove('hidden'); loadingIndicator.classList.remove('hidden'); messageBox.classList.add('hidden');
        
        let worksInfo = { script: scriptText, role: roleNameInput.value.trim(), description: scriptDescTextarea.value.trim() };
        let matchingInfo = { age: ageSelect.value, gender: genderSelect.value, genre: genreSelect.value, job: jobSelect.value, description: characterDescTextarea.value.trim() };
        const images = comparisonImages.length > 0 ? comparisonImages.map(img => img.b64) : [imageBase64];
        
        const isMatchingInfoEmpty = !matchingInfo.age && !matchingInfo.gender && !matchingInfo.genre && !matchingInfo.job && !matchingInfo.description;
        const isWorksInfoPresent = worksInfo.role || worksInfo.description || worksInfo.script;

        if (isMatchingInfoEmpty && isWorksInfoPresent) {
            let characterDescriptionFromWorks = worksInfo.role;
            if (worksInfo.description) {
                characterDescriptionFromWorks += `, ${worksInfo.description}`;
            }
            matchingInfo.description = characterDescriptionFromWorks;
        }

        try {
            // 1. Gemini API 우선 호출
            const geminiData = await callGeminiAPI(images, API_KEYS.GEMINI, MODELS.GEMINI, worksInfo, matchingInfo);
            const parsed = extractJSON(geminiData, 'gemini');
            renderResult(parsed);
        } catch (geminiErr) {
            // 2. Gemini 사용량 초과 또는 서버 과부하 시 OpenAI로 자동 전환
            if ((geminiErr.message.includes('429') || geminiErr.message.includes('RESOURCE_EXHAUSTED') || geminiErr.message.includes('503')) && API_KEYS.OPENAI && API_KEYS.OPENAI.startsWith('sk-')) {
                console.warn('Gemini quota exceeded or unavailable. Falling back to OpenAI.');
                showMessage('Gemini 사용량 초과 또는 서버 과부하. OpenAI로 자동 전환합니다...', 2000);
                
                loadingIndicator.classList.remove('hidden');
                messageBox.classList.add('hidden');

                try {
                    const openAIData = await callOpenAIAPI(images, API_KEYS.OPENAI, MODELS.OPENAI, worksInfo, matchingInfo);
                    const parsed = extractJSON(openAIData, 'openai');
                    renderResult(parsed);
                } catch (openAiErr) {
                    console.error('OpenAI fallback failed:', openAiErr);
                    showMessage(`OpenAI 분석도 실패했습니다: ${openAiErr.message}`);
                }
            } else {
                // 3. 그 외 다른 오류 처리
                console.error(geminiErr);
                showMessage(`분석 중 오류가 발생했습니다: ${geminiErr.message}`);
            }
        } finally {
            overlay.classList.add('hidden');
            analyzeBtn.disabled = false;
        }
    });

    saveBtn.addEventListener('click', () => {
      if (!resultSection.classList.contains('hidden')) {
        showMessage('리포트 이미지를 생성중입니다...');
        // 캡처 전 모든 details 태그를 강제로 엽니다.
        worksDetails.open = true;
        matchingDetails.open = true;
        
        setTimeout(() => {
            html2canvas($('main.container'), {backgroundColor: getComputedStyle(document.body).backgroundColor, scale: window.devicePixelRatio * 2, useCORS: true, onclone: (doc) => {const clonedOverlay = doc.getElementById('overlay'); if(clonedOverlay) clonedOverlay.style.display = 'none';}})
            .then(canvas => {
                const link = document.createElement('a');
                link.download = `AcTi-Report-${new Date().toISOString().slice(0,10)}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();
                messageCloseBtn.click();
            }).catch(err => {console.error('Image save failed:', err); showMessage('이미지 저장에 실패했습니다.');});
        }, 100);
      } else {showMessage('저장할 분석 결과가 없습니다.');}
    });
    
    // --- Works Analysis ---
    scriptFileInput.addEventListener('change', async (e) => {
        const file = e.target.files?.[0]; if (!file) return;
        scriptFileName.textContent = file.name;
        overlay.classList.remove('hidden'); loadingIndicator.classList.remove('hidden');
        try {
            if (file.type === 'application/pdf') { scriptText = await parsePdf(file); } 
            else if (file.name.endsWith('.srt')) { scriptText = await parseSrt(file); } 
            else { scriptText = await file.text(); }
        } catch (err) { console.error('File parse error', err); showMessage('대본 파일 분석에 실패했습니다.');}
        finally { overlay.classList.add('hidden');}
    });

    // --- 프롬프트 및 API 호출 ---
    function buildUniversalPrompt(imageCount, worksInfo, matchingInfo) {
      let promptText = `당신은 상업 광고·캐스팅 디렉터 경험이 풍부한 배우 전문 이미지 컨설턴트입니다.
- 최우선 목표: 사진 속 인물이 배우로서 성공적인 커리어를 쌓을 수 있도록, 실질적이고 전문적인 조언을 제공합니다.
- 출력 형식: 반드시 JSON 객체만 반환합니다. 다른 텍스트나 설명은 절대 포함하지 마세요.\n`;
      
      const hasWorksInfo = worksInfo.script || worksInfo.role || worksInfo.description;
      const hasMatchingInfo = matchingInfo.age || matchingInfo.gender || matchingInfo.genre || matchingInfo.job || matchingInfo.description;
      const isComparison = imageCount > 1;

      if (isComparison) { promptText += `- 최우선 지시사항: ${imageCount}장의 사진이 제공되었습니다. 당신의 가장 중요하고 첫번째 임무는 이 사진들을 비교하여 배우의 프로필로 가장 적합한 'BEST' 사진 1장을 선택하고, 그 이유를 JSON 결과의 'photoComparison' 항목에 상세히 기술하는 것입니다. 이 항목은 절대 생략할 수 없습니다. 나머지 사진들에 대한 피드백도 간략히 포함해야 합니다. 이후 모든 상세 분석은 당신이 선택한 'BEST' 사진을 기준으로 진행합니다.\n`;}
      if(hasWorksInfo) { promptText += `- 작품 분석 지시: '작품 정보'를 분석하여 캐릭터 특징을 'worksAnalysis' 항목에 요약하세요.\n`;}
      if (hasMatchingInfo) { promptText += `- 매칭 분석 지시: '작품 정보'와 '매칭 정보'를 종합하여 캐릭터를 이해한 후, (BEST 사진 속) 이미지가 이 캐릭터와 얼마나 부합하는지 '매칭률'과 '분석 코멘트', '매칭 조언'으로 잠재력을 평가하세요.\n`;}
      
      if(hasWorksInfo) { promptText += `\n[작품 정보]\n- 대본: ${worksInfo.script ? worksInfo.script.substring(0, 1000) + '...' : '제공 안됨'}\n- 배역: ${worksInfo.role || '지정 안됨'}\n- 설명: ${worksInfo.description || '지정 안됨'}\n`; }
      if (hasMatchingInfo) { promptText += `\n[매칭 대상 배역 정보]\n- 연령대: ${matchingInfo.age||'지정 안됨'}\n- 성별: ${matchingInfo.gender||'지정 안됨'}\n- 장르: ${matchingInfo.genre||'지정 안됨'}\n- 직업: ${matchingInfo.job||'지정 안됨'}\n- 캐릭터 설명: ${matchingInfo.description||'지정 안됨'}\n`; }
      
      promptText += `\n- 분석 순서 및 JSON 구조:\n{
  ${isComparison ? `"photoComparison": { "bestPhotoIndex": 0, "reason": "BEST 사진 선택 이유.", "otherPhotosFeedback": [{"index": 1, "feedback": "간략한 코멘트."}] },` : ''}
  ${hasWorksInfo ? `"worksAnalysis": { "characterSummary": "AI가 분석한 캐릭터 요약." },` : ''}
  ${hasMatchingInfo ? `"actorMatching": { "percentage": 0, "comment": "적합도 분석 코멘트.", "advice": "실질적인 조언." },` : ''}
  "summary": "종합 요약.",
  "actorFocus": {
    "characterAnalysis": { "types": ["배역 타입 1", "타입 2"], "reason": "얼굴 특징과 배역 연결 분석." },
    "photoGuide": { "lighting": "추천 조명.", "concept": "의상/배경 컨셉.", "posing": "추천 포즈." },
    "lookBook": { "title": "맞춤형 룩북 컨셉 제안", "concepts": [ { "lookTitle": "컨셉 1", "concept": "설명.", "styling": "제안.", "hairMakeup": "제안.", "locationVibe": "제안." } ] },
    "staffChecklist": { "forMakeup": "메이크업팀 요청사항.", "forHair": "헤어팀 요청사항." }
  },
  "mood": { "keywords": ["키워드 1"], "why": "선정 이유" },
  "hair": { "state": "상태", "issues": ["이슈"], "recommendations": ["추천"] }, "skin": { "state": "상태", "issues": ["이슈"], "recommendations": ["추천"] }, "makeup": { "state": "상태", "issues": ["이슈"], "recommendations": ["추천"] }, "dos": ["추천 사항"], "donts": ["주의사항"]
}`;
      return promptText;
    }

    // --- API 호출 함수들 ---
    async function callGeminiAPI(imagesB64, apiKey, model, worksInfo, matchingInfo) {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        const parts = [{ text: buildUniversalPrompt(imagesB64.length, worksInfo, matchingInfo) }];
        imagesB64.forEach(b64 => { parts.push({ inlineData: { mimeType: 'image/jpeg', data: b64 } }); });
        const body = { contents: [{ parts }]};
        const r = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const responseData = await r.json();
        if (!r.ok) { const errorDetails = responseData.error?.message || JSON.stringify(responseData); throw new Error(`Gemini API 요청 실패 (${r.status}): ${errorDetails}`);}
        return responseData;
    }
    
    async function callOpenAIAPI(imagesB64, apiKey, model, worksInfo, matchingInfo) {
        const apiUrl = `https://api.openai.com/v1/chat/completions`;
        const content = [{ type: 'text', text: buildUniversalPrompt(imagesB64.length, worksInfo, matchingInfo) }];
        imagesB64.forEach(b64 => { content.push({ type: 'image_url', image_url: { url: `data:image/jpeg;base64,${b64}` } }); });

        const body = {
            model: model,
            messages: [{ role: 'user', content: content }],
            max_tokens: 4000,
            response_format: { type: 'json_object' }
        };
        const r = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(body) });
        const responseData = await r.json();
        if (!r.ok) { const errorDetails = responseData.error?.message || JSON.stringify(responseData); throw new Error(`OpenAI API 요청 실패 (${r.status}): ${errorDetails}`);}
        return responseData;
    }

    function extractJSON(apiResponse, provider) {
        try {
            let text;
            if (provider === 'gemini') {
                if (apiResponse?.candidates?.[0]?.finishReason === 'SAFETY') {
                    throw new Error("Gemini가 안전상의 이유로 분석을 중단했습니다.");
                }
                text = apiResponse?.candidates?.[0]?.content?.parts?.[0]?.text;
            } else { // openai
                const choice = apiResponse?.choices?.[0];
                if (choice?.message?.refusal) {
                    throw new Error(`OpenAI가 요청을 거부했습니다: ${choice.message.refusal}`);
                }
                text = choice?.message?.content;
            }

            if (text) {
                const jsonStart = text.indexOf('{');
                const jsonEnd = text.lastIndexOf('}');
                if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
                    return JSON.parse(text.substring(jsonStart, jsonEnd + 1));
                } else { throw new Error("API 응답에서 유효한 JSON 객체를 찾을 수 없습니다.");}
            }
            if (apiResponse.error) { throw new Error(apiResponse.error.message || "API에서 오류를 반환했습니다.");}
            throw new Error("API 응답에서 유효한 분석 결과를 찾을 수 없습니다.");
        } catch (e) {
            console.error('JSON 파싱 실패. 원본:', apiResponse, e);
            if (e instanceof SyntaxError) { throw new Error("AI 응답 형식이 잘못되었습니다.");}
            throw e; // Re-throw the specific error for better user messages
        }
    }

    // --- 렌더링 함수들 ---
    function renderResult(d){
      resultSection.classList.remove('hidden');
      if (d?.photoComparison) { renderPhotoComparisonResult(d.photoComparison); } else { photoComparisonResultSection.innerHTML = ''; }
      if (d?.worksAnalysis) { renderWorksAnalysisResult(d.worksAnalysis); } else { worksAnalysisResultSection.innerHTML = ''; }
      if (d?.actorMatching) { renderMatchingResult(d.actorMatching); } else { matchingResultSection.innerHTML = ''; }
      summary.innerHTML = `<div class="font-semibold text-[color:var(--ink)]" style="white-space: pre-wrap;">${escapeHTML(d?.summary||'요약 없음')}</div>`;
      renderActorFocus(d?.actorFocus);
      const pills = (arr=[]) => (Array.isArray(arr) ? arr : [arr]).map(k=>`<span class='pill'>${escapeHTML(k)}</span>`).join('');
      feelsCard.innerHTML = sectionHTML('첫인상 · 무드', `
        <div class='space-y-3'>
            <div><div class='sub-label'>키워드</div><div>${pills(d?.mood?.keywords)}</div></div>
            <div><div class='sub-label'>선정 이유</div><div class="text-[color:var(--sub)]">${escapeHTML(d?.mood?.why||'')}</div></div>
        </div>`);
      hairCard.innerHTML  = sectionHTML('헤어스타일', blockSet(d?.hair));
      skinCard.innerHTML  = sectionHTML('피부 상태', blockSet(d?.skin));
      makeupCard.innerHTML= sectionHTML('메이크업', blockSet(d?.makeup));
      dosCard.innerHTML = sectionHTML('제안 / 피해야 할 것', `
        <div class='grid md:grid-cols-2 gap-x-6 gap-y-4'>
            <div><div class='sub-label'>제안(Do)</div><ul class='list-disc list-inside space-y-1 text-[color:var(--sub)]'>${(Array.isArray(d?.dos) ? d.dos : [d?.dos]).map(li=>`<li>${escapeHTML(li)}</li>`).join('')}</ul></div>
            <div><div class='sub-label'>피해야 할 것(Don't)</div><ul class='list-disc list-inside space-y-1 text-[color:var(--sub)]'>${(Array.isArray(d?.donts) ? d.donts : [d?.donts]).map(li=>`<li>${escapeHTML(li)}</li>`).join('')}</ul></div>
        </div>`);
      resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function renderPhotoComparisonResult(compData) {
        const bestIndex = compData.bestPhotoIndex || 0;
        let feedbackHTML = (compData.otherPhotosFeedback || [])
            .map(fb => `<p><strong class="font-semibold text-[color:var(--sub)]">사진 ${fb.index + 1}:</strong> ${escapeHTML(fb.feedback)}</p>`)
            .join('');

        // 미리보기에서 BEST 사진에 태그 추가
        const previewItems = previewContainer.querySelectorAll('.preview-item');
        if (previewItems[bestIndex]) {
            previewItems.forEach(item => item.classList.remove('is-best'));
            previewItems[bestIndex].classList.add('is-best');
        }

        photoComparisonResultSection.innerHTML = `
            <div class="pro-card mb-4">
                <div class="pro-card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>
                    <span>사진 비교 결과</span>
                </div>
                <div class="result-card-body space-y-4">
                    <div>
                        <div class="sub-label">BEST 사진</div>
                        <p>AcTi가 <strong class="text-[color:var(--ink)]">사진 ${bestIndex + 1}</strong>을(를) BEST로 선택했습니다.</p>
                        <p class="mt-1">${escapeHTML(compData.reason)}</p>
                    </div>
                     ${feedbackHTML ? `<div><div class="sub-label">기타 사진 피드백</div><div class="space-y-1">${feedbackHTML}</div></div>` : ''}
                </div>
            </div>`;
    }
    
    function renderWorksAnalysisResult(worksData) {
        if(!worksData?.characterSummary) return;
        worksAnalysisResultSection.innerHTML = `
            <div class="pro-card mb-4">
                <div class="pro-card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h4"/><path d="M18 22V4a2 2 0 0 0-2-2h-4"/><path d="M10 2v2"/><path d="m15 13-3-3-3 3"/><path d="m12 10 0 10"/></svg>
                    <span>작품 분석 결과</span>
                </div>
                <div class="result-card-body">
                    <div class="sub-label">AcTi가 분석한 캐릭터</div>
                    <p>${escapeHTML(worksData.characterSummary)}</p>
                </div>
            </div>
        `;
    }
    
    function renderMatchingResult(matchingData) {
        const percentage = matchingData.percentage || 0;
        matchingResultSection.innerHTML = `
            <div class="pro-card mb-4"><div class="pro-card-title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg><span>Actor Matching 결과</span></div><div class="result-card-body space-y-4"><div class="flex items-center gap-4"><div class="flex-1"><div class="progress-bar-bg h-4 w-full"><div id="progressBar" class="progress-bar" style="width: 0%;"></div></div></div><div class="text-2xl font-bold text-[color:var(--ink)]">${percentage}% 일치</div></div><div><div class="sub-label">분석 코멘트</div><p>${escapeHTML(matchingData.comment)}</p></div><div><div class="sub-label">매칭 조언</div><p>${escapeHTML(matchingData.advice)}</p></div></div></div>`;
        setTimeout(() => {$('#progressBar').style.width = `${percentage}%`;}, 100);
    }

    function renderActorFocus(focusData) {
        if (!focusData) { actorFocusSection.innerHTML = ''; return; }
        const char = focusData.characterAnalysis; const photo = focusData.photoGuide; const lookBook = focusData.lookBook; const staff = focusData.staffChecklist;
        const lookBookHTML = lookBook?.concepts?.map(concept => `<div class="lookbook-card mt-4"><h4 class="font-bold text-lg text-[color:var(--ink)]">${escapeHTML(concept.lookTitle)}</h4><div class="mt-2 space-y-2 text-sm"><p><strong class="font-semibold text-[color:var(--sub)]">컨셉:</strong> ${escapeHTML(concept.concept)}</p><p><strong class="font-semibold text-[color:var(--sub)]">스타일링:</strong> ${escapeHTML(concept.styling)}</p><p><strong class="font-semibold text-[color:var(--sub)]">헤어/메이크업:</strong> ${escapeHTML(concept.hairMakeup)}</p><p><strong class="font-semibold text-[color:var(--sub)]">장소/분위기:</strong> ${escapeHTML(concept.locationVibe)}</p></div></div>`).join('') || '';
        actorFocusSection.innerHTML = `<div class="pro-card"><div class="pro-card-title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 19a6 6 0 0 0-12 0v2h12v-2Z"/><circle cx="8" cy="12" r="3"/><path d="M12 12a3 3 0 1 0 6 0 3 3 0 1 0-6 0Z"/><path d="M18 19v2h6v-2a6 6 0 0 0-6-6 6 6 0 0 0-1.5.2"/></svg><span>추천 배역 / 캐릭터</span></div><div class="result-card-body space-y-2"><p class="font-semibold text-[color:var(--ink)]">${(Array.isArray(char?.types) ? char.types : [char?.types]).map(escapeHTML).join(', ')}</p><p>${escapeHTML(char?.reason)}</p></div></div><div class="pro-card"><div class="pro-card-title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg><span>프로필 촬영 가이드</span></div><div class="result-card-body space-y-3"><div><div class="sub-label">조명</div><p>${escapeHTML(photo?.lighting)}</p></div><div><div class="sub-label">의상/컨셉</div><p>${escapeHTML(photo?.concept)}</p></div><div><div class="sub-label">포즈/표정</div><p>${escapeHTML(photo?.posing)}</p></div></div></div><div class="pro-card"><div class="pro-card-title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg><span>${escapeHTML(lookBook?.title)}</span></div><div class="result-card-body space-y-4">${lookBookHTML}</div></div><div class="pro-card"><div class="flex items-center justify-between mb-4"><div class="pro-card-title !mb-0"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="m9 14 2 2 4-4"></path></svg><span>스태프 소통용 체크리스트</span></div></div><div class="result-card-body space-y-3"><div><div class="sub-label">For Makeup Artist</div><p>${escapeHTML(staff?.forMakeup)}</p></div><div><div class="sub-label">For Hair Stylist</div><p>${escapeHTML(staff?.forHair)}</p></div></div></div>`;
    }

    function sectionHTML(title, inner){ return `<div class='result-card-title'>${title}</div><div class='result-card-body'>${inner}</div>`; }
    function blockSet(sec){
      const toArray = (item) => Array.isArray(item) ? item : (item ? [item] : []);
      const issuesHTML = toArray(sec?.issues).map(x => `<li>${escapeHTML(x)}</li>`).join('');
      const recommendationsHTML = toArray(sec?.recommendations).map(x => `<li>${escapeHTML(x)}</li>`).join('');
      return `<div class='space-y-3'><div><div class='sub-label'>상태</div><div class="text-[color:var(--sub)]">${escapeHTML(sec?.state||'')}</div></div><div><div class='sub-label'>이슈</div><ul class='list-disc list-inside space-y-1 text-[color:var(--sub)]'>${issuesHTML}</ul></div><div><div class="sub-label">추천</div><ul class='list-disc list-inside space-y-1 text-[color:var(--sub)]'>${recommendationsHTML}</ul></div></div>`;
    }
    
    // --- 유틸리티 함수 ---
    function updatePreview(dataUrls) {
        placeholder.style.display = 'none';
        previewContainer.innerHTML = '';
        dataUrls.forEach(url => {
            const item = document.createElement('div');
            item.className = 'preview-item';
            const img = document.createElement('img');
            img.src = url;
            item.appendChild(img);
            previewContainer.appendChild(item);
        });
    }

    function clearComparison() { compareFileInput.value = ''; comparisonImages = []; }
    function clearSingle() { fileInput.value = ''; imageBase64 = null; }
    
    function resizeAndProcessImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                if (!event.target.result) return reject(new Error("File could not be read."));
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 1024;
                    const MAX_HEIGHT = 1024;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    } else {
                        if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.9));
                };
                img.onerror = reject;
                img.src = event.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function toBase64(file, keepPrefix = false){
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                if (reader.result && typeof reader.result === 'string') {
                    if (keepPrefix) {
                        resolve(reader.result);
                    } else {
                        resolve(reader.result.split(',')[1]);
                    }
                } else {
                    reject(new Error('Failed to read file data.'));
                }
            };
            reader.onerror = error => reject(error);
        });
    }
    
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
    
    // --- 파일 파서 ---
    async function parsePdf(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let textContent = '';
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            textContent += content.items.map(item => item.str).join(' ');
        }
        return textContent;
    }
    async function parseSrt(file) {
        const text = await file.text();
        const parser = new SrtParser2();
        const srtArray = parser.fromSrt(text);
        return srtArray.map(line => line.text).join('\n');
    }
    
  </script>
</body>
</html>

