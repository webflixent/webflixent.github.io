<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>For Baek's Health (100세 순애건강)</title>
  
  <!-- Icons and Manifest -->
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://placehold.co/64x64/8a7a69/FFFFFF?text=BH" type="image/png">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- 기본 & 배경 스타일 --- */
    html {
        scroll-behavior: smooth;
    }
    body {
      font-family: 'Noto Sans KR', sans-serif;
      color: #4a3f33; /* Deep brown for text */
      background-image: url('https://images.unsplash.com/photo-1505935428862-770b6f24f629?q=80&w=2067&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    /* --- Glassmorphism 카드 스타일 --- */
    .content-card, .modal-card {
      background: rgba(255, 255, 255, 0.65); /* Semi-transparent white */
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px); /* For Safari */
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
    }
    /* --- 버튼 & 입력창 스타일 --- */
    .btn-primary {
      background: linear-gradient(135deg, #574a3a, #8a7a69);
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px 0 rgba(0, 0, 0, 0.1);
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.15);
    }
     .btn-accent {
      background: linear-gradient(135deg, #6d5e4f, #9c8a7a);
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px 0 rgba(0, 0, 0, 0.1);
    }
     .btn-accent:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.15);
    }
    .btn-secondary {
      background-color: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.7);
      color: #4a3f33;
      transition: background-color 0.3s ease;
    }
    .btn-secondary:hover {
      background-color: rgba(255, 255, 255, 0.8);
    }
    .btn-primary:disabled, .btn-accent:disabled {
        background: #a9a29a;
        cursor: not-allowed;
    }
    .input-field, .textarea-field {
      background-color: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.9);
      color: #4a3f33;
      border-radius: 0.75rem;
      padding: 0.75rem;
      transition: all 0.3s ease;
    }
    .input-field:focus, .textarea-field:focus {
      outline: none;
      box-shadow: 0 0 0 2px #8a7a69;
      background-color: rgba(255, 255, 255, 0.9);
    }
    .textarea-field::placeholder {
        text-align: center;
        color: #6e6052;
        font-weight: 400;
        opacity: 0.9;
        font-size: 0.95rem; /* 글자 크기 약간 줄임 */
        line-height: 1.5; /* 줄 간격 조정 */
    }
    .divider-or {
        display: flex;
        align-items: center;
        text-align: center;
        color: #6e6052;
        margin: 1.25rem 0;
    }
    .divider-or::before, .divider-or::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid rgba(110, 96, 82, 0.3);
    }
    .divider-or:not(:empty)::before { margin-right: .5em; }
    .divider-or:not(:empty)::after { margin-left: .5em; }

    /* --- 로더 스타일 --- */
    .loader {
      border: 5px solid #f0e9e2;
      border-top: 5px solid #8a7a69;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* --- 유틸리티 --- */
    .hidden { display: none; }
    .recommendation-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-weight: 700;
      font-size: 0.875rem;
      text-align: center;
    }
    .recommendation-good { background-color: #2f855a; color: white; } /* 좋음 */
    .recommendation-caution { background-color: #d69e2e; color: white; } /* 주의 */
    .recommendation-bad { background-color: #c53030; color: white; } /* 나쁨 */
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md mx-auto">
    <header class="mb-6">
      <div class="content-card rounded-2xl p-6 text-center">
        <div class="flex items-center justify-center">
          <img src="https://placehold.co/64x64/8a7a69/FFFFFF?text=BH" alt="Health Icon" class="h-16 w-16 mr-4 rounded-full shadow-md">
          <h1 class="text-4xl font-bold text-[#4a3f33]">For Baek's Health</h1>
        </div>
        <p class="text-[#6e6052] mt-2 text-lg font-light">백순애 100살 건강 프로젝트</p>
      </div>
    </header>

    <main class="content-card rounded-2xl p-6 space-y-5">
      <!-- 입력 섹션 -->
      <div>
        <label for="food-text" class="block text-sm font-medium text-[#6e6052] mb-1">음식 이름 또는 재료</label>
        <div class="flex items-center gap-2">
            <input type="text" id="food-text" class="input-field w-full" placeholder="예: 닭가슴살, 브로콜리">
            <button id="refresh-button-icon" class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center hover:bg-black/5 transition" title="강제 새로고침">
                <svg class="w-5 h-5 text-[#6e6052]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.695v-2.695A8.25 8.25 0 004.668 7.158l-3.181 3.183" />
                </svg>
            </button>
            <button id="clear-button-icon" class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center hover:bg-black/5 transition" title="화면 지우기">
                <svg class="w-5 h-5 text-[#6e6052]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <label for="food-image-input" class="btn-secondary w-full cursor-pointer text-center font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-2" title="갤러리에서 사진 선택">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
            <span>사진 업로드</span>
        </label>
        <input type="file" id="food-image-input" accept="image/*" class="hidden" multiple>
        <button id="start-camera-button" class="btn-secondary w-full font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-2" title="카메라로 직접 촬영">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h1.172a2 2 0 011.414.586l.828.828A2 2 0 008.828 6H12a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /><path d="M15 8a1 1 0 11-2 0 1 1 0 012 0z" /></svg>
            <span>카메라 촬영</span>
        </button>
      </div>
      <div id="image-preview-container" class="mt-4 flex flex-wrap gap-3 justify-center"></div>

      <div class="divider-or"><span>건강 Q&A</span></div>

      <div>
        <textarea id="qna-text" class="textarea-field w-full h-24 resize-none"></textarea>
      </div>

      <div class="space-y-3 pt-4 border-t border-gray-300/70">
        <div class="grid grid-cols-2 gap-4">
            <button id="recommend-diet-button" class="btn-secondary w-full font-medium py-2 px-4 rounded-xl flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                <span>추천 식단</span>
            </button>
             <button id="view-log-button" class="btn-secondary w-full font-medium py-2 px-4 rounded-xl flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" /></svg>
                <span>식단 기록</span>
            </button>
        </div>
        <div class="flex gap-2">
            <button id="analyze-button" class="btn-primary w-full font-bold py-3 px-4 rounded-xl text-lg flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <span>건강 답변하기</span>
            </button>
            <button id="recipe-button" class="btn-accent flex-shrink-0 font-bold py-3 px-4 rounded-xl text-lg flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h8a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.737 11l-.546 9h7.618l-.546-9M12 11V9m0 0a2 2 0 100-4 2 2 0 000 4z" /></svg>
                <span>요리추천</span>
            </button>
        </div>
      </div>

      <!-- 로딩 및 결과 섹션 -->
      <div id="loading-indicator" class="text-center my-6 hidden">
        <div class="loader mx-auto"></div>
        <p class="mt-4 text-[#6e6052]">건강박사가 분석중입니다...</p>
      </div>
      <div id="result-section" class="mt-6 hidden">
          <!-- Q&A 결과 -->
          <div id="result-qna-section" class="hidden p-4 rounded-lg bg-white/50 space-y-4">
              <h2 class="text-xl font-bold text-[#4a3f33] border-b border-gray-400/50 pb-2">건강 답변</h2>
              <div id="result-qna-answer" class="text-[#4a3f33] whitespace-pre-wrap space-y-3"></div>
          </div>
          <!-- 식단 분석 결과 -->
          <div id="result-food-section" class="hidden space-y-4 p-4 rounded-lg bg-white/50">
            <div>
              <h3 class="font-semibold text-lg text-[#6e6052]">종합 의견</h3>
              <div id="result-opinion" class="text-[#4a3f33] whitespace-pre-wrap space-y-3"></div>
            </div>
            <div>
              <h3 class="font-semibold text-lg text-[#6e6052]">예상 칼로리</h3>
              <p id="result-calories" class="text-[#4a3f33]"></p>
            </div>
            <div>
              <h3 class="font-semibold text-lg text-[#6e6052]">추천</h3>
              <p id="result-recommendation" class="text-[#4a3f33]"></p>
            </div>
          </div>
          <!-- 건강요리 추천 결과 -->
          <div id="result-recipe-section" class="hidden space-y-4 p-4 rounded-lg bg-white/50">
            <h2 id="recipe-name" class="text-2xl font-bold text-[#4a3f33]"></h2>
            <div id="recipe-details" class="space-y-4"></div>
          </div>
          <!-- 결과 액션 버튼 -->
            <div id="result-actions-container" class="hidden mt-4 pt-4 border-t border-gray-400/50 space-y-2">
                <button id="save-log-button" class="btn-primary w-full font-bold py-2 px-4 rounded-xl hidden">이 결과 기록하기</button>
                <button id="save-image-button" class="btn-secondary w-full font-bold py-2 px-4 rounded-xl flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    <span>JPG로 저장</span>
                </button>
            </div>
      </div>
      <div id="error-section" class="mt-6 hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl" role="alert">
        <strong class="font-bold">오류: </strong>
        <span id="error-message" class="block sm:inline"></span>
      </div>
    </main>
    
    <footer class="mt-6">
        <div class="content-card rounded-2xl p-4 text-center text-xs text-[#6e6052]">
            <p>본 결과는 AI에 의해 생성된 정보이며, 의학적 진단을 대체할 수 없습니다.</p>
            <p>정확한 건강 정보는 전문의와 상담하세요.</p>
        </div>
    </footer>
  </div>

  <!-- '맨 위로' 버튼 -->
  <button id="top-button" class="hidden fixed bottom-5 right-5 z-50 btn-primary w-12 h-12 rounded-full flex items-center justify-center shadow-lg">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
  </button>

  <!-- Modals -->
    <div id="camera-view" class="fixed inset-0 bg-black/90 hidden flex-col items-center justify-center p-4 z-50">
        <video id="camera-stream" class="w-full max-w-md h-auto rounded-lg" autoplay playsinline></video>
        <div class="flex items-center space-x-4 mt-4">
            <button id="capture-button" class="btn-primary py-3 px-6 rounded-full text-lg">사진 추가</button>
            <button id="cancel-camera-button" class="text-gray-300 hover:text-white bg-white/20 py-2 px-4 rounded-full">닫기</button>
        </div>
    </div>
    <div id="diet-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
        <div class="modal-card rounded-2xl p-6 w-full max-w-md relative max-h-[90vh] overflow-y-auto">
             <button id="close-diet-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            <h2 class="text-2xl font-bold text-[#4a3f33] mb-4 border-b border-gray-400/50 pb-2">오늘의 추천 식단</h2>
            <div id="diet-loading" class="text-center hidden py-8">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-[#6e6052]">당신을 위한 요리가이드를 추천중입니다</p>
            </div>
            <div id="diet-content" class="space-y-4 text-[#4a3f33]"></div>
        </div>
    </div>
    <div id="log-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
        <div class="modal-card rounded-2xl p-6 w-full max-w-md relative max-h-[90vh] flex flex-col">
             <button id="close-log-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            <h2 class="text-2xl font-bold text-[#4a3f33] mb-4 border-b border-gray-400/50 pb-2">나의 식단 기록</h2>
            <div id="log-list" class="flex-grow overflow-y-auto space-y-3 pr-2"></div>
             <button id="clear-log-button" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition">전체 기록 삭제</button>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
        <div class="modal-card rounded-2xl p-6 w-full max-w-sm">
            <h2 id="confirm-title" class="text-xl font-bold text-[#4a3f33] mb-4"></h2>
            <p id="confirm-message" class="text-[#6e6052] mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel-button" class="btn-secondary py-2 px-4 rounded-xl">취소</button>
                <button id="confirm-ok-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl">확인</button>
            </div>
        </div>
    </div>
  
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const foodTextInput = document.getElementById('food-text');
    const foodImageInput = document.getElementById('food-image-input');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const qnaTextInput = document.getElementById('qna-text');
    const analyzeButton = document.getElementById('analyze-button');
    const recipeButton = document.getElementById('recipe-button');
    const loadingIndicator = document.getElementById('loading-indicator');
    const resultSection = document.getElementById('result-section');
    const resultQnaSection = document.getElementById('result-qna-section');
    const resultQnaAnswer = document.getElementById('result-qna-answer');
    const resultFoodSection = document.getElementById('result-food-section');
    const resultOpinion = document.getElementById('result-opinion');
    const resultCalories = document.getElementById('result-calories');
    const resultRecommendation = document.getElementById('result-recommendation');
    const saveLogButton = document.getElementById('save-log-button');
    const resultRecipeSection = document.getElementById('result-recipe-section');
    const recipeName = document.getElementById('recipe-name');
    const recipeDetails = document.getElementById('recipe-details');
    const errorSection = document.getElementById('error-section');
    const errorMessage = document.getElementById('error-message');
    const startCameraButton = document.getElementById('start-camera-button');
    const recommendDietButton = document.getElementById('recommend-diet-button');
    const viewLogButton = document.getElementById('view-log-button');
    const clearButton = document.getElementById('clear-button-icon');
    const refreshButton = document.getElementById('refresh-button-icon');
    const topButton = document.getElementById('top-button');
    const resultActionsContainer = document.getElementById('result-actions-container');
    const saveImageButton = document.getElementById('save-image-button');
    
    // Modals and their controls
    const cameraView = document.getElementById('camera-view');
    const cameraStream = document.getElementById('camera-stream');
    const captureButton = document.getElementById('capture-button');
    const cancelCameraButton = document.getElementById('cancel-camera-button');
    const dietModal = document.getElementById('diet-modal');
    const closeDietModal = document.getElementById('close-diet-modal');
    const dietLoading = document.getElementById('diet-loading');
    const dietContent = document.getElementById('diet-content');
    const logModal = document.getElementById('log-modal');
    const closeLogModal = document.getElementById('close-log-modal');
    const logList = document.getElementById('log-list');
    const clearLogButton = document.getElementById('clear-log-button');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmCancelButton = document.getElementById('confirm-cancel-button');
    const confirmOkButton = document.getElementById('confirm-ok-button');
    
    let confirmCallback = null;
    let stream = null;
    let uploadedImages = [];
    let currentAnalysisResult = null;
    let currentResultElement = null;

    function show(el, displayMode = 'flex') { if(el) { el.classList.remove('hidden'); el.style.display = displayMode; } }
    function hide(el) { if(el) { el.classList.add('hidden'); el.style.display = 'none'; } }
    
    function setRandomGreeting() {
        const greetings = [
            "오늘도 건강한 하루 보내세요! 당신의 도전을 응원합니다.",
            "작은 습관이 100세 건강을 만듭니다. 오늘도 화이팅!",
            "건강을 향한 당신의 모든 발걸음이 빛나고 있어요.",
            "최고의 컨디션으로 빛나는 하루 되세요!",
            "당신의 건강한 미래, 바로 오늘부터 시작됩니다!",
            "세상에서 가장 소중한 당신, 오늘도 건강하게 지내세요."
        ];
        const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
        qnaTextInput.placeholder = `백순애님!\n${randomGreeting}`;
    }
    setRandomGreeting();


    function setButtonsState(isLoading) {
        analyzeButton.disabled = isLoading;
        recipeButton.disabled = isLoading;
        const spinIcon = analyzeButton.querySelector('svg');
        if (isLoading) {
            spinIcon.classList.add('animate-spin');
        } else {
            spinIcon.classList.remove('animate-spin');
        }
    }

    function handleFiles(files) {
        if (files && files.length > 0) {
             qnaTextInput.value = '';
             foodTextInput.value = '';
        }
        for (const file of files) {
            if (!file.type.startsWith('image/')) continue;
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result.split(',')[1];
                const mimeType = e.target.result.match(/:(.*?);/)[1];
                uploadedImages.push({ data: base64, mime: mimeType });
                renderImagePreviews();
            };
            reader.readAsDataURL(file);
        }
    }

    function renderImagePreviews() {
        imagePreviewContainer.innerHTML = '';
        uploadedImages.forEach((item, index) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'relative w-20 h-20';
            const img = document.createElement('img');
            img.src = `data:${item.mime};base64,${item.data}`;
            img.className = 'w-full h-full object-cover rounded-md shadow-md';
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold leading-none';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                uploadedImages.splice(index, 1);
                renderImagePreviews();
            };
            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            imagePreviewContainer.appendChild(wrapper);
        });
    }

    qnaTextInput.addEventListener('input', () => {
      if (qnaTextInput.value) {
        foodTextInput.value = '';
        uploadedImages = [];
        renderImagePreviews();
      }
    });
    foodTextInput.addEventListener('input', () => {
      if (foodTextInput.value) {
        qnaTextInput.value = '';
        uploadedImages = [];
        renderImagePreviews();
      }
    });
    foodImageInput.addEventListener('change', (event) => {
        handleFiles(event.target.files);
    });

    analyzeButton.addEventListener('click', async () => {
      const foodText = foodTextInput.value.trim();
      const qnaText = qnaTextInput.value.trim();
      if (!foodText && uploadedImages.length === 0 && !qnaText) {
        displayError("음식, 사진, 또는 질문을 입력해주세요.");
        return;
      }
      hide(resultSection); hide(errorSection); show(loadingIndicator, 'block');
      setButtonsState(true);
      try {
        let systemPrompt, parts, analysisType;
        let foodName = foodText;
        if (qnaText) {
          analysisType = 'qna';
          systemPrompt = `당신은 개인 맞춤형 건강 관리를 돕는 헬스케어 AI입니다. 사용자의 건강 상태를 고려하여, 질문에 대해 안전하고 이해하기 쉽게 답변해주세요. 답변은 긍정적이고 희망적인 어조를 유지해주세요.
          응답은 반드시 다음 키를 가진 JSON 형식이어야 합니다:
          - "answer": 다음 3개의 키를 가진 객체:
              - "conclusion": (문자열) 질문에 대한 핵심적인 결론을 2~3줄로 요약.
              - "details": (문자열) 결론에 대한 상세한 이유나 설명을 제공.
              - "tip": (문자열) 사용자가 실생활에서 실천할 수 있는 구체적인 팁이나 주의사항을 제안.
          절대로 답변에 '**'와 같은 마크다운 문자를 사용하지 마세요.`;
          parts = [{ text: qnaText }];
        } else {
          analysisType = 'food';
          systemPrompt = `당신은 식단 관리를 돕는 전문 영양사 AI입니다. 사용자의 건강 상태를 고려하여, 제공된 음식에 대해 매우 신중하고 안전한 관점에서 분석해주세요. 응답은 긍정적이고 이해하기 쉬운 표현을 사용해주세요.
          응답은 반드시 다음 키를 가진 JSON 형식이어야 합니다:
          - "opinion": 다음 4개의 키를 가진 객체:
              - "summary": (문자열) 음식에 대한 핵심적인 평가를 2~3줄로 요약.
              - "pros": (문자열 또는 null) 건강에 긍정적인 측면이 있다면 간략히 서술, 없다면 null.
              - "cons": (문자열) 건강 관점에서 주의할 점이나 개선 방향을 부드럽게 서술.
              - "tip": (문자열 또는 null) 이 음식이 '주의' 또는 '나쁨' 등급일 경우, 더 건강하게 섭취할 수 있는 현실적인 방법(예: '기름기가 많은 껍질 대신 살코기 위주로 드시면 좋습니다')을 제안. '좋음' 등급이면 null.
          - "calories": (문자열) 예상 칼로리.
          - "recommendation": (문자열) "좋음", "주의", "나쁨" 중 하나.
          - "recommendationSummary": (문자열) 'recommendation' 등급에 대한 이유를 1~3줄로 간결하게 요약해서 설명.
          절대로 답변에 '**'와 같은 마크다운 문자를 사용하지 마세요.`;
          if (uploadedImages.length > 0) {
            parts = [{ text: "이 음식들이 건강에 어떤 영향을 주는지 종합적으로 분석해주세요." }];
            uploadedImages.forEach(item => parts.push({ inline_data: { mime_type: item.mime, data: item.data } }));
            foodName = `사진 ${uploadedImages.length}장 종합 분석`;
          } else {
            parts = [{ text: `음식: ${foodText}. 이 음식이 건강에 어떤 영향을 주는지 분석해주세요.` }];
          }
        }
        const data = await callGeminiAPI(systemPrompt, parts);
        if (analysisType === 'food') {
          currentAnalysisResult = { ...data, food: foodName, date: new Date().toISOString() };
        }
        displayResult(data, analysisType);
      } catch (error) {
        console.error("분석 오류:", error);
        displayError(error.message || "분석 중 오류가 발생했습니다.");
      } finally {
        hide(loadingIndicator);
        setButtonsState(false);
      }
    });
    
    recipeButton.addEventListener('click', async () => {
        const foodText = foodTextInput.value.trim();
        if (!foodText && uploadedImages.length === 0) {
            displayError("레시피를 추천받으려면 재료 이름이나 사진을 먼저 입력해주세요.");
            return;
        }
        hide(resultSection); hide(errorSection); show(loadingIndicator, 'block');
        setButtonsState(true);
        try {
            const systemPrompt = `당신은 건강 요리 전문 셰프 AI입니다. 사용자의 건강 상태를 고려하여, 제공된 재료로 만들 수 있는 소화가 잘 되고 건강한 요리법을 추천해주세요. 긍정적이고 따라하기 쉬운 설명을 부탁드립니다.
            응답은 반드시 다음 키를 가진 JSON 형식이어야 합니다:
            - "recipeName": (문자열) 요리 이름.
            - "chefTip": (문자열) 요리를 더 건강하고 맛있게 만들기 위한 셰프의 팁.
            - "ingredients": (문자열 배열) 필요한 재료 목록.
            - "instructions": (문자열 배열) 만드는 법을 단계별로 설명.
            절대로 답변에 '**'와 같은 마크다운 문자를 사용하지 마세요.`;
            let parts;
            if (uploadedImages.length > 0) {
                parts = [{ text: "이 사진 속 재료들로 만들 수 있는 건강 요리 레시피를 알려주세요." }];
                uploadedImages.forEach(item => parts.push({ inline_data: { mime_type: item.mime, data: item.data } }));
            } else {
                parts = [{ text: `이 재료들로 만들 수 있는 건강 요리 레시피를 알려주세요: ${foodText}` }];
            }
            const data = await callGeminiAPI(systemPrompt, parts);
            displayResult(data, 'recipe');
        } catch (error) {
            console.error("레시피 생성 오류:", error);
            displayError(error.message || "레시피 생성 중 오류가 발생했습니다.");
        } finally {
            hide(loadingIndicator);
            setButtonsState(false);
        }
    });

    function displayResult(data, type) {
        hide(resultQnaSection);
        hide(resultFoodSection);
        hide(resultRecipeSection);
        hide(resultActionsContainer);
        hide(saveLogButton);

        if (type === 'qna') {
            currentResultElement = resultQnaSection;
            show(resultQnaSection, 'block');
            resultQnaAnswer.innerHTML = '';
            const answerData = data.answer;

            if (answerData && answerData.conclusion) {
                const conclusionSection = document.createElement('div');
                conclusionSection.innerHTML = `<h4 class="font-bold text-lg text-[#574a3a] mb-1">✅ 핵심 결론</h4><p class="whitespace-pre-wrap">${answerData.conclusion}</p>`;
                resultQnaAnswer.appendChild(conclusionSection);
            }
            if (answerData && answerData.details) {
                const detailsSection = document.createElement('div');
                detailsSection.className = 'mt-4';
                detailsSection.innerHTML = `<h4 class="font-bold text-lg text-gray-700 mb-1">🔬 상세 설명</h4><p class="whitespace-pre-wrap">${answerData.details}</p>`;
                resultQnaAnswer.appendChild(detailsSection);
            }
            if (answerData && answerData.tip) {
                const tipSection = document.createElement('div');
                tipSection.className = 'mt-4 p-3 rounded-lg bg-blue-100/70 border border-blue-300';
                tipSection.innerHTML = `<h4 class="font-bold text-lg text-blue-900 mb-1">💡 실천 팁</h4><p class="text-blue-900 whitespace-pre-wrap">${answerData.tip}</p>`;
                resultQnaAnswer.appendChild(tipSection);
            }

        } else if (type === 'food') {
            currentResultElement = resultFoodSection;
            show(resultFoodSection, 'block');
            show(saveLogButton, 'block');
            resultOpinion.innerHTML = ''; 

            const opinionData = data.opinion;

            if(opinionData && opinionData.summary) {
                const summarySection = document.createElement('div');
                summarySection.innerHTML = `<h4 class="font-bold text-lg text-[#574a3a] mb-1">✅ 핵심 요약</h4><p class="whitespace-pre-wrap">${opinionData.summary}</p>`;
                resultOpinion.appendChild(summarySection);
            }

            const prosConsContainer = document.createElement('div');
            prosConsContainer.className = 'mt-4 grid gap-4';
            let prosConsHTML = '';
            if (opinionData && opinionData.pros) {
                prosConsHTML += `<div><h4 class="font-bold text-lg text-green-700 mb-1">👍 긍정적 측면</h4><p class="whitespace-pre-wrap">${opinionData.pros}</p></div>`;
            }
            if (opinionData && opinionData.cons) {
                prosConsHTML += `<div><h4 class="font-bold text-lg text-red-700 mb-1">🚨 부정적 측면</h4><p class="whitespace-pre-wrap">${opinionData.cons}</p></div>`;
            }
            if(prosConsHTML) {
                prosConsContainer.innerHTML = prosConsHTML;
                resultOpinion.appendChild(prosConsContainer);
            }
            
            if (opinionData && opinionData.tip) {
                const tipSection = document.createElement('div');
                tipSection.className = 'mt-4 p-3 rounded-lg bg-yellow-100/70 border border-yellow-400';
                tipSection.innerHTML = `<h4 class="font-bold text-lg text-yellow-900 mb-1">💡 대처법 가이드</h4><p class="text-yellow-900 whitespace-pre-wrap">${opinionData.tip}</p>`;
                resultOpinion.appendChild(tipSection);
            }

            resultCalories.textContent = data.calories || "정보 없음";
            
            const resultRecommendationEl = document.getElementById('result-recommendation');
            const recommendationContainer = resultRecommendationEl.parentElement;
            recommendationContainer.innerHTML = ''; // Clear previous content

            // Create header div
            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex items-center gap-2 mb-1';

            // Create h3
            const headerText = document.createElement('h3');
            headerText.className = 'font-semibold text-lg text-[#6e6052]';
            headerText.textContent = '추천';

            // Create badge
            const recommendation = data.recommendation || "정보 없음";
            const badge = document.createElement('span');
            badge.textContent = recommendation;
            badge.className = 'recommendation-badge';
            if (recommendation === '좋음') badge.classList.add('recommendation-good');
            else if (recommendation === '주의') badge.classList.add('recommendation-caution');
            else if (recommendation === '나쁨') badge.classList.add('recommendation-bad');
            
            headerDiv.appendChild(headerText);
            headerDiv.appendChild(badge);
            
            // Create summary paragraph
            const summaryP = document.createElement('p');
            summaryP.className = 'text-[#4a3f33]';
            summaryP.textContent = data.recommendationSummary || '';

            recommendationContainer.appendChild(headerDiv);
            recommendationContainer.appendChild(summaryP);
            
            saveLogButton.textContent = "이 결과 기록하기";
            saveLogButton.disabled = false;
            saveLogButton.className = 'btn-primary w-full font-bold py-2 px-4 rounded-xl';

        } else if (type === 'recipe') {
            currentResultElement = resultRecipeSection;
            show(resultRecipeSection, 'block');
            recipeName.textContent = data.recipeName || "이름 없는 레시피";
            recipeDetails.innerHTML = '';

            if (data.chefTip) {
                const tipSection = document.createElement('div');
                tipSection.className = 'mb-4 p-3 rounded-lg bg-blue-100/70 border border-blue-300';
                tipSection.innerHTML = `<h4 class="font-bold text-lg text-blue-900 mb-1">👨‍🍳 셰프의 팁</h4><p class="text-blue-900 whitespace-pre-wrap">${data.chefTip}</p>`;
                recipeDetails.appendChild(tipSection);
            }

            const ingredientsSection = document.createElement('div');
            let ingredientsHTML = `<h3 class="font-semibold text-lg text-[#6e6052]">재료</h3><ul class="list-disc list-inside text-[#4a3f33]">`;
            (data.ingredients || []).forEach(ing => {
                ingredientsHTML += `<li>${ing}</li>`;
            });
            ingredientsHTML += `</ul>`;
            ingredientsSection.innerHTML = ingredientsHTML;
            recipeDetails.appendChild(ingredientsSection);

            const instructionsSection = document.createElement('div');
            instructionsSection.className = 'mt-4';
            let instructionsHTML = `<h3 class="font-semibold text-lg text-[#6e6052]">만드는 법</h3><ol class="list-decimal list-inside text-[#4a3f33] space-y-1">`;
            (data.instructions || []).forEach(step => {
                instructionsHTML += `<li>${step}</li>`;
            });
            instructionsHTML += `</ol>`;
            instructionsSection.innerHTML = instructionsHTML;
            recipeDetails.appendChild(instructionsSection);
        }
      show(resultSection, 'block');
      show(resultActionsContainer, 'block');
    }

    async function callGeminiAPI(systemPrompt, parts) {
      const apiKey = "AIzaSyBJEtwmOTMo1yB3VtfGre72AOIxZKpi8SU"; 
      if (apiKey === "YOUR_API_KEY_HERE" || apiKey === "") {
        throw new Error("API 키가 설정되지 않았습니다. callGeminiAPI 함수 안에 있는 apiKey 변수를 확인해주세요.");
      }
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      
      const maxRetries = 3;
      let delay = 1000; // 1초부터 시작

      for (let i = 0; i < maxRetries; i++) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000); // 각 시도마다 20초 타임아웃

        try {
          const payload = { contents: [{ parts }], systemInstruction: { parts: [{ text: systemPrompt }] }, generationConfig: { responseMimeType: "application/json" } };
          const res = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal });
          
          clearTimeout(timeoutId);

          if (res.ok) {
            const result = await res.json();
            if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
              return JSON.parse(result.candidates[0].content.parts[0].text);
            }
            throw new Error("AI 응답 구조가 예상과 다릅니다.");
          }

          if (res.status === 503) {
            if (i === maxRetries - 1) {
                const t = await res.text();
                throw new Error(`API 요청 실패 (재시도 모두 실패): ${res.status} - ${t}`);
            }
            console.log(`API Overloaded (503). Retrying in ${delay / 1000} seconds...`);
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2; // 지수 백오프
          } else {
            const t = await res.text();
            throw new Error(`API 요청 실패: ${res.status} - ${t}`);
          }
        } catch (error) {
          clearTimeout(timeoutId);
          if (i === maxRetries - 1) {
            throw error;
          }
           console.log(`Fetch error. Retrying in ${delay / 1000} seconds... Error: ${error.message}`);
           await new Promise(resolve => setTimeout(resolve, delay));
           delay *= 2;
        }
      }
      throw new Error("API 요청에 실패했습니다. (모든 재시도 실패)");
    }
    
    function clearInputs() {
        foodTextInput.value = "";
        qnaTextInput.value = "";
        foodImageInput.value = ""; 
        uploadedImages = [];
        renderImagePreviews();
    }
    function resetApp() {
        clearInputs();
        currentAnalysisResult = null;
        hide(resultSection);
        hide(errorSection);
        hide(loadingIndicator);
        setRandomGreeting(); // 초기화 시에도 새로운 응원 메시지 설정
    }
    clearButton.addEventListener('click', resetApp);

    refreshButton.addEventListener('click', () => {
        // URL에 현재 시간을 추가하여 캐시를 무시하고 강제로 새로고침합니다.
        const currentUrl = window.location.href.split('?')[0];
        window.location.href = currentUrl + '?cache_bust=' + new Date().getTime();
    });

    function displayError(msg) { errorMessage.textContent = msg; show(errorSection, 'block'); }
    
    startCameraButton.addEventListener('click', async () => {
        if (location.protocol !== 'https:') { displayError("카메라는 HTTPS에서만 동작합니다."); return; }
        if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) { displayError("이 브라우저에서는 카메라를 지원하지 않습니다."); return; }
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          show(cameraView, 'flex'); cameraStream.srcObject = stream;
        } catch (e) { console.error(e); displayError("카메라 접근이 거부되었거나 사용할 수 없습니다."); }
    });
    captureButton.addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = cameraStream.videoWidth || 1280;
        canvas.height = cameraStream.videoHeight || 720;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(cameraStream, 0, 0, canvas.width, canvas.height);
        const dataURL = canvas.toDataURL('image/jpeg', 0.85);
        const parsed = dataURL.match(/^data:(.*?);base64,(.*)$/);
        if (parsed) {
            handleFiles([]); 
            uploadedImages.push({ data: parsed[2], mime: parsed[1] }); 
            renderImagePreviews();
        }
        stopCamera();
    });
    cancelCameraButton.addEventListener('click', () => stopCamera());
    function stopCamera() { if (stream) stream.getTracks().forEach(t => t.stop()); hide(cameraView); stream = null; }
    
    saveImageButton.addEventListener('click', () => {
        if (!currentResultElement) return;

        saveImageButton.textContent = '저장 중...';
        saveImageButton.disabled = true;

        html2canvas(currentResultElement, {
            useCORS: true,
            backgroundColor: '#fdfaf6'
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'health_result.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
            saveImageButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg><span>JPG로 저장</span>`;
            saveImageButton.disabled = false;
        }).catch(err => {
            console.error("이미지 저장 오류:", err);
            displayError("이미지 저장에 실패했습니다.");
            saveImageButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg><span>JPG로 저장</span>`;
            saveImageButton.disabled = false;
        });
    });

    // --- Diet & Log Modal Logic ---
    recommendDietButton.addEventListener('click', async () => {
        show(dietModal, 'flex');
        show(dietLoading, 'block');
        dietContent.innerHTML = '';
        try {
            const systemPrompt = `당신은 균형 잡힌 식단을 추천하는 전문 영양사 AI입니다. 사용자의 건강 상태를 고려하여, 소화가 편하고 건강한 하루 추천 식단을 생성해주세요. 식단은 저지방, 저자극, 소화가 잘되는 것을 기본으로 합니다. 답변은 'breakfast', 'lunch', 'dinner', 'snacks' 키를 가진 JSON 객체여야 합니다. 절대로 답변에 '**'와 같은 마크다운 문자를 사용하지 마세요.`;
            const parts = [{ text: "건강에 좋은 하루 추천 식단을 생성해주세요." }];
            const data = await callGeminiAPI(systemPrompt, parts);
            dietContent.innerHTML = `
                <div class="mb-3"><h3 class="font-semibold text-lg">아침</h3><p>${data.breakfast || '정보 없음'}</p></div>
                <div class="mb-3"><h3 class="font-semibold text-lg">점심</h3><p>${data.lunch || '정보 없음'}</p></div>
                <div class="mb-3"><h3 class="font-semibold text-lg">저녁</h3><p>${data.dinner || '정보 없음'}</p></div>
                <div><h3 class="font-semibold text-lg">간식</h3><p>${data.snacks || '정보 없음'}</p></div>
            `;
        } catch(error) {
            dietContent.innerHTML = `<p class="text-red-500">식단 정보를 불러오는 데 실패했습니다.</p>`;
        } finally {
            hide(dietLoading);
        }
    });

    function displayLogs() {
        const logs = JSON.parse(localStorage.getItem('foodLog')) || [];
        logList.innerHTML = '';
        if (logs.length === 0) {
            logList.innerHTML = `<p class="text-center text-gray-500">기록된 식단이 없습니다.</p>`;
            hide(clearLogButton);
            return;
        }
        show(clearLogButton, 'block');
        logs.forEach(log => {
            const logDate = new Date(log.date);
            const dateString = `${logDate.getFullYear()}.${logDate.getMonth() + 1}.${logDate.getDate()} ${logDate.getHours()}:${String(logDate.getMinutes()).padStart(2, '0')}`;
            const badge = `<span class="recommendation-badge ${log.recommendation === '좋음' ? 'recommendation-good' : log.recommendation === '주의' ? 'recommendation-caution' : 'recommendation-bad'}">${log.recommendation}</span>`;
            const logItem = document.createElement('div');
            logItem.className = 'bg-white/50 p-3 rounded-lg';
            logItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <p class="font-bold">${log.food}</p>
                    ${badge}
                </div>
                <p class="text-xs text-gray-600 mt-1">${dateString}</p>
            `;
            logList.appendChild(logItem);
        });
    }

    viewLogButton.addEventListener('click', () => {
        displayLogs();
        show(logModal, 'flex');
    });

    saveLogButton.addEventListener('click', () => {
        if (currentAnalysisResult) {
            const logs = JSON.parse(localStorage.getItem('foodLog')) || [];
            logs.unshift(currentAnalysisResult);
            localStorage.setItem('foodLog', JSON.stringify(logs));
            saveLogButton.textContent = "저장 완료!";
            saveLogButton.disabled = true;
            saveLogButton.classList.add('opacity-50');
        }
    });

    clearLogButton.addEventListener('click', () => {
        showConfirm("모든 기록 삭제", "정말로 모든 기록을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.", () => {
            localStorage.removeItem('foodLog');
            displayLogs();
        });
    });

    closeDietModal.addEventListener('click', () => hide(dietModal));
    closeLogModal.addEventListener('click', () => hide(logModal));
    
    function showConfirm(title, message, callback) {
        confirmTitle.textContent = title; confirmMessage.textContent = message; confirmCallback = callback; show(confirmModal, 'flex');
    }
    confirmCancelButton.addEventListener('click', () => { hide(confirmModal); confirmCallback = null; });
    confirmOkButton.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hide(confirmModal); confirmCallback = null; });
    
    // --- Top Button Logic ---
    window.addEventListener('scroll', () => {
        if (window.scrollY > 200) {
            topButton.classList.remove('hidden');
        } else {
            topButton.classList.add('hidden');
        }
    });

    topButton.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

  });
  </script>
</body>
</html>





