<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AcTi 이미지 컨설팅</title>
  <meta name="color-scheme" content="light" />
  
  <!-- 홈 화면 전체화면 실행 (주소창 숨기기) -->
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- 홈 화면 아이콘 및 파비콘 설정 -->
  <link rel="apple-touch-icon" sizes="180x180" href="webimage.png">
  <link rel="icon" type="image/png" sizes="32x32" href="webimage.png">
  <link rel="icon" type="image/png" sizes="16x16" href="webimage.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#ECE9E4;          /* 배경(스톤 베이지) */
      --paper:#F7F4F1;       /* 카드 상단 라이트 */
      --card:#FFFFFF;        /* 카드 본색 */
      --ink:#3A352F;         /* 본문 컬러 */
      --sub:#827A72;         /* 보조 텍스트 */
      --accent:#7B5E49;      /* 포커스(브론즈) */
      --accent-2:#5E4738;    /* 포커스 딥 */
      --ring:#CDB9A9;        /* 포커스 링 */
      --line:#E7E1DB;        /* 섹션 경계선 */
      --shadow-1: 0 14px 40px rgba(73,56,43,.16), 0 2px 10px rgba(73,56,43,.08);
      --inner: inset 0 1px 0 rgba(255,255,255,.8), inset 0 -1px 0 rgba(0,0,0,.04);
    }
    html, body { height: 100%; }
    body{ font-family:'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; color:var(--ink); background:
      radial-gradient(1200px 800px at 10% -10%, #ffffff 0%, rgba(255,255,255,.6) 45%, rgba(255,255,255,0) 60%),
      radial-gradient(800px 600px at 90% 0%, #fff 0%, rgba(255,255,255,.5) 40%, rgba(255,255,255,0) 60%),
      linear-gradient(180deg, var(--bg), #E6DFD9 60%, #EAE5E0 100%);
      background-attachment: fixed; }

    /* 카드 & 컨테이너 */
    .container{ max-width: 920px; margin: 0 auto; padding: 24px; }
    .hero{ border-radius: 28px; background: linear-gradient(180deg, var(--paper), var(--card)); box-shadow: var(--shadow-1); padding: 24px; display:flex; align-items:center; gap:16px; border:1px solid var(--line); position:relative; overflow:hidden; }
    .hero::after{ content:""; position:absolute; inset:0; background: radial-gradient(600px 220px at -10% -20%, rgba(255,255,255,.7), transparent 60%); pointer-events:none; }
    .avatar{ 
        width:64px; 
        height:64px; 
        border-radius:50%; 
        object-fit: cover;
        background-color: #cfc7c0; /* 이미지 로딩 전 배경색 */
        box-shadow: 0 4px 10px rgba(60,50,42,.18);
    }

    .panel{ border-radius: 22px; background: linear-gradient(180deg, var(--paper), var(--card)); border:1px solid var(--line); box-shadow: var(--shadow-1); padding: 20px; }
    #feelsCard, #hairCard, #skinCard, #makeupCard, #dosCard, .pro-card {
        border-radius: 22px; background: linear-gradient(180deg, var(--paper), var(--card)); border:1px solid var(--line); box-shadow: var(--shadow-1); padding: 20px;
    }
    .section-title{ font-weight:600; font-size: 1.05rem; }
    .label{ color:var(--sub); font-size:.85rem; }

    /* 버튼 */
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.75rem 1.05rem; border-radius:14px; border:1px solid rgba(0,0,0,.04); box-shadow: var(--inner), 0 6px 18px rgba(73,56,43,.12); font-weight:600; transition: all .18s ease; cursor: pointer; }
    .btn:focus{ outline: none; box-shadow: 0 0 0 4px var(--ring), var(--inner), 0 6px 18px rgba(73,56,43,.12); }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn-primary{ background: linear-gradient(180deg, var(--accent), var(--accent-2)); color:#fff; }
    .btn-ghost{ background: linear-gradient(180deg,#F4F0EC,#ECE6E1); color:var(--ink); }

    .btn-icon {
        width: 52px;
        height: 52px;
        padding: 0;
        border-radius: 18px;
    }
    .btn-icon svg {
        width: 24px;
        height: 24px;
    }

    /* 입력 */
    .file-wrap{ display:flex; gap: 1rem; flex-wrap:wrap; }
    .file-input{ display:none; }

    /* 미리보기 */
    .preview{ aspect-ratio: 1/1; width:100%; border-radius: 20px; background: #F0ECE8; border:1px solid var(--line); display:grid; place-items:center; overflow:hidden; }
    .preview img{ max-height: 420px; object-fit: contain; }

    /* 결과 카드 내부 */
    .pill{ display:inline-block; padding:.2rem .55rem; border-radius:999px; background:#EFE8E2; border:1px solid var(--line); font-size:.78rem; margin:.1rem .2rem .1rem 0; }
    
    .result-card-title {
        display: inline-block;
        background: var(--accent);
        color: #fff;
        padding: 6px 14px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }
    .pro-card-title {
        display: flex;
        align-items: center;
        gap: .6rem;
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--accent-2);
        margin-bottom: 1rem;
    }
     .pro-card-title svg {
        width: 22px;
        height: 22px;
        stroke-width: 2.5;
    }
    .result-card-body {
        font-size: 0.95rem;
        color: var(--ink);
    }
    .result-card-body ul {
        padding-left: 4px;
    }
    .sub-label {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--ink);
        margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <main class="container">
    <!-- HERO -->
    <section class="hero">
      <img src="webimage.png" alt="AcTi Logo" class="avatar">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">AcTi 이미지 컨설팅</h1>
        <p class="label mt-1">준비된 엔터, 준비된 배우</p>
      </div>
    </section>

    <!-- 업로드 -->
    <section class="panel mt-5">
      <div class="flex items-center justify-between">
        <h2 class="section-title">사진 업로드</h2>
      </div>
      <div class="grid md:grid-cols-2 gap-5 mt-4 items-start">
        <div>
          <div class="file-wrap">
            <label for="fileInput" class="btn btn-ghost btn-icon" title="사진 불러오기">
              <svg xmlns="http://www.w.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            </label>
            <button id="analyzeBtn" class="btn btn-primary btn-icon" title="분석하기">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 4V2"></path><path d="M15 10V8"></path><path d="M12.5 7H17.5"></path><path d="M12.5 13H17.5"></path><path d="M10 22l-3-3 9-9 3 3-9 9z"></path></svg>
            </button>
            <button id="clearBtn" class="btn btn-ghost btn-icon" title="지우기">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
          </div>
          <input id="fileInput" class="file-input" type="file" accept="image/*"/>
          <p class="label mt-3">※ 초상권/저작권을 침해하지 않는 이미지로 테스트하세요.</p>
        </div>
        <div>
          <div class="preview">
            <img id="previewImage" alt="미리보기" class="hidden"/>
            <div id="placeholder" class="label">이미지를 선택하면 미리보기가 표시됩니다.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- 결과 -->
    <section id="resultSection" class="mt-5 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold tracking-tight">컨설팅 리포트</h2>
        <button id="copyBtn" class="btn btn-ghost">전체 복사</button>
      </div>
      
      <div id="summary" class="mt-4 p-4 text-center rounded-xl border border-[color:var(--line)] bg-[#F5F1ED]"></div>

      <!-- 전문가 활용 섹션 -->
      <div id="actorFocusSection" class="mt-6 space-y-4"></div>

      <!-- 상세 분석 섹션 -->
      <hr class="my-8 border-t-2 border-dashed border-[color:var(--line)]">
      <h3 class="text-xl font-bold tracking-tight mb-4">상세 분석</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <div id="feelsCard"></div>
        <div id="hairCard"></div>
        <div id="skinCard"></div>
        <div id="makeupCard"></div>
      </div>
      <div id="dosCard" class="mt-4"></div>
    </section>

    <!-- 로딩 & 메시지 -->
    <div id="overlay" class="fixed inset-0 hidden bg-black/35 grid place-items-center z-50">
        <div id="loadingIndicator" class="panel w-[320px] text-center">
            <div class="mx-auto mb-3 w-10 h-10 rounded-full border-4 border-[color:var(--accent)] border-t-transparent animate-spin"></div>
            <div class="font-medium">이미지컨설팅 분석중입니다</div>
            <div class="label mt-1">이미지 크기에 따라 수 초가 걸릴 수 있습니다.</div>
        </div>
        <div id="messageBox" class="panel w-[320px] text-center hidden">
             <h3 class="font-medium text-lg mb-2">알림</h3>
             <p id="messageText" class="mb-4"></p>
             <button id="messageCloseBtn" class="btn btn-primary">확인</button>
        </div>
    </div>
  </main>

  <script>
    const $ = (sel) => document.querySelector(sel);

    // --- 설정 ---
    const API_KEY = 'AIzaSyBJEtwmOTMo1yB3VtfGre72AOIxZKpi8SU';
    const MODEL = 'gemini-1.5-flash-latest';

    // UI 요소
    const fileInput = $('#fileInput');
    const previewImage = $('#previewImage');
    const placeholder = $('#placeholder');
    const analyzeBtn = $('#analyzeBtn');
    const clearBtn = $('#clearBtn');
    
    // 오버레이 및 메시지 박스
    const overlay = $('#overlay');
    const loadingIndicator = $('#loadingIndicator');
    const messageBox = $('#messageBox');
    const messageText = $('#messageText');
    const messageCloseBtn = $('#messageCloseBtn');

    // 결과 섹션
    const resultSection = $('#resultSection');
    const summary = $('#summary');
    const actorFocusSection = $('#actorFocusSection');
    const feelsCard = $('#feelsCard');
    const hairCard = $('#hairCard');
    const skinCard = $('#skinCard');
    const makeupCard = $('#makeupCard');
    const dosCard = $('#dosCard');
    const copyBtn = $('#copyBtn');

    let imageBase64 = null;
    
    // --- 메시지 박스 관련 함수 ---
    function showMessage(msg) {
        messageText.textContent = msg;
        loadingIndicator.classList.add('hidden');
        messageBox.classList.remove('hidden');
        overlay.classList.remove('hidden');
    }
    
    messageCloseBtn.addEventListener('click', () => {
        overlay.classList.add('hidden');
        messageBox.classList.add('hidden');
    });

    // --- UI 이벤트 리스너 ---
    clearBtn.addEventListener('click', () => {
      fileInput.value = '';
      imageBase64 = null;
      previewImage.src = '';
      previewImage.classList.add('hidden');
      placeholder.classList.remove('hidden');
      resultSection.classList.add('hidden');
      analyzeBtn.disabled = false;
    });

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      
      try {
        const url = URL.createObjectURL(file);
        previewImage.src = url;
        previewImage.onload = () => URL.revokeObjectURL(url);
        previewImage.classList.remove('hidden');
        placeholder.classList.add('hidden');
        imageBase64 = await toBase64(file);
      } catch (err) {
        console.error("File processing error:", err);
        showMessage("파일을 처리하는 중 오류가 발생했습니다.");
      }
    });

    analyzeBtn.addEventListener('click', async () => {
      if (!imageBase64) {
        showMessage('이미지를 먼저 선택하세요.');
        return;
      }
      
      analyzeBtn.disabled = true;
      messageBox.classList.add('hidden');
      loadingIndicator.classList.remove('hidden');
      overlay.classList.remove('hidden');

      try {
        const data = await callGeminiAPI(imageBase64, API_KEY, MODEL);
        const parsed = extractJSON(data);
        renderResult(parsed);
      } catch (err) {
        console.error(err);
        showMessage(`분석 중 오류가 발생했습니다: ${err.message}`);
      } finally {
        overlay.classList.add('hidden');
        analyzeBtn.disabled = false;
      }
    });

    copyBtn.addEventListener('click', async () => {
      try {
        const txt = buildClipboardText();
        await navigator.clipboard.writeText(txt);
        copyBtn.textContent = '복사됨!';
        setTimeout(() => copyBtn.textContent = '전체 복사', 1200);
      } catch { 
        showMessage('복사에 실패했습니다.'); 
      }
    });

    // --- 프롬프트 및 API 호출 ---
    function buildPrompt() {
      return `당신은 상업 광고·캐스팅 디렉터 경험이 풍부한 배우 전문 이미지 컨설턴트입니다.

- 최우선 목표: 사진 속 인물이 배우로서 성공적인 커리어를 쌓을 수 있도록, 실질적이고 전문적인 조언을 제공합니다.
- 출력 형식: 반드시 JSON 객체만 반환합니다. 다른 텍스트나 설명은 절대 포함하지 마세요.
- 언어: 모든 텍스트는 한국어로 작성합니다.
- 톤앤매너: 전문가적이고 직설적인 실무 톤을 유지하며, 긍정적인 부분과 개선점을 명확히 구분하여 전달합니다.

- 분석 순서 및 JSON 구조:
가장 먼저, 배우를 위한 전문적인 조언을 3가지 파트로 나누어 분석합니다. 그 후에 기존의 상세 분석을 진행합니다.

{
  "summary": "분석 결과에 대한 1~2문장의 종합 요약. 배우의 가장 큰 매력과 잠재력을 강조.",
  "actorFocus": {
    "characterAnalysis": {
      "types": ["가장 어울리는 배역/캐릭터 타입 1", "타입 2"],
      "reason": "해당 캐릭터 타입이 어울리는 이유를 얼굴의 특징, 분위기, 표정과 연결하여 구체적으로 설명."
    },
    "photoGuide": {
      "lighting": "프로필 촬영 시 추천하는 조명 컨셉과 그 이유.",
      "concept": "배우의 매력을 극대화할 수 있는 의상 및 배경 컨셉.",
      "posing": "추천하는 표정이나 포즈, 시선 처리 방법."
    },
    "staffChecklist": {
      "forMakeup": "메이크업 아티스트에게 전달할 핵심 요청사항. (예: '피부 표현: 세미-매트 마무리, T존 유분 조절. 아이: 펄 없는 브라운 계열 음영 강조.')",
      "forHair": "헤어 스타일리스트에게 전달할 핵심 요청사항. (예: '가르마: 6:4 비율 추천. 볼륨: 뿌리 볼륨을 살려 얼굴형 보완.')"
    }
  },
  "mood": { "keywords": ["핵심 키워드 1", "키워드 2"], "why": "해당 키워드를 선택한 이유에 대한 간략한 설명" },
  "hair": { "state": "현재 헤어스타일과 상태에 대한 객관적인 서술", "issues": ["개선이 필요한 점 1", "문제점 2"], "recommendations": ["구체적인 개선 제안 1", "추천 스타일 2"] },
  "skin": { "state": "현재 피부 상태 및 톤에 대한 서술", "issues": ["보완이 필요한 점 1"], "recommendations": ["피부 표현 개선을 위한 제안 1"] },
  "makeup": { "state": "현재 메이크업 상태에 대한 서술", "issues": ["아쉬운 점 1"], "recommendations": ["메이크업 개선을 위한 구체적인 제안 1"] },
  "dos": ["이미지를 더 돋보이게 할 추천 사항 1", "추가 제안 2"],
  "donts": ["피해야 할 스타일이나 색상 1", "주의사항 2"]
}`;
    }

    async function callGeminiAPI(imageBase64, apiKey, model) {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        
        const body = {
          contents: [{
            parts: [
              { text: buildPrompt() },
              {
                inlineData: {
                  mimeType: 'image/jpeg',
                  data: imageBase64,
                },
              },
            ],
          }],
           generationConfig: {
             responseMimeType: "application/json",
           }
        };

        const r = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        const responseData = await r.json();
        if (!r.ok) {
            console.error('Gemini API Error:', responseData);
            const errorDetails = responseData.error?.message || '알 수 없는 오류 발생';
            throw new Error(`Gemini API 요청 실패: ${errorDetails}`);
        }
        return responseData;
    }

    function extractJSON(apiResponse) {
      try {
          const part = apiResponse?.candidates?.[0]?.content?.parts?.[0];
          if (part && part.text) {
              // Find the first '{' and the last '}' to robustly extract the JSON object,
              // ignoring any potential extra text or markdown fences from the model.
              const text = part.text;
              const jsonStart = text.indexOf('{');
              const jsonEnd = text.lastIndexOf('}');

              if (jsonStart !== -1 && jsonEnd !== -1 && jsonEnd > jsonStart) {
                  const jsonString = text.substring(jsonStart, jsonEnd + 1);
                  return JSON.parse(jsonString);
              } else {
                  throw new Error("API 응답에서 유효한 JSON 객체를 찾을 수 없습니다.");
              }
          }
          if (apiResponse?.candidates?.[0]?.finishReason === 'SAFETY') {
              throw new Error("부적절하거나 유해한 이미지로 판단되어 분석을 중단했습니다. 다른 이미지를 사용해주세요.");
          }
          if (apiResponse.error) {
             throw new Error(apiResponse.error.message || "API에서 오류를 반환했습니다.");
          }
          throw new Error("API 응답에서 유효한 분석 결과를 찾을 수 없습니다.");
      } catch (e) {
          console.error('JSON 파싱 또는 응답 처리 실패. 원본 응답:', apiResponse, e);
          if (e instanceof SyntaxError) {
            throw new Error("AI 응답 형식이 잘못되었습니다. 잠시 후 다시 시도해주세요.");
          }
          throw new Error(e.message || "AI 응답을 처리하는 데 실패했습니다. 잠시 후 다시 시도해주세요.");
      }
    }

    // --- 렌더링 함수 ---
    function renderResult(d){
      resultSection.classList.remove('hidden');
      summary.innerHTML = `<div class="font-semibold">${escapeHTML(d.summary || '요약 없음')}</div>`;

      // 전문가 활용 섹션 렌더링
      renderActorFocus(d.actorFocus);

      // 상세 분석 섹션 렌더링
      const pills = (arr=[]) => arr.map(k=>`<span class='pill'>${escapeHTML(k)}</span>`).join('');

      feelsCard.innerHTML = sectionHTML('첫인상 · 무드', `
        <div class='space-y-3'>
            <div>
                <div class='sub-label'>키워드</div>
                <div>${pills(d.mood?.keywords)}</div>
            </div>
            <div>
                <div class='sub-label'>선정 이유</div>
                <div>${escapeHTML(d.mood?.why||'')}</div>
            </div>
        </div>
      `);
      hairCard.innerHTML  = sectionHTML('헤어스타일', blockSet(d.hair));
      skinCard.innerHTML  = sectionHTML('피부 상태', blockSet(d.skin));
      makeupCard.innerHTML= sectionHTML('메이크업', blockSet(d.makeup));

      dosCard.innerHTML = sectionHTML('제안 / 피해야 할 것', `
        <div class='grid md:grid-cols-2 gap-x-6 gap-y-4'>
          <div>
            <div class='sub-label'>제안(Do)</div>
            <ul class='list-disc list-inside space-y-1'>${(d.dos||[]).map(li=>`<li>${escapeHTML(li)}</li>`).join('')}</ul>
          </div>
          <div>
            <div class='sub-label'>피해야 할 것(Don't)</div>
            <ul class='list-disc list-inside space-y-1'>${(d.donts||[]).map(li=>`<li>${escapeHTML(li)}</li>`).join('')}</ul>
          </div>
        </div>`);
        
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function renderActorFocus(focusData) {
        if (!focusData) {
            actorFocusSection.innerHTML = '';
            return;
        }

        const char = focusData.characterAnalysis;
        const photo = focusData.photoGuide;
        const staff = focusData.staffChecklist;

        const checklistText = `[메이크업팀] ${staff?.forMakeup}\n[헤어팀] ${staff?.forHair}`;

        actorFocusSection.innerHTML = `
            <div class="pro-card">
                <div class="pro-card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 19a6 6 0 0 0-12 0v2h12v-2Z"/><circle cx="8" cy="12" r="3"/><path d="M12 12a3 3 0 1 0 6 0 3 3 0 1 0-6 0Z"/><path d="M18 19v2h6v-2a6 6 0 0 0-6-6 6 6 0 0 0-1.5.2"/></svg>
                    <span>추천 배역 / 캐릭터</span>
                </div>
                <div class="result-card-body space-y-2">
                    <p class="font-semibold text-[color:var(--accent-2)]">${(char?.types || []).map(escapeHTML).join(', ')}</p>
                    <p>${escapeHTML(char?.reason)}</p>
                </div>
            </div>
            <div class="pro-card">
                <div class="pro-card-title">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                    <span>프로필 촬영 가이드</span>
                </div>
                <div class="result-card-body space-y-3">
                    <div><div class="sub-label">조명</div><p>${escapeHTML(photo?.lighting)}</p></div>
                    <div><div class="sub-label">의상/컨셉</div><p>${escapeHTML(photo?.concept)}</p></div>
                    <div><div class="sub-label">포즈/표정</div><p>${escapeHTML(photo?.posing)}</p></div>
                </div>
            </div>
            <div class="pro-card">
                 <div class="flex items-center justify-between mb-4">
                    <div class="pro-card-title !mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="m9 14 2 2 4-4"></path></svg>
                        <span>스태프 소통용 체크리스트</span>
                    </div>
                    <button id="checklistCopyBtn" data-text="${escapeHTML(checklistText)}" class="btn btn-ghost !py-2 !px-3 !rounded-lg">체크리스트 복사</button>
                </div>
                <div class="result-card-body space-y-3">
                    <div><div class="sub-label">For Makeup Artist</div><p>${escapeHTML(staff?.forMakeup)}</p></div>
                    <div><div class="sub-label">For Hair Stylist</div><p>${escapeHTML(staff?.forHair)}</p></div>
                </div>
            </div>
        `;
        
        // 새로 생성된 체크리스트 복사 버튼에 이벤트 리스너 추가
        $('#checklistCopyBtn').addEventListener('click', async (e) => {
             try {
                const textToCopy = e.currentTarget.dataset.text;
                await navigator.clipboard.writeText(textToCopy);
                e.currentTarget.textContent = '복사 완료!';
                setTimeout(() => e.currentTarget.textContent = '체크리스트 복사', 1200);
            } catch {
                showMessage('복사에 실패했습니다.');
            }
        });
    }

    function sectionHTML(title, inner){
      return `<div class='result-card-title'>${title}</div><div class='result-card-body'>${inner}</div>`;
    }

    function blockSet(sec){
      return `
        <div class='space-y-3'>
          <div>
            <div class='sub-label'>상태</div>
            <div>${escapeHTML(sec?.state||'')}</div>
          </div>
          <div>
            <div class='sub-label'>이슈</div>
            <ul class='list-disc list-inside space-y-1'>${(sec?.issues||[]).map(x=>`<li>${escapeHTML(x)}</li>`).join('')}</ul>
          </div>
          <div>
            <div class='sub-label'>추천</div>
            <ul class='list-disc list-inside space-y-1'>${(sec?.recommendations||[]).map(x=>`<li>${escapeHTML(x)}</li>`).join('')}</ul>
          </div>
        </div>`;
    }

    // --- 유틸리티 함수 ---
    function buildClipboardText() {
        let text = `[AcTi 이미지 컨설팅 리포트]\n\n`;
        text += `■ 종합 요약\n${summary.innerText}\n\n`;
        text += `■ 전문가 활용 제안\n${actorFocusSection.innerText.replace(/체크리스트 복사|복사 완료!/g, '').trim()}\n\n`;
        text += `────── 상세 분석 ──────\n\n`;
        text += `■ 첫인상 · 무드\n${feelsCard.innerText}\n\n`;
        text += `■ 헤어스타일\n${hairCard.innerText}\n\n`;
        text += `■ 피부 상태\n${skinCard.innerText}\n\n`;
        text += `■ 메이크업\n${makeupCard.innerText}\n\n`;
        text += `■ 제안 / 피해야 할 것\n${dosCard.innerText}`;
        return text;
    }

    function toBase64(file){
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });
    }

    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
  </script>
</body>
</html>


